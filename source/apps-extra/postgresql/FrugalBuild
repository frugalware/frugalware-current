# Compiling Time: 1.07 SBU
# Maintainer: DeX77 <dex77@frugalware.org>
# Contributor: Miklos Vajna <vmiklos@frugalware.org>

USE_TCL=${USE_TCL:-"y"}

pkgname=postgresql
pkgver=16.3
pkgrel=1
pkgdesc="An advanced Object-Relational database management system (DBMS)"
url="http://www.postgresql.org/"
depends=('openssl>=3.1.0' 'readline>=8.0' 'libxml2>=2.9.4-3' 'ncurses>=6.1-2' 'icu4c>=75.1')
makedepends=('libxslt>=1.1.28-3')
rodepends=("libpq>=$pkgver")
groups=('apps-extra')
archs=('x86_64')
_F_archive_grepv="beta\|rc[0-9]"
up2date="Flastverdir https://ftp.postgresql.org/pub/source/ | sed 's/v//'"
source=(https://ftp.postgresql.org/pub/source/v$pkgver/postgresql-$pkgver.tar.bz2 postgresql.service pg_setup)
sha1sums=('35ffeb5cc46dc773dfcd1f270d65a29777994b3a' \
          '41423e125d1f8f5f6c57bcddd5eb5ad326b22561' \
          '30c843fe478fadcd3d8a1d80f7b12a7bccb41efb')

subpkgs=('libpq' "$pkgname-extras" "$pkgname-plperl" "$pkgname-plpython")
subdescs=('PostgreSQL Library.' 'PostgreSQL extra tools' \
	"PostgreSQL perl bindings" "PostgreSQL python bindings")
subdepends=('openssl>=3.1.0' 'openssl>=3.0.7 libxml2>=2.9.4-3'  'perl>=2.26.1' 'python3>=3.12')
subrodepends=('' "libpq>=$pkgver" "$pkgname>=$pkgver" "$pkgname>=$pkgver")
subgroups=('lib' 'apps-extra' 'devel-extra' 'devel-extra')
subarchs=('x86_64' 'x86_64' 'x86_64' 'x86_64')
subreplaces=('' '' "$pkgname-perl" "$pkgname-python")
subprovides=('' '' "$pkgname-perl" "$pkgname-python")
subconflicts=('' '' "$pkgname-perl" "$pkgname-python")

if Fuse $USE_TCL; then
	subpkgs+=("$pkgname-pltcl")
	subdescs+=("PostgreSQL tcl bindings")
	subdepends+=("tcl>=8.6.8")
	subrodepends+=("$pkgname>=$pkgver")
	subgroups+=("devel-extra")
	subarchs+=("x86_64")
	subreplaces+=("$pkgname-tcl")
	subprovides+=("$pkgname-tcl")
	subconflicts+=("$pkgname-tcl")
	Fconfopts+=" --with-tcl"
else
	Fconfopts+=" --without-tcl"
fi

subpkgs+=("${pkgname}-libs-static")
subdescs+=("Static files for $pkgname")
subdepends+=('')
subrodepends+=('')
subgroups+=('devel-extra')
subarchs+=('x86_64')
subreplaces+=('')
subprovides+=('')
subconflicts+=('')

_F_systemd_scriptlet="postgresql.install"
_F_systemd_units=(postgresql=)
Finclude systemd

build()
{

	export PYTHON=python3
	Fpatchall
	Fmake \
		--datadir=/usr/share/pgsql \
		--localstatedir=/var/lib/pgsql \
		--with-openssl \
		--with-perl \
		--with-python \
		--with-libxml \
		--enable-thread-safety \
		--without-ldap \
		--without-pam
	## I cannot add ldap and krb* support while I make pqsql depends itself
	## *-sasl need be split first
	## extra things
	Fexec cd contrib || Fdie
	Fmake
	make DESTDIR=$Fdestdir install || Fdie
	Fexec cd xml2 || Fdie
	Fmake
	Fexec make DESTDIR=$Fdestdir install || Fdie
	Fexec cd ../.. || Fdie
	Fremove_static_libs
	## contrib extra 'tools, libs etc'  package
	Fsplit $pkgname-extras /usr
	## Install main package
	Fexec make DESTDIR=$Fdestdir install || Fdie
	Fexec make -C doc/src/sgml DESTDIR=$Fdestdir install-man || Fdie
	Ffile usr/lib/systemd/system/postgresql.service
	Fexe /usr/bin/pg_setup
	Fgenscriptlet
	Fmkdir /var/lib/pgsql/data /var/log/pgsql
	Fdirschown /var/lib/pgsql 31 31
	Fdirschown /var/log/pgsql 31 31

	Fsplit ${pkgname}-libs-static usr/lib/*.a

	## Library package
	Fsplit libpq usr/lib/libpq.*
	Fsplit libpq usr/include/{libpq-fe,postgres_ext}.h
	Fsplit libpq usr/include/libpq
	## Perl bindings
	Fsplit $pkgname-plperl usr/lib/$pkgname/plperl.so
	## Python bindings
	Fsplit $pkgname-plpython usr/lib/$pkgname/plpython3.so

	if Fuse $USE_TCL; then
		## Tcl bindings
		Fsplit $pkgname-pltcl usr/lib/$pkgname/pltcl.so
	fi
}

# optimization OK
