# Compiling Time: 0.23 SBU
# Maintainer: James Buren <ryuo@frugalware.org>
# Contributor: Miklos Vajna <vmiklos@frugalware.org>

pkgname=rsyslog
pkgver=8.23.0
pkgrel=1
pkgdesc="Enhanced system logging and kernel message trapping daemon"
url="http://www.rsyslog.com/"
backup=(etc/rsyslog.conf)
conflicts=('sysklogd' 'syslog-ng')
provides=('sysklogd')
replaces=('sysklogd')
depends=('gnutls>=3.4.8' 'libestr>=0.1.10-4' 'liblogging>=1.0.5-3' 'libfastjson')
makedepends=('krb5' 'mysql>=5.5.50-2' 'postgresql>=9.5.4' 'docutils')
groups=('apps-extra')
archs=('x86_64')
up2date="Flasttar $url/downloads/download-v8-stable/"
source=($url/files/download/rsyslog/rsyslog-$pkgver.tar.gz \
	rsyslog.conf \
	rsyslog )
sha1sums=('a9c4c60957460e525e27e9212117596d1172f326' \
          '093b836523485daab0d1c01ef5c77e7b246d67e5' \
          'a21d517bb2a39011db7478302172171f91906233')
_F_systemd_units=(rsyslog=e)
Finclude systemd

replaces=('rsyslog-gnutls')
provides=('rsyslog-gnutls')
conflicts=('rsyslog-gnutls')

subpkgs=('rsyslog-gssapi')
subdescs=('GSSAPI authentication and encryption support for rsyslog')
subdepends=('libkrb5>=1.14')
subrodepends=("$pkgname>=$pkgver")
subgroups=('apps-extra')
subarchs=('x86_64')

subpkgs=("${subpkgs[@]}" 'rsyslog-mysql')
subdescs=("${subdescs[@]}" 'MySQL support for rsyslog')
subdepends=("${subdepends[@]}" 'libmysqlclient>=5.5.50-2')
subrodepends=("${subrodepends[@]}" "$pkgname>=$pkgver")
subgroups=("${subgroups[@]}" 'apps-extra')
subarchs=("${subarchs[@]}" 'x86_64')

subpkgs=("${subpkgs[@]}" 'rsyslog-udpspoof')
subdescs=("${subdescs[@]}" 'Provides the omudpspoof module for rsyslog')
subdepends=("${subdepends[@]}" 'libnet>=1.1.6')
subrodepends=("${subrodepends[@]}" "$pkgname=$pkgver")
subgroups=("${subgroups[@]}" 'apps-extra')
subarchs=("${subarchs[@]}" 'x86_64')

subpkgs=("${subpkgs[@]}" 'rsyslog-pgsql')
subdescs=("${subdescs[@]}" 'PostgresSQL support for rsyslog')
subdepends=("${subdepends[@]}" 'libpq>=9.5.4')
subrodepends=("${subrodepends[@]}" "$pkgname>=$pkgver")
subgroups=("${subgroups[@]}" 'apps-extra')
subarchs=("${subarchs[@]}" 'i686 x86_64')

subpkgs=("${subpkgs[@]}" 'rsyslog-snmp')
subdescs=("${subdescs[@]}" 'SNMP protocol support for rsyslog')
subdepends=("${subdepends[@]}" 'net-snmp>=5.7.3-2')
subrodepends=("${subrodepends[@]}" "$pkgname>=$pkgver")
subgroups=("${subgroups[@]}" 'apps-extra')
subarchs=("${subarchs[@]}" 'x86_64')

Fconfopts+="	--disable-static \
                --disable-testbench \
                --enable-gnutls \
                --enable-gssapi-krb5 \
                --enable-imfile \
                --enable-mail \
                --enable-mysql \
                --enable-omprog \
                --enable-omudpspoof \
                --enable-omuxsock \
                --enable-pgsql \
                --enable-snmp \
                --enable-unlimited-select"
build()
{
	Fbuild

	Frm usr/lib/rsyslog/*.la
	Ffile /etc/rsyslog.conf
	Ffile /etc/logrotate.d/rsyslog
	Fln /lib/systemd/system/rsyslog.service /etc/systemd/system/syslog.service

	Fsplit rsyslog-gssapi /usr/lib/rsyslog/{lmgssutil,imgssapi,omgssapi}.so
	Fsplit rsyslog-mysql /usr/lib/rsyslog/ommysql.so
	Fsplit rsyslog-udpspoof /usr/lib/rsyslog/omudpspoof.so
	Fsplit rsyslog-pgsql /usr/lib/rsyslog/ompgsql.so
	Fsplit rsyslog-snmp /usr/lib/rsyslog/omsnmp.so
	Fgenscriptlet
}

# optimization OK
