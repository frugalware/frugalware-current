# Compiling Time: 0.01 SBU
# Maintainer: Miklos Vajna <vmiklos@frugalware.org>

pkgname=speech_tools
pkgver=2.5.0
pkgrel=1
pkgdesc="Speech tools for Festival Text to Speech engine"
url="http://festvox.org/festival/"
pkgurl="http://www.festvox.org/packed/festival/"
depends=('libstdc++' 'ncurses')
makedepends=('cpio')
groups=('apps-extra')
archs=('x86_64')
up2date="Flastarchive ${pkgurl}$(Flastverdir $pkgurl)/ -release.tar.gz"
source=(http://festvox.org/packed/festival/${pkgver%.*}/speech_tools-$pkgver-release.tar.gz \
	speechconfig.patch \
	shared-build.patch )
sha1sums=('8154c956465b2407c4de1700c7ecd0b04b4694ca' \
          '29355c3f64b236e42ba318f8a795d956b3a7ac49' \
          '54229d8c10a79c00aec13200ab11f84233abac70')

build()
{
	Fcd $pkgname
	Fpatchall
	Fsed 'head -1' 'head -n 1' config.guess
	Fsed '-O3' "$CXXFLAGS" base_class/Makefile
	Fconf
	
	Fexec make -j1 OPTIMISE_CXXFLAGS="${CXXFLAGS}" OPTIMISE_CCFLAGS="${CFLAGS}" \
		|| Fdie

	Fmkdir /usr/lib
	Fexerel lib/libestbase.so.${pkgver}.1 /usr/lib
	Fexerel lib/libeststring.so.1.2 /usr/lib
	Fln libestbase.so.${pkgver}.1 /usr/lib/libestbase.so
	Fln libeststring.so.1.2 /usr/lib/libeststring.so
	Ffilerel lib/libestbase.a /usr/lib/
	Ffilerel lib/libestools.a /usr/lib/
	Ffilerel lib/libeststring.a /usr/lib/

	# $old is needed (at me on x86_64) if $old isn't available then
	# Normally $i == $Fdestdir/usr/bin/align (example) but some way
	# $i after first Fsed modified to $i == $Fdestdir/usr/bin/$Fdestdir/usr/bin/$i
	# this is strange.. but $old solve this. Maybe a bug in Fsed macro

	cd bin
	for i in *
	do
		[ $i = "Makefile" ] && continue
		Fexerel /usr/bin/$i
		old=$i

		Fsed "$Fsrcdir/$pkgname/testsuite/data" \
			"/usr/share/speech-tools/testsuite" $Fdestdir/usr/bin/$i
		i=$old

		Fsed "$Fsrcdir/$pkgname/bin" "/usr/libexec/speech-tools" \
			$Fdestdir/usr/bin/$i
		i=$old

		Fsed "$Fsrcdir/$pkgname/main" "/usr/libexec/speech-tools" \
			$Fdestdir/usr/bin/$i
		i=$old

		Fsed "$Fsrcdir/$pkgname/lib" "/usr/lib" $Fdestdir/usr/bin/$i
	done
	cd ..

	cd main
	for i in `find -perm +100 -type f`
	do
		Fexerel /usr/libexec/speech-tools/$i
	done
	cd ..

	Ffilerel lib/siod/* /usr/share/speech-tools/lib/siod

	Fdocrel lib/example_data/*

	find config -print |cpio -pmd $Fdestdir/usr/share/speech-tools \
		|| return 1

	cd include
	find . -print |cpio -pmd $Fdestdir/usr/include/speech-tools \
		|| return 1
	cd ..

	Fln /usr/include/speech-tools /usr/share/speech-tools/include
	chmod 755 $Fdestdir/usr/include/speech-tools

	chown -R root:0 $Fdestdir

	find $Fdestdir/usr/share/speech-tools/config -type f \
		|xargs sed -i 's/-ltermcap/-lncurses/g'

	Fdocrel lib/cstrutt.dtd
}

# optimization OK


