# Compiling Time: 2.46 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=sysdig
pkgver=0.25
pkgrel=3
pkgdesc="Open source system-level exploration and troubleshooting tool"
archs=('x86_64')
groups=('apps-extra')
url="https://www.sysdig.com/"
depends=('jsoncpp' 'luajit2' 'curl' 'jq' 'libb64' 'intel-tbb' 'protobuf' 'grpc')
_F_github_author=draios
_F_github_grepv=agent
_F_github_tag=y
Finclude github cmake kernel-module
source+=("bashcomp-location.patch")
_F_cmake_confopts=" -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
	-DCMAKE_CXX_FLAGS="-Wno-deprecated-declarations" \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DSYSDIG_VERSION=$pkgver \
        -DUSE_BUNDLED_DEPS=OFF \
        -DBUILD_DRIVER=OFF \
        -DBUILD_LIBSCAP_EXAMPLES=OFF"
sha1sums=('b38f6ce57d434d6220dadf3ce52605b10d512330' \
          'e14fe66d3a44ceb191a6932e379b05352ecdfe8e')
makedepends+=('kernel-source')

build(){
	CMake_build

	Fexec cd $Fsrcdir/$_F_cd_path/driver || Fdie
	Fexec cmake -DPROBE_NAME=sysdig-probe .
	Fexec make V=1 KERNELDIR=${_F_kernelmod_dir}/build || Fdie
	Fexec make V=1 KERNELDIR=${_F_kernelmod_dir}/build INSTALL_MOD_DIR=kernel/misc INSTALL_MOD_PATH=${Fdestdir} install || Fdie
	Frm usr/src # we don't need that -ENODKMS
}
