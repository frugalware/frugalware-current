# Compiling Time: 2.46 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=sysdig
pkgver=0.31.4
pkgrel=3
_falcover=0.10.5
pkgdesc="Open source system-level exploration and troubleshooting tool"
archs=('x86_64')
groups=('apps-extra')
url="https://www.sysdig.com/"
depends=('jsoncpp>=1.9.2' 'luajit2' 'jq' 'libb64' 'intel-tbb' 'curl' \
	'protobuf>=21.5' 'grpc>=1.49.2' 'yaml-cpp' 'nlohmann-json' )
makedepends=('re2-static' 'curl-static' 'libssh2-static' 'nghttp2-static')
_F_github_author="draios"
_F_github_grepv="agent\|falco\|rc1"
_F_github_tag=y
_Fbuild_no_patch=y
Finclude github cmake kernel-module
source+=(https://github.com/falcosecurity/libs/archive/$_falcover.tar.gz \
	c++17-sysdig.patch \
	c++17-libs.patch \
	bashcomp-location.patch \
	falcosecurity-libs-nodownload.patch )
_F_cmake_confopts+=" \
	-DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_INSTALL_PREFIX=/usr \
	-DSYSDIG_VERSION=$pkgver \
	-DUSE_BUNDLED_DEPS=OFF \
	-DUSE_BUNDLED_TBB=OFF \
        -DUSE_BUNDLED_B64=OFF \
        -DUSE_BUNDLED_JSONCPP=OFF \
        -DUSE_BUNDLED_RE2=OFF \
        -DUSE_BUNDLED_VALIJSON=ON \
        -DUSE_BUNDLED_NJSON=ON \
	-DBUILD_DRIVER=ON \
	-DCREATE_TEST_TARGETS=OFF \
	-DENABLE_DKMS=OFF \
	-DBUILD_LIBSCAP_EXAMPLES=OFF \
	-DBUILD_LIBSCAP_EXAMPLES=OFF \
	-DDRIVER_SOURCE_DIR=$Fsrcdir/libs-$_falcover/driver \
	-DFALCOSECURITY_LIBS_VERSION=$_falcover \
	-DPROBE_NAME=sysdig-probe"
sha1sums=('4ea945342dd4ef52555c70974f8eb9026d5c4770' \
          'b3432edbb0efea9fe2823eb116febd92d14f86e4' \
          'ca8bbf83e6aee9158db8c201c2f6b1d37ed81f1f' \
          '65a0f952c556174639970d4d4fca0b46d5ae8257' \
          'a5a4ece6dfa83561baa214851b4f19f76aa7a1b2' \
          'bdea81a6c942e36f335fa7b9eebe649e72313a6a')
options+=('nolto')

build(){
	Fexec cd "$Fsrcdir/libs-$_falcover" || Fdie
	Fpatch c++17-libs.patch

	Fexec cd "$Fsrcdir/sysdig-$pkgver" || Fdie

	Fpatch falcosecurity-libs-nodownload.patch
	Fpatch bashcomp-location.patch
	Fpatch c++17-sysdig.patch

	CMake_prepare_build
	CMake_conf
	Fexec cd $_F_cmake_build_dir || Fdie
	Fcd

	Fexec make KERNELDIR=${_F_kernelmod_dir}/build || Fdie
	CMake_install

	Ffilerel driver/scap.ko $_F_kernelmod_dir/kernel/extra/scap.ko
	## now we have some weird stuff
	# drop , not working on FW , nor it is needed
	Frm usr/bin/sysdig-probe-loader
	## broken, we do not use anyway but bpf depends on driver/* files which are not
	## installed when you set DKMS=OFF -.-
	Frm usr/src
	## all is dropped in /bin/ but all is *root* only
	## mv to /sbin/ for now .. Another option would be
	## udev rule with special group for these
	Fmkdir usr/sbin
	Fmv usr/bin/* usr/sbin/
	Frm usr/bin

	Fkernelver_compress_modules
	Fbuild_kernelmod_scriptlet

}

# optimization OK
