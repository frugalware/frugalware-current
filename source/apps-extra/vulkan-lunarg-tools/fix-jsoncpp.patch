From d7a3c5489fe178a0617469b486364228f76cbd4e Mon Sep 17 00:00:00 2001
From: Juan Ramos <juan@lunarg.com>
Date: Mon, 30 Oct 2023 16:11:40 -0600
Subject: [PATCH] Use jsoncpp package config support

closes #1908
---
 CMakeLists.txt          |  2 --
 scripts/known_good.json |  3 +--
 via/CMakeLists.txt      | 14 +++++++++++---
 3 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index a44a0b3706..6c1b46a60c 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -64,8 +64,6 @@ find_package(VulkanUtilityLibraries REQUIRED CONFIG)
 
 find_package(valijson REQUIRED CONFIG)
 
-find_package(jsoncpp REQUIRED CONFIG)
-
 if (CMAKE_SYSTEM_NAME STREQUAL "Windows" OR
     CMAKE_SYSTEM_NAME STREQUAL "Linux" OR
     CMAKE_SYSTEM_NAME MATCHES "BSD")
diff --git a/scripts/known_good.json b/scripts/known_good.json
index 481d9024dc..f900f08d65 100644
--- a/scripts/known_good.json
+++ b/scripts/known_good.json
@@ -80,8 +80,7 @@
                 "-DCMAKE_POSITION_INDEPENDENT_CODE=ON",
                 "-DJSONCPP_WITH_TESTS=OFF",
                 "-DJSONCPP_WITH_POST_BUILD_UNITTEST=OFF",
-                "-DJSONCPP_WITH_WARNING_AS_ERROR=OFF",
-                "-DJSONCPP_WITH_PKGCONFIG_SUPPORT=OFF"
+                "-DJSONCPP_WITH_WARNING_AS_ERROR=OFF"
             ]
         },
         {
diff --git a/via/CMakeLists.txt b/via/CMakeLists.txt
index 8b64845f6f..04a2ba8a42 100644
--- a/via/CMakeLists.txt
+++ b/via/CMakeLists.txt
@@ -19,8 +19,7 @@ else()
         set(COMMON_COMPILE_FLAGS "${COMMON_COMPILE_FLAGS} -fno-strict-aliasing -fno-builtin-memcmp")
         set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${COMMON_COMPILE_FLAGS} -fno-rtti")
     endif()
-    # jsoncpp has intentional fallthrough
-    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${COMMON_COMPILE_FLAGS} -std=c++11 -Wno-implicit-fallthrough")
+    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${COMMON_COMPILE_FLAGS} -std=c++11")
 
     if(APPLE)
         add_definitions(-DVIA_MACOS_TARGET)
@@ -60,9 +59,18 @@ add_executable(vkvia
                   via_system_bsd.cpp)
 endif()
 
+# https://github.com/LunarG/VulkanTools/issues/1908
+find_package(PkgConfig)
+if (PKG_CONFIG_FOUND)
+    pkg_check_modules(jsoncpp REQUIRED IMPORTED_TARGET jsoncpp)
+    target_link_libraries(vkvia PRIVATE PkgConfig::jsoncpp)
+else()
+    find_package(jsoncpp CONFIG)
+    target_link_libraries(vkvia PRIVATE jsoncpp_static)
+endif()
+
 target_link_libraries(vkvia PRIVATE
     Vulkan::Headers
-    jsoncpp_static
     valijson
     ${CMAKE_DL_LIBS}
     $<TARGET_NAME_IF_EXISTS:PkgConfig::XCB>
