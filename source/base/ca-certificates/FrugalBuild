# Compiling Time: 0.05 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=ca-certificates
pkgver=20180409
pkgextraver=""
pkgrel=1
pkgdesc='Common CA certificates'
archs=('x86_64')
groups=('base' 'chroot-core')
depends=('openssl' 'scriptlet-core')
makedepends=('openjre' 'detox')
url='http://packages.qa.debian.org/c/ca-certificates.html'
_F_cd_path="$pkgname"
Fpkgversep="_"
source=("http://http.debian.net/debian/pool/main/c/${pkgname}/${pkgname}_${pkgver}${pkgextraver}.tar.xz" \
	updatekeystore \
	openssl-c_rehash.sh \
	20180914-mozilla-certs.patch \
	revert-openssl-1.1.patch )
up2date="Flasttar http://http.debian.net/debian/pool/main/c/ca-certificates/"
backup=('etc/ca-certificates.conf')
sha1sums=('edf0ec04b02fcbc90cc65906ff83fb042894a3b7' \
          '9d0e1d7d5e83acb0de3107488764417d9c78115e' \
          'bd5fae59161d1a970e2797a99021dc16ed0e11e2' \
          'ec06780a1226e365e0c1773b4da02482802c8085' \
          'e8cf745f3ba901f263f86a5a54568f797cbe7140')
options=('force')

subpkgs=('ca-certificates-java')
subdescs=('Java Keystore of common CA certificates')
subdepends=('')
subgroups=('xapps')
subarchs=('x86_64')
suboptions=('force')

build() {
	Fmkdir usr/share/ca-certificates
	Fmkdir usr/sbin
	Fbuild
        # Fix not printable stuff
        Fexec detox -r $Fdestdir/usr/share/$pkgname

	Fmkdir /etc
	echo "# Automatically generated by ${pkgname}-${pkgver}-${pkgrel}" > $Fdestdir/etc/ca-certificates.conf || Fdie
	echo "#" >> $Fdestdir/etc/ca-certificates.conf || Fdie
	find $Fdestdir/usr/share/$pkgname -name '*.crt' | sed "s|^$Fdestdir/usr/share/$pkgname/||" | sort -u >> $Fdestdir/etc/ca-certificates.conf

	KEYSTORE="$Fdestdir/usr/lib/jvm/java-8-openjdk/jre/lib/security/cacerts"
	Fmkdir usr/lib/jvm/java-8-openjdk/jre/lib/security

	for i in `find $Fdestdir/usr/share/$pkgname ! -type d`
	do
		filename=$(basename "$i")
		aliasname="${filename%.*}"
		/usr/lib/jvm/java-8-openjdk/jre/bin/keytool -import -keystore $KEYSTORE -storepass changeit -noprompt -file $i -alias $aliasname
	done
	unset LANG

		#Finstall 755 updatekeystore /etc/cron.daily/updatekeystore
		#Fsplit ca-certificates-java /etc/cron.daily/updatekeystore
	Fsplit ca-certificates-java /usr/lib/jvm/java-8-openjdk/jre/lib/security/cacerts


	# Install pure bash implementation for c_rehash
	Fexe usr/bin/openssl-c_rehash.sh
}
