# Compiling Time: 0.05 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=ca-certificates
pkgver=20160104
pkgrel=6
pkgdesc='Common CA certificates'
archs=('i686' 'x86_64')
groups=('base' 'chroot-core')
depends=('openssl' 'scriptlet-core')
makedepends=('openjdk')
url='http://packages.qa.debian.org/c/ca-certificates.html'
_F_cd_path="$pkgname"
Fpkgversep="_"
source=("ftp://ftp.debian.org/debian/pool/main/c/${pkgname}/${pkgname}_${pkgver}.tar.xz" \
	updatekeystore \
	openssl-c_rehash.sh )
up2date="Flasttar ftp://ftp.debian.org/debian/pool/main/c/ca-certificates/ .tar.xz"
backup=('etc/ca-certificates.conf')
sha1sums=('4525a194736c6691dbd59fa87281b722837b4768' \
          'd163dbee8ee0c8b1be1e93fe1adf79e231a6db05' \
          'bd5fae59161d1a970e2797a99021dc16ed0e11e2')

subpkgs=('ca-certificates-java')
subdescs=('Java Keystore of common CA certificates')
subdepends=('')
subgroups=('xapps')
subarchs=('i686 x86_64')

build() {
	Fmkdir usr/share/ca-certificates
	Fmkdir usr/sbin
	Fsed 'c_rehash' 'openssl-c_rehash.sh' sbin/update-ca-certificates
	Fbuild
	Fmkdir /etc
	echo "# Automatically generated by ${pkgname}-${pkgver}-${pkgrel}" > $Fdestdir/etc/ca-certificates.conf || Fdie
	echo "#" >> $Fdestdir/etc/ca-certificates.conf || Fdie
	find $Fdestdir/usr/share/$pkgname -name '*.crt' | sed "s|^$Fdestdir/usr/share/$pkgname/||" | sort -u >> $Fdestdir/etc/ca-certificates.conf

	KEYSTORE="$Fdestdir/usr/lib/jvm/java-8-openjdk/jre/lib/security/cacerts"
	Fmkdir usr/lib/jvm/java-8-openjdk/jre/lib/security

	# Needed for UTF8 certificates to work
	export LANG=en_US.utf8
	for i in `find $Fdestdir/usr/share/$pkgname ! -type d`
	do
		filename=$(basename "$i")
		aliasname="${filename%.*}"
		/usr/lib/jvm/java-8-openjdk/jre/bin/keytool -import -keystore $KEYSTORE -storepass changeit -noprompt -file $i -alias $aliasname
	done
	unset LANG

		#Finstall 755 updatekeystore /etc/cron.daily/updatekeystore
		#Fsplit ca-certificates-java /etc/cron.daily/updatekeystore
	Fsplit ca-certificates-java /usr/lib/jvm/java-8-openjdk/jre/lib/security/cacerts


	# Install pure bash implementation for c_rehash
	Fexe usr/bin/openssl-c_rehash.sh
}
