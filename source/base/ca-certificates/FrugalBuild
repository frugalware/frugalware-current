# Compiling Time: 0.05 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=ca-certificates
pkgver=20240203
pkgextraver=""
pkgrel=2
pkgdesc='Common CA certificates'
archs=('x86_64')
groups=('base' 'chroot-core')
depends=('openssl>=3.0.7' 'scriptlet-core')
makedepends=('openjre' 'detox' 'python3-cryptography')
url='http://packages.qa.debian.org/c/ca-certificates.html'
_F_cd_path="$pkgname"
Fpkgversep="_"
source=("http://http.debian.net/debian/pool/main/c/${pkgname}/${pkgname}_${pkgver}${pkgextraver}.tar.xz" \
	updatekeystore \
	openssl-c_rehash.sh)
up2date="Flasttar http://http.debian.net/debian/pool/main/c/ca-certificates/"
backup=('etc/ca-certificates.conf')
sha1sums=('e05a7cc1cab263bc4836487f878b3056b7217101' \
          'db02ce8cd92dda3128d38252c3c2babf3e15ef8d' \
          'bd5fae59161d1a970e2797a99021dc16ed0e11e2')

subpkgs=('ca-certificates-java')
subdescs=('Java Keystore of common CA certificates')
subdepends=('')
subgroups=('xapps')
subarchs=('x86_64')

build() {

	Fmkdir usr/share/ca-certificates
	Fmkdir usr/bin
	Fbuild

	# usr merge
	Fmv usr/sbin/update-ca-certificates usr/bin/update-ca-certificates
	Frm usr/sbin

	# Fix not printable stuff
	Fexec detox -r $Fdestdir/usr/share/$pkgname

	Fmkdir /etc
	echo "# Automatically generated by ${pkgname}-${pkgver}-${pkgrel}" > $Fdestdir/etc/ca-certificates.conf || Fdie
	echo "#" >> $Fdestdir/etc/ca-certificates.conf || Fdie
	find $Fdestdir/usr/share/$pkgname -name '*.crt' | sed "s|^$Fdestdir/usr/share/$pkgname/||" | sort -u >> $Fdestdir/etc/ca-certificates.conf

	KEYSTORE="$Fdestdir/usr/lib/jvm/java-21-openjdk/jre/lib/security/cacerts"
	Fmkdir usr/lib/jvm/java-21-openjdk/jre/lib/security

	for i in `find $Fdestdir/usr/share/$pkgname ! -type d`
	do
		filename=$(basename "$i")
		aliasname="${filename%.*}"
		Fexec /usr/lib/jvm/java-21-openjdk/bin/keytool -import -keystore $KEYSTORE -storepass changeit -noprompt -file $i -alias $aliasname || Fdie
	done
	unset LANG

	Finstall 755 updatekeystore /etc/cron.daily/updatekeystore
	Fsplit ca-certificates-java /etc/cron.daily/updatekeystore
	Fsplit ca-certificates-java /usr/lib


	# Install pure bash implementation for c_rehash
	Fexe usr/bin/openssl-c_rehash.sh
}

# optimization OK
