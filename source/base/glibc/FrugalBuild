# Compiling time: 8.20 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>

pkgname=glibc
pkgver=2.7
pkgrel=1
pkgdesc="GNU C Library"
url="http://www.gnu.org/software/libc/libc.html"
depends=()
rodepends=('tzdata')
makedepends=('grep>=2.5.3-2')
groups=('base' 'chroot-core')
archs=('i686' 'x86_64' 'ppc')
Fup2gnugz
source=(http://ftp.gnu.org/pub/gnu/glibc/glibc-$pkgver.tar.bz2)
signatures=("$source.sig")

## XEN disabled for 0.7
#if [ "$CARCH" == "i686" ]; then
#	subpkgs=('glibc-xen')
#	subdescs=('GNU C Library for Xen.')
#	subdepends=()
#	subconflicts=('glibc')
#	subprovides=('glibc')
#	subgroups=('base-extra')
#	subarchs=('i686')
#fi

_build()
{
	Ffilerel nscd/nscd.conf /etc/nscd.conf
	## use Fdie here and kill the build
	## if we get any errors. -- crazy --
	rm -rf ../glibc-build || Fdie
	mkdir ../glibc-build || Fdie
	cd ../glibc-build || Fdie
	../glibc-$pkgver/configure --prefix=/usr --with-tls --with-__thread \
		--enable-add-ons=nptl --enable-kernel=2.6.0 --without-cvs \
		--without-selinux --enable-shared --enable-bind-now \
		--enable-static --enable-all-warnings || Fdie

	make || Fdie

	make install_root=$Fdestdir install || Fdie
	make install_root=$Fdestdir localedata/install-locales || Fdie
	Frm /etc/ld.so.cache
	## conflicting files with tzdata 
	Frm etc/localtime
	Frm usr/share/zoneinfo
	Frm usr/sbin/{zdump,zic}
	Frm usr/bin/tzselect

	Frm /usr/share/info/dir
	cd - >/dev/null
}

build()
{
	# no multilib thanks
	Fsed 'x86_64 \| ' '' sysdeps/unix/sysv/linux/configure{,.in}
	Fpatchall
	export CXXFLAGS="$CXXFLAGS -fno-strict-aliasing"
	export CFLAGS="$CFLAGS -fno-strict-aliasing"
	## XEN stuff disable for 0.7
	#if [ "$CARCH" == "i686" ]; then
	#	xenflag="-mno-tls-direct-seg-refs"
	#	export CFLAGS="$CFLAGS $xenflag"
	#	_build || return 1
	#	Fsplit glibc-xen /etc /lib /sbin /usr
	#	export CFLAGS="${CFLAGS/ $xenflag}"
	#fi
	_build || Fdie
}

# optimization ok
