# Compiling time: 0.29 SBU
# Maintainer: DeX77 <dex77@frugalware.org>
# Contributor: Michel Hermier <hermier@frugalware.org>

pkgname=grub2
_F_archive_name=grub
pkgver=2.06
pkgrel=7
pkgdesc="The GNU GRand Unified Bootloader"
url="http://www.gnu.org/software/grub/"
rodepends=('grub-theme-frugalware' 'scriptlet-core')
makedepends=('unifont' 'rsync' 'xz' 'freetype2>=2.9' 'python3' 'autogen'
             'texinfo' 'help2man' 'gettext' 'fuse>=2.7.9-4' 'bison' 'dejavu-ttf')
backup=('etc/default/grub' 'etc/grub.d/40_custom')
depends+=('efibootmgr')
groups=('base')
archs=('x86_64')
up2date="Flasttar http://git.savannah.gnu.org/cgit/grub.git"
_F_archive_grepv="rc\|beta"


source=(http://ftp.gnu.org/gnu/grub/grub-$pkgver${pkgextraver/-/\~}.tar.xz
	0001-fs-xfs-Fix-unreadable-filesystem-with-v4-superblock.patch
	0002-configure-Remove-obsoleted-malign-jumps-loops-functi.patch
	0003-configure-Check-for-falign-jumps-1-beside-falign-loo.patch
	0004-build-Fix-build-error-with-binutils-2.36.patch
	0005-video-Remove-trailing-whitespaces.patch
	0006-loader-efi-chainloader-Simplify-the-loader-state.patch
	0007-commands-boot-Add-API-to-pass-context-to-loader.patch
	0008-loader-efi-chainloader-Use-grub_loader_set_ex.patch
	0009-kern-efi-sb-Reject-non-kernel-files-in-the-shim_lock.patch
	0010-kern-file-Do-not-leak-device_name-on-error-in-grub_f.patch
	0011-video-readers-png-Abort-sooner-if-a-read-operation-f.patch
	0012-video-readers-png-Refuse-to-handle-multiple-image-he.patch
	0013-video-readers-png-Drop-greyscale-support-to-fix-heap.patch
	0014-video-readers-png-Avoid-heap-OOB-R-W-inserting-huff-.patch
	0015-video-readers-png-Sanity-check-some-huffman-codes.patch
	0016-video-readers-jpeg-Abort-sooner-if-a-read-operation-.patch
	0017-video-readers-jpeg-Do-not-reallocate-a-given-huff-ta.patch
	0018-video-readers-jpeg-Refuse-to-handle-multiple-start-o.patch
	0019-video-readers-jpeg-Block-int-underflow-wild-pointer-.patch
	0020-normal-charset-Fix-array-out-of-bounds-formatting-un.patch
	0021-net-ip-Do-IP-fragment-maths-safely.patch
	0022-net-netbuff-Block-overly-large-netbuff-allocs.patch
	0023-net-dns-Fix-double-free-addresses-on-corrupt-DNS-res.patch
	0024-net-dns-Don-t-read-past-the-end-of-the-string-we-re-.patch
	0025-net-tftp-Prevent-a-UAF-and-double-free-from-a-failed.patch
	0026-net-tftp-Avoid-a-trivial-UAF.patch
	0027-net-http-Do-not-tear-down-socket-if-it-s-already-bee.patch
	0028-net-http-Fix-OOB-write-for-split-http-headers.patch
	0029-net-http-Error-out-on-headers-with-LF-without-CR.patch
	0030-fs-f2fs-Do-not-read-past-the-end-of-nat-journal-entr.patch
	0031-fs-f2fs-Do-not-read-past-the-end-of-nat-bitmap.patch
	0032-fs-f2fs-Do-not-copy-file-names-that-are-too-long.patch
	0033-fs-btrfs-Fix-several-fuzz-issues-with-invalid-dir-it.patch
	0034-fs-btrfs-Fix-more-ASAN-and-SEGV-issues-found-with-fu.patch
	0035-fs-btrfs-Fix-more-fuzz-issues-related-to-chunks.patch
	0036-templates-Improve-initramfs-detection.patch
	0037-font-Reject-glyphs-exceeds-font-max_glyph_width-or-f.patch
	0038-font-Fix-size-overflow-in-grub_font_get_glyph_intern.patch
	0039-font-Fix-several-integer-overflows-in-grub_font_cons.patch
	0040-font-Remove-grub_font_dup_glyph.patch
	0041-font-Fix-integer-overflow-in-ensure_comb_space.patch
	0042-font-Fix-integer-overflow-in-BMP-index.patch
	0043-font-Fix-integer-underflow-in-binary-search-of-char-.patch
	0044-kern-efi-sb-Enforce-verification-of-font-files.patch
	0045-fbutil-Fix-integer-overflow.patch
	0046-font-Fix-an-integer-underflow-in-blit_comb.patch
	0047-font-Harden-grub_font_blit_glyph-and-grub_font_blit_.patch
	0048-font-Assign-null_font-to-glyphs-in-ascii_font_glyph.patch
	0049-normal-charset-Fix-an-integer-overflow-in-grub_unico.patch
	argon2.patch
	grub2.04-fw.patch
	grub
	README.Frugalware)

sha1sums=('c9f93f1e195ec7a5a21d36a13b469788c0b29f0f' \
          'a7417f9ec97288d982786ec1e1cb267e1dec055e' \
          '78176b7e5a78b8eb3c5e4d5976fd1bf6f4a3b120' \
          '3aad91747fc83979083fe216bda7998761dbbc48' \
          '41de7331d5a902a8880a3a985ac7f87821f7ba8d' \
          '51a42c5c99b79ce5daca8f03b7e7ff6aede49e1c' \
          '89d3d9c17da69f17637596027df0020326a95310' \
          'd3f855d18bf8ece888aeb3bc9e1bbe8fe1893e4c' \
          'a4edae4f1c468f02b792f370511c4f0d71748a1a' \
          '54f9c4d29d2fc8463217e80597b0b7c227d7ed7b' \
          '63939091aa769c735e80d9396c6c64385bc6ec46' \
          'f3f1a44d5ef6d7644516ecdc5095a2b4042f826a' \
          '9ddabea1e5e311ee6873b10b165c783e49acea11' \
          '39fe4c4e7b62fc7b7cf7bd10bb91fb2188055e03' \
          '8c4537be013e541a168718e4daae6e21b4e5954b' \
          '4ba41de1da078970d791343e5a2909ee2d6c3107' \
          'd7b76ad612ed683f05cd295341c639f191f6dd11' \
          '42f4bf7d1bb9f347b482a2fcbb206385d6aa440d' \
          '7ecdc214e107272e390e17d25c7d7cb211b05dce' \
          'a062f00cbeae429acd3e950d67ef337295219a5b' \
          'd637945f5f3186700a777fc4b2d8eb5f72bb8409' \
          'b3c29dccabf44ebb1377bcc67d13de89bb9df584' \
          'ad87c616863dc18f3a4bc02657f9b7b42b58f931' \
          'c3c08501d1a5b66239b435c7c93a44c20c4b364b' \
          'a9cc4e6f922d8caa25f951146f09bb52972a5b2c' \
          'db8cdaff68119fa2eda523797fecfa393467282b' \
          'b57c964eeff5a292e8919e65b1d46ffa82ec5fa2' \
          '78f96a9cba8d36d588d043573f3596e68bf8523b' \
          '2eed5c4d292a7b9838d8e271c321131631fa8954' \
          'aad1a7800b8e557868d4d19ee5adbc28c2e10f00' \
          '780698576f292d44562af5214e5ebc508dd5c964' \
          '95d2c048c4ab59f58c5cc5acff6020e914f23076' \
          'c16ffe4bc868db33a1acdd1fa9cd42afcbacbef9' \
          'cc136c6880253407fe315f6d815678277899c1a6' \
          '12298a964b76e39ea0072634dd3e5809b0d5c932' \
          'cad162d8bfe416f2b511231b609cba4f43dbdf8e' \
          '06d14dd908dfb1ca830cd65b2f662896ba2747b2' \
          'a7748e12cb9158f22f2109668352368f385fff7f' \
          '3789944f12f87de5748dff6f2136e50453065fa5' \
          '27578b21830425b59d0d9b26900e63f4618878f6' \
          '4cf8745b449b878568ded96424fae6ef41a256a4' \
          '1658b19ec8fc2a907fae79e5b6517b1e73d172c5' \
          '1e3b388edd02b2a646f5d4082107209f34b122e4' \
          'a3bc2b45f1e4bd438904d79b98b2430768a1bc30' \
          'aed04a272f0f2a929ac813d519a0f1ebf6d155ba' \
          '7af78d4fbdc6f57af6a564e1045962dfd9d09552' \
          '22570f7270ae2725daba7da3b5e3d42346882a43' \
          '168b8d327680cdeae88986f60d4bb02ce30c9e68' \
          'bab1d51074f06be35dc48388d5ab18bead1c4ac6' \
          '9cf5926efb89187851cc47ec3f88336881c850d6' \
          '4d7adaf0d31dfd551861c8237da8168ba3b50999' \
          '1c73f2a182a0b8239ceac7b7c1eff9e00e969c4c' \
          'b070489950b87e4a9ca97d4e85db79879daae36a' \
          '9de273e2fb3095694e82cf9969de61e994f2bce6')

subpkgs=('grub2-mkfont')
subdescs=('grub2 mkfont utility')
subgroups=('base-extra')
subarchs=('x86_64')
subdepends=('freetype2>=2.9')

subpkgs+=('grub2-mount')
subdescs+=('grub2 mount utility')
subgroups+=('base')
subarchs+=('x86_64')
subdepends+=('fuse>=2.7.9-4')

Fconfopts+=" \
		--enable-mm-debug \
		--enable-nls \
		--enable-device-mapper \
		--enable-cache-stats \
		--enable-boot-time \
		--enable-grub-mkfont \
		--enable-grub-mount \
		--disable-werror"

_build_grub_platform()
{

	if [[ $1 = "pc" ]]; then
		_emu_bios=" --enable-efiemu"
	fi
	Fconf \
		CFLAGS="-O2 -fuse-ld=bfd" \
		TARGET_LDFLAGS="-static" \
		$_emu_bios \
		--with-platform=$1

	Fexec make -j1 || Fdie
	Fmakeinstall
	Fexec make distclean || Fdie
}

build()
{
	Fcd
	Fpatchall

	unset CFLAGS
	unset CPPFLAGS
	unset CXXFLAGS
	unset LDFLAGS
	unset MAKEFLAGS

	# Get locales
	Fexec ./linguas.sh || Fdie

	Fsed 'en@arabic' '' po/LINGUAS
	Fsed 'en@cyrillic' '' po/LINGUAS
	Fsed 'en@greek' '' po/LINGUAS
	Fsed 'en@hebrew' '' po/LINGUAS

	Fsed "/usr/share/fonts/X11/misc" "/usr/share/fonts/X11/misc /usr/share/fonts/X11/TTF" configure.ac
	Fautogen

	_build_grub_platform efi
	_build_grub_platform pc

	Ffile /etc/default/grub

	Fsplit grub2-mkfont /usr/bin/grub-mkfont
	Fsplit grub2-mount /usr/bin/grub-mount

	Fln ../default/grub /etc/sysconfig/grub-config
	Fln ../grub.d/40_custom /etc/sysconfig/grub-custom
}

# optimization OK

