# Compiling Time: 7.90 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

### NOTE: if you bump/relbump this package you need rebuild
## 	  kernel-initrd

pkgname=systemd
pkgver=240
pkgrel=3
pkgdesc="A System and Service Manager"
url="http://www.freedesktop.org/wiki/Software/systemd"
depends=('kmod>=25-2' 'cryptsetup-luks>=2.0.1-3' 'lz4>=1.8.1.2-2' 'libseccomp' 'libidn2' 'pcre2')
makedepends=('docbook-xsl' 'docbook-xml' 'intltool>=0.51.0-3' 'bash-completion' \
	'gperf>=3.0.4-5' 'lxml>=4.1.1-2' 'gobject-introspection>=1.54.1-2' 'polkit' 'libxkbcommon')
rodepends=('dbus>=1.12.2-4' "libsystemd>=$pkgver" 'scriptlet-core' 'hwdata' 'systemd-sysvinit' \
	'frugalware>=2.1-129' 'shadow>=4.6-5')
options+=('scriptlet')
_F_github_tag_v=y
Finclude github meson

source+=(
	# frugalware stuff
	console.conf
	blacklist
	65-permissions.rules
	usb-load-ehci-first.conf
	vconsole.conf
	media.mount
	var-lock.mount
	# fixes / reverts from master
	0001-Do-not-start-server-if-it-is-already-runnning-11245.patch
	0002-core-free-lines-after-reading-them.patch
	0003-switch-root-fix-error-message.patch
	0004-udev-event-do-not-read-stdout-or-stderr-if-the-pipef.patch
	0005-ask-password-api-do-not-call-ask_password_keyring-if.patch
	0006-Docs-Add-Missing-Space-Between-Words.patch
	0007-test-json-check-absolute-and-relative-difference-in-.patch
	0008-Pass-separate-dev_t-var-to-device_path_parse_major_m.patch
	0009-libudev-util-make-util_replace_whitespace-read-only-.patch
	0010-sd-device-fix-segfault-when-error-occurs-in-device_n.patch
	0011-Revert-sd-device-ignore-bind-unbind-events-for-now.patch
	0012-Revert-udevd-configure-a-child-process-name-for-work.patch
	0013-test-add-test-for-sending-receiving-an-invalid-devic.patch
	0014-journal-rely-on-_cleanup_free_-to-free-a-temporary-s.patch
	0015-Revert-pam_systemd-drop-setting-DBUS_SESSION_BUS_ADD.patch
	0016-udev-rework-how-we-handle-the-return-value-from-spaw.patch
	0017-json-handle-NULL-explicitly-in-json_variant_has_type.patch
	0018-udev-node-make-link_find_prioritized-return-negative.patch
	0019-core-mount-make-mount_setup_existing_unit-not-drop-M.patch
	0020-coredump-remove-duplicate-MESSAGE-prefix-from-messag.patch
	0021-journald-remove-unnecessary.patch
	0022-journald-do-not-store-the-iovec-entry-for-process-co.patch
	0023-basic-process-util-limit-command-line-lengths-to-_SC.patch
	0024-coredump-fix-message-when-we-fail-to-save-a-journald.patch
	0025-journald-set-a-limit-on-the-number-of-fields-1k.patch
	0026-journald-when-processing-a-native-message-bail-more-.patch
	0027-journald-lower-the-maximum-entry-size-limit-to-for-n.patch
	0028-httpd-use-a-cleanup-function-to-call-MHD_destroy_res.patch
	0029-journal-remote-verify-entry-length-from-header.patch
	0030-journal-remote-set-a-limit-on-the-number-of-fields-i.patch
	0031-logind-do-not-pass-negative-number-to-strerror.patch
	0032-udevd-drop-redundant-call-to-sd_event_get_exit_code.patch
	0033-udev-open-control-and-netlink-sockets-before-daemoni.patch
	0034-Revert-logind-become-the-controlling-terminal-proces.patch
	https://github.com/systemd/systemd/commit/0eba88dc9f66aca023a89e2bf25f6bff49787145.patch
	revert-a17c17122c304ff3f67f1cbf119fa7116315a7df.patch
	https://github.com/systemd/systemd/commit/98aed1d68e13ef44bd844e6347e05faf9385a2ff.patch
	Revert-udev-rules-Permission-changes-for-dev-dri-renderD.patch
	## frugalware patches
	0001-frugalware-VT-defaults.patch
	0002-frugalware-sysusers-changes.patch
	0003-frugalware-udev-rules-changes.patch
	0004-frugalware-drop-nobody-from-here.patch
	0005-frugalware-pam-changes.patch
	0006-frugalware-drop-render-group.patch
	)
sha1sums=('09014c22f8fd6b98b7fd6eca40e44194b0a49931' \
          'cbc0db0e1ccc0a57b5e7773b2ec13f3aa9ff668c' \
          '4657cbad76a3d5c8aade4dba166b3f8704c7b07f' \
          '439e2be7278ecedb4a4f090241bb484a7a25a9c3' \
          'ecb14db2a916c96781ee2fcb8d0cd44dbe978dd7' \
          '66c90190613ef915e5b2b1da37abd19791f7b16d' \
          'f896279eca1bcd02db36b215470593734fd894ee' \
          'b784cca7ac15405edc2e5c4c1851d712bb6bcc38' \
          '6a8c99653bf05ccb49a48f75c9186169ee012614' \
          '016d0ce6e74dc67d73c414365e2aa242c12fcb44' \
          '7c4be2b877b215f8d5edd37ab749f2b10f4a19c0' \
          'a03dfdc77eebb3b9c7f4d41b1fc912c412754bdc' \
          '7af65f3c303408229b1da5c3a22cd3677b867a98' \
          '81a88429faaa4ae881c91c7dd80cf26b158eb033' \
          '1e588f23e5fc256ae69f87f8051559b272bd1403' \
          '2b1122cc9d90bd51fddccb98d78757629f2d45e8' \
          '243b89a80fd759e384a4a7cb48a521f6a2c35e99' \
          '8959cb99c1ee657c6d4fc09e3626b26b4cf65dee' \
          '36c9df858c527a6f8754d5b97a066e6459bd2573' \
          'a34bc0672f764db67089b2da492720e74ed62010' \
          '8707d71b840456bfb350740f9a6cad7444362963' \
          '5a883f891950ecf53bfadb56820d270cb27e3112' \
          '0fe99c61b25f6e92793de9e91d419617c01cdeda' \
          'd8e30d8ed0656b185c621f2e8c2e45eee82b7620' \
          'bb1c58ca7a88c447c55ab5ac879be4a6b5acb3ea' \
          'b82861c7fe4e88dae5b46791185a3b3b025b70de' \
          '618a2457be6912fb132afaaad4456506093a89c9' \
          '7688bc83a9da8549201fb52592220213d1ca7647' \
          '49dbcc7a13c52b7119ae0b3930aa1ad98affe47d' \
          '4f9b9834b6ffb620f575b44ff062d0ae6d79c866' \
          'fee28e9d252770fecb0dd01676c66721f6501848' \
          'ccfe1a9ffbbb0a472f52fc86dc7852233ed99a56' \
          'f6a2a8fedaae619d1ad5e5b9ba38596121ed2e85' \
          '1d797cad51d56ccef9e263130949561340ac5253' \
          '7ad6d65b285f69f4840c0f4507b992174bb3cd8b' \
          'de29872417c99a98d8dfc5732ef807ec54c17d4a' \
          '8c9212edc672e4f69fee41038355aeeccd92815a' \
          '29f1b67111f7fa5a482478ce05a45302c1b5d042' \
          '955adc4024550724600c73592b8aafe09cb0b06b' \
          'e8610ac2e4dc4cbb9b793c383dc0c22528b2208b' \
          '287a1d7f95aa29b0691eb0fc6a4213ce1c213cfa' \
          'c555eda0c0fd06fb4d9d6a43c030581ed558eba2' \
          '6518cfc42f07ec75e34e7146bca807b1f78694ec' \
          '968ce331bcd91ee57eea271ca5d8a3b5051f5edf' \
          'a1a21d44d5426b5eed5fe8d6538a85c756bc3b3c' \
          'bfd61ad8e6b16f305afbcd2ab6597a15282f652b' \
          'c8433385f3934478e19229bab2db12d085d5597c' \
          'c1e9cea09bb0dda8be4ef799c4c2927747bb3931' \
          '459e393466897a89200df52b5e65b0910f444582' \
          '4e1d30a9c40671c38d6cb24bf241e0cb6d127aa8' \
          '38d3cbd3405bcd97f7e6c0e1302040411ffb8b17' \
          'f6eaa3031d0d4a781f0ef125a196101a9ad158d4')

groups=('base' 'core')
archs=('x86_64')

#TODO : Remove backup, source rc for SysVinit when all rc scripts used systemd
backup=(etc/{vconsole.conf,systemd/{system.conf,user.conf,logind.conf,journald.conf},machine-id,machine-info,locale.conf,udev/udev.conf,sysconfig/blacklist,tmpfiles.d/console.conf,dbus-1/system.d/org.freedesktop.{hostname,locale,login,systemd,timedate}1.conf,X11/xorg.conf.d/00-keyboard.conf})

subpkgs=('systemd-sysvinit')
subdescs=('systemd System V init tools')
subrodepends=("$pkgname=$pkgver")
subreplaces=('sysvinit')
subgroups=('base core')
subarchs=('x86_64')
subprovides=('sysvinit')
subconflicts=('sysvinit')
subdepends=('pam>=1.3.0-4 kmod>=25-2 libcap>=2.25-4 lz4>=1.8.1.2-2 libgcrypt>=1.8.0-2')
suboptions=('')

subpkgs+=('systemd-remote')
subdescs+=('systemd remote journald')
subrodepends+=("$pkgname=$pkgver")
subreplaces+=('')
subgroups+=('base-extra')
subarchs+=('x86_64')
subprovides+=('')
subconflicts+=('')
subdepends+=('libmicrohttpd>=0.9.58-2 lz4>=1.8.1.2-2')
suboptions+=('')

subpkgs+=('systemd-pull')
subdescs+=('systemd container retrieval')
subrodepends+=("$pkgname=$pkgver")
subreplaces+=('')
subgroups+=('network-extra')
subarchs+=('x86_64')
subprovides+=('')
subconflicts+=('')
subdepends+=('curl>=7.58.0-2 libgcrypt>=1.8.0-2 libcap>=2.25-4')
suboptions+=('')

subpkgs+=('libsystemd')
subdescs+=('systemd libs')
subrodepends+=("")
subreplaces+=('')
subgroups+=('base core')
subarchs+=('x86_64')
subprovides+=('')
subconflicts+=('')
subdepends+=('xz>=5.2.2-4 lz4>=1.8.1.2-2 libgcrypt>=1.7.3-2 xfsprogs-acl>=2.2.52-5 libidn>=1.35 elfutils>=0.167-2 libcap>=2.24-4 bzip2>=1.0.6-6 zlib>=1.2.8-8')
suboptions+=('')


build()
{


	Fcd
	## DOES NOT WORK , do NOT enable that NOW or boot breaks! ( crazy )
	#Fsed 'sbin/agetty' 'sbin/frugalwaregetty' units/getty@.service.m4


	Meson_build \
		-Dnobody-user=nfsnobody -Dnobody-group=nfsnobody \
		-Dok-color=highlight-green \
		-Dtty-gid=5 \
		-Dusers-gid=100 \
		-Drootprefix=/ \
		-Dntp-servers=0.pool.ntp.org,1.pool.ntp.org,2.pool.ntp.org,3.pool.ntp.org \
		-Dcertificate-root=/etc/ssl \
		-Dpamlibdir=/lib/security \
		-Dpamconfdir=/etc/pam.d \
		-Dpkgconfigdatadir=/usr/lib/pkgconfig \
		-Dpkgconfiglibdir=/usr/lib/pkgconfig \
		-Dsysvinit-path=/etc/rd.d \
		-Dsysvrcnd-path=/etc/rc.d \
		-Drc-local=/etc/rc.local \
		-Dhalt-local=/sbin/halt.local \
		-Dloadkeys-path=/usr/bin/loadkeys \
		-Dsetfont-path=/usr/bin/setfont \
		-Dkmod-path=/usr/bin/kmod \
		-Dsulogin-path=/sbin/sulogin \
		-Dmount-path=/bin/mount \
		-Dumount-path=/bin/umount \
		-Ddebug-shell=/bin/bash \
		-Ddebug-tty=/dev/tty9 \
		-Dfallback-hostname=frugalware \
		-Dadm-group=true \
		-Dwheel-group=true \
		-Dsplit-usr=true \
		-Dsplit-bin=true \
		-Dutmp=true \
		-Dlibidn2=true \
		-Dlibcurl=true \
		-Dtpm=true \
		-Dhibernate=true \
		-Dldconfig=true \
		-Denvironment-d=true \
		-Dbinfmt=true \
		-Dcoredump=true \
		-Dlogind=true \
		-Dhostnamed=true \
		-Dlocaled=true \
		-Dmachined=true \
		-Dtimedated=true \
		-Dtimesyncd=true \
		-Drfkill=true \
		-Dremote=true \
		-Drandomseed=true \
		-Dbacklight=true \
		-Dvconsole=true \
		-Dquotacheck=true \
		-Dsysusers=true \
		-Dtmpfiles=true \
		-Dseccomp=true \
		-Dpolkit=true \
		-Dacl=true \
		-Dpam=true \
		-Dkmod=true \
		-Dblkid=true \
		-Dmicrohttpd=true \
		-Dlibcryptsetup=true \
		-Delfutils=true \
		-Dzlib=true \
		-Dbzip2=true \
		-Dlz4=true \
		-Dxz=true \
		-Dgshadow=true \
		-Dxkbcommon=true \
		-Dpcre2=true \
		-Dtests=false \
		-Ddefault-kill-user-processes=false \
		-Dgnu-efi=false \
		-Dslow-tests=false \
		-Dinstall-tests=false \
		-Dglib=false \
		-Daudit=false \
		-Dselinux=false \
		-Dapparmor=false \
		-Dresolve=false \
		-Defi=false \
		-Dnetworkd=false \
		-Dportabled=false \
		-Dhtml=false \
		-Drpmmacrosdir=no


	## wtf these guys smoke..
	## https://www.freedesktop.org/software/systemd/man/systemd.offline-updates.html
	## HELL NO.. Just wipe this shit away

	Frm lib/systemd/system-generators/systemd-system-update-generator
	Frm lib/systemd/system/system-update*
	Frm usr/share/man/man8/systemd-system-update*
	Frm usr/share/man/man7/systemd.offline*

	Fcp console.conf etc/tmpfiles.d/console.conf

	Fmkdir sbin
	Fln /lib/systemd/systemd /sbin/init
	Fln /bin/systemctl /sbin/reboot
	Fln /bin/systemctl /sbin/halt
	Fln /bin/systemctl /sbin/poweroff
	Fln /bin/systemctl /sbin/shutdown
	Fln /bin/systemctl /sbin/telinit
	Fln /bin/systemctl /sbin/runlevel
	Fsplit systemd-sysvinit sbin/{init,reboot,halt,poweroff,shutdown,telinit,runlevel}
	Fsplit systemd-sysvinit usr/share/man/man8/{halt,poweroff,reboot,runlevel,shutdown,telinit}.*

	Frm etc/systemd/system/*.target.wants

	Fmkdir etc/systemd/system/getty@tty1.service.d
cat > $Fdestdir/etc/systemd/system/getty@tty1.service.d/noclear.conf << EOF
[Service]
TTYVTDisallocate=no
EOF

	# we have runlevel 4 as the x11 target, not 5
	Fln multi-user.target /lib/systemd/system/runlevel5.target
	Fln graphical.target /lib/systemd/system/runlevel4.target

	# Make sure these directories are properly owned
	Fmkdir lib/systemd/system/basic.target.wants
	Fmkdir lib/systemd/system/default.target.wants
	Fmkdir lib/systemd/system/dbus.target.wants
	Fmkdir lib/systemd/system/syslog.target.wants

	Fexec touch $Fdestdir/etc/{machine-id,machine-info,locale.conf}

	Ffile /etc/sysconfig/blacklist

	Ffile /etc/vconsole.conf

	Fmkdir /etc/X11/xorg.conf.d

	Fexec touch $Fdestdir/etc/X11/xorg.conf.d/00-keyboard.conf

	## probably we should just /lib/modprobe.d -> /etc/modprobe.d
	## all that is getting stupid , there is /modules-load.d/ folder(s) too
	Fmkdir /etc/modprobe.d

	Fln /etc/sysconfig/blacklist /etc/modprobe.d/blacklist.conf

	# We need this to stop kernel WARNING about ehci_hcd beeing loaded after ohci/uhci
	Ffile /lib/modprobe.d/usb-load-ehci-first.conf

	# Compatibility units. Look into an upgrade path to remove them after 1.8.
	Ffile /lib/systemd/system/media.mount
	Ffile /lib/systemd/system/var-lock.mount
	Fln ../media.mount /lib/systemd/system/local-fs.target.wants/media.mount
	Fln ../var-lock.mount /lib/systemd/system/local-fs.target.wants/var-lock.mount

	Frm /etc/bash_completion.d
	# fixme
	Frm /lib/udev/hwdb.d # Use the one from hwdata

	Fsplit systemd-remote lib/systemd/systemd-journal-gatewayd
	Fsplit systemd-remote lib/systemd/systemd-journal-remote
	Fsplit systemd-remote lib/systemd/systemd-journal-upload

	Fsplit systemd-pull lib/systemd/systemd-pull

	## libsystemd-shared not sure about this one
	Fsplit libsystemd lib/security
	Fsplit libsystemd lib/systemd/libsystemd*
	Fsplit libsystemd lib/libsystemd*
	Fsplit libsystemd lib/libnss*
	# Fixme
	Fsplit libsystemd lib/libudev*
	Fsplit libsystemd usr/lib/pkgconfig/lib*.pc
}

# optimization OK
