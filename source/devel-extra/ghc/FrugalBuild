# Compiling Time: 30.17 SBU
# Maintainer: dex77 <dex77@frugalware.org>

pkgname=ghc
pkgver=9.6.2
_bootstrapver=9.2.3
_dist=fedora27
pkgrel=1
pkgdesc="The Glasgow Haskell Compiler"
url="https://www.haskell.org/ghc/"
depends=('gmp>=5.0.1' 'readline>=7.0-2' 'ncurses>=6.1-7' 'libedit>=20150325_3.1-3' 'libffi>=3.4')
makedepends=('python3-sphinx' 'mold' 'python3-sphinx-rtd-theme')
groups=('devel-extra')
archs=('x86_64')
_F_archive_grepv=windows
up2date="Flastarchive http://downloads.haskell.org/~ghc/latest/ -src.tar.xz"
options=('scriptlet')
source=($url/dist/$pkgver/$pkgname-$pkgver-src.tar.xz \
	https://downloads.haskell.org/~ghc/${_bootstrapver}/ghc-${_bootstrapver}-x86_64-${_dist}-linux.tar.xz \
	https://files.pythonhosted.org/packages/66/86/7b2c3d15f44cb3ea2e1c54481494121d755081aa57a8076de3fa2be4d587/sphinx_rtd_theme-1.2.2.tar.gz )
signatures=("${source[0]}.sig" "${source[1]}.sig" '')

subpkgs=("$pkgname-docs")
subdescs=("GHC HTML documentation..")
subgroups=('devel-extra')
subdepends=('')
subrodepends=("ghc")
subarchs=('x86_64')

replaces=('haskell-xhtml'
	'haskell-array'
	'haskell-binary'
	'haskell-containers'
	'haskell-deepseq'
	'haskell-haskeline'
	'haskell-terminfo'
	'haskell-transformers'
	'haskell-mtl'
	'haskell-parsec')
conflicts=("${replaces[@]}")
provides=("${provides[@]}")
_Fbuild_no_patch="yes"
Fbuildchost="x86_64-unknown-linux"

build()
{
	export LANG=en_US.UTF-8

        # use mold
        export LDFLAGS="-fuse-ld=mold $LDFLAGS"

	Fexec cd $Fsrcdir || Fdie
	Fexec rm -rf $pkgname-$pkgver || Fdie
	Fextract $pkgname-$pkgver-src.tar.xz || Fdie
	Fexec mkdir -p temp-ghc-bootstrap || Fdie
	Fexec tar -C temp-ghc-bootstrap -xvf ghc-${_bootstrapver}-x86_64-${_dist}-linux.tar.xz || Fdie

	# install binary dist
	Fexec cd "$Fsrcdir/temp-ghc-bootstrap/ghc-${_bootstrapver}/" || Fdie

	Fexec ./configure --prefix="$Fsrcdir/bootstrap" || Fdie
	Fexec make install || Fdie

	Fexec cd "$Fsrcdir/$pkgname-$pkgver" || Fdie
	Fpatchall

	# use newer
	Fexec rm -rf docs/users_guide/rtd-theme || Fdie
	Fexec ln -s "$Fsrcdir/sphinx_rtd_theme-1.2.2/sphinx_rtd_theme" docs/users_guide/rtd-theme || Fdie

        # Bootstrap
        #

        Fexec python3 hadrian/bootstrap/bootstrap.py \
		-w "$Fsrcdir/bootstrap/bin/ghc" \
		--deps "hadrian/bootstrap/plan-bootstrap-${_bootstrapver//\./_}.json" \
		fetch \
		-o "${_bootstrapver}_bootstrap_sources" || Fdie
        Fexec python3 hadrian/bootstrap/bootstrap.py  \
		-w "$Fsrcdir/bootstrap/bin/ghc" \
		--bootstrap-sources "${_bootstrapver}_bootstrap_sources.tar.gz" || Fdie

	export LD=/usr/bin/mold
	export DESTDIR="$Fdestdir"
	Fconf	--with-system-libffi \
		GHC="$Fsrcdir/bootstrap/bin/ghc" \
		--with-ffi-includes="$(pkg-config --variable=includedir libffi)"
	Fexec _build/bin/hadrian  \
		-w "$Fsrcdir/bootstrap/bin/ghc" \
		install --prefix="/usr" \
		--docs=no-sphinx-pdfs \
		-V \
		-j \
		--flavour=release || Fdie

	Fmkdir etc/ld.so.conf.d/

	Fexec cd $Fdestdir || Fdie

        local i
	for i in $(find usr/lib -name "*.so*" -exec dirname {} \; | sort -u);
	do
		Fexec echo "/${i}" >> "$Fdestdir/etc/ld.so.conf.d/ghc.conf" || Fdie

	done

	Fsplit $pkgname-docs usr/share/doc/ghc-$pkgver

}

# optimization OK
