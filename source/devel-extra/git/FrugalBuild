# Compiling Time: 2.59 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>

USE_DEVEL=${USE_DEVEL:-"n"}

pkgname=git
pkgver=1.5.3.4
Fuse $USE_DEVEL && pkgver=1.5.3.rc7.30.g947ad2
pkgrel=3
pkgdesc="A fast, scalable, distributed revision control system."
url="http://www.kernel.org/pub/software/scm/git/"
depends=('curl>=7.16.0' 'openssl')
makedepends=('asciidoc' 'docbook-xsl>=1.73.0-2' 'docbook-xml' 'sgml-common' 'xmlto' 'cpio')
groups=('devel-extra')
archs=('i686' 'x86_64')
up2date="lynx -dump '$url/?C=M;O=D'|grep 'git-[0-9.]*.tar.bz2$'|sed -n 's/.*-\(.*\)\.t.*/\1/;1 p'"
if ! Fuse $USE_DEVEL; then
	source=($url/$pkgname-$pkgver.tar.bz2)
	signatures=(${source[0]}.sign '' '' '' '' '')
fi
source=(${source[@]} gitweb.modules.d gitweb.conf README.Frugalware rc.git git.sysconfig)
options=('scriptlet')

subpkgs=('gitweb' 'git-gui' 'gitk')
subdescs=('Web interface for Git.' 'Git GUI tool.' 'Git revision tree visualiser.')
subdepends=("git=$pkgver" "git=$pkgver tk" "git=$pkgver tk")
subbackup=('etc/gitweb.conf etc/httpd/conf/modules.d/gitweb.conf' '' '')
subgroups=('network-extra' 'xapps-extra' 'xapps-extra')
subarchs=('i686 x86_64' 'i686 x86_64' 'i686 x86_64')

if Fuse $USE_DEVEL; then
	_F_scm_type="git"
	_F_scm_url="git://git.kernel.org/pub/scm/git/git.git"
	Finclude scm
fi

build()
{
	if Fuse $USE_DEVEL; then
		Funpack_scm
		make configure
	fi

	# undebianize
	Fsed 'doc/' '' templates/hooks--post-receive
	Fsed ' (on debian)' '' templates/hooks--post-receive

	# don't install the source of the manpages
	Fsed ' \*.txt' '' Documentation/install-webdoc.sh

	# we don't need the html version of manpages
	Fsed '^DOC_HTML=.*' 'DOC_HTML=' Documentation/Makefile

	Fconf
	make V=1 CLFAGS="$CFLAGS" ASCIIDOC8=YesPlease ETC_GITCONFIG=/etc/gitconfig all doc test || return 1
	Fmakeinstall install-doc ETC_GITCONFIG=/etc/gitconfig mandir=/usr/share/man
	Ffilerel perl/private-Error.pm /usr/lib/perl5/site_perl/current/Error.pm
	make -C Documentation WEBDOC_DEST=$Fdestdir/usr/share/doc/$pkgname-$pkgver install-webdoc || return 1
	# broken symlink
	Frm /usr/share/doc/git-$pkgver/index.html
	Fdocrel Documentation/SubmittingPatches
	Fdocrel Documentation/technical

	# libgit
	Ffilerel /usr/lib/libgit.a
	Ffilerel *.h /usr/include/git/

	# contrib dir
	Fcprrel contrib /usr/share/git-core/

	# gitweb
	Fmkdir /var/www/gitweb
	rm gitweb/gitweb.perl
	cp gitweb/git* $Fdestdir/var/www/gitweb
	Ffile gitweb.modules.d /etc/httpd/conf/modules.d/gitweb.conf
	Ffile /etc/gitweb.conf
	Fsplit gitweb /etc/{httpd,gitweb.conf} /var
	Fdoc README.Frugalware

	# git-daemon
	Ffile git.sysconfig /etc/sysconfig/git

	# git-gui
	Fsplit git-gui usr/bin/git-{gui,citool}
	Fsplit git-gui usr/share/git-gui
	Fsplit git-gui usr/share/man/man1/git-{gui,citool}.1

	# gitk
	Fsplit gitk usr/bin/gitk
	Fsplit gitk usr/share/man/man1/gitk.1
}

# optimization OK
