# Compiling Time: 0 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=grpc
pkgver=1.52.1
pkgrel=1
_gtestver=0e402173c97aea7a00749e825b194bfede4f2e45
pkgdesc="High performance, open source, general RPC framework that puts mobile and HTTP/2 first."
archs=('x86_64')
groups=('devel-extra')
url='https://grpc.io'
depends=('openssl>=3.0.7' 'c-ares' 'protobuf>=21.5' 're2>=2020.08.01-4' 'abseil-cpp>=20230125')
makedepends=('re2-static' 'systemd-devel')
_F_github_tag_v=yes
_F_github_grepv="pre\|1.47\|1.46\|1.51"
_F_cmake_confopts="	-DgRPC_BUILD_CSHARP_EXT=OFF \
			-DgRPC_BUILD_GRPC_CSHARP_PLUGIN=OFF \
			-DgRPC_BUILD_GRPC_OBJECTIVE_C_PLUGIN=OFF \
			-DgRPC_CARES_PROVIDER=package \
			-DgRPC_PROTOBUF_PROVIDER=package \
			-DgRPC_SSL_PROVIDER=package \
			-DgRPC_ZLIB_PROVIDER=package \
			-DgRPC_RE2_PROVIDER=package \
			-DBUILD_SHARED_LIBS=ON \
			-DgRPC_ABSL_PROVIDER=package \
			-DCMAKE_CXX_STANDARD=17 \
			-DCMAKE_POSITION_INDEPENDENT_CODE=ON"
Finclude github cmake
source+=("https://github.com/google/googletest/archive/$_gtestver/googletest-$_gtestver.tar.gz")
sha1sums=('3f2e4f5e00b7580bbeafa7d5ec59acfad79f590b' \
          'a01364a9c6e7aa314b6cffdf22377a7bde85ba11')


build() {
	Fcd
	Fexec ln -sf "F$srcdir/googletest-$_gtestver/"{googlemock,googletest} \
		third_party/googletest || Fdie


	## what a f*cking weird package
	## grpc_cpp_plugin: error while loading shared libraries: libgrpc_plugin_support.so.1: cannot open shared object file: No such file or directory
	## so we have to add $buildir to LD_LIBRARY_PATH so it can find his just build lib..
	export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$Fsrcdir/$_F_cd_path/frugalware_cmake_build"
	CMake_build
}


# optimization OK
