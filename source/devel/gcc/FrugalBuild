# Compiling Time: 26.48 SBU
# Maintainer: crazy <crazy@frugalware.org>
# Contributor: James Buren <ryuo@frugalware.org>
# Contributor: Miklos Vajna <vmiklos@frugalware.org>


## TODO: split libcilkrts ? now in gcc package
## -> https://www.cilkplus.org/

USE_SHARED=${USE_SHARED:-"y"}
USE_BRANCH=${USE_BRANCH:-"y"}

USE_LANGS=${USE_LANGS:-"y"}
USE_CXX=${USE_CXX:-"$USE_LANGS"}
USE_FORTRAN=${USE_FORTRAN:-"$USE_LANGS"}
USE_OBJC=${USE_OBJC:-"$USE_LANGS"}

# Activate required langage
Fuse $USE_OBJC && USE_CXX="y"

pkgname=gcc
if Fuse $USE_BRANCH; then
	## released version is 6.2.0 .. branch is minor+1
	pkgver=7.3.1
	gccver=$pkgver
else
	pkgver=7.3.0
	gccver=$pkgver
fi
pkgrel=2
pkgdesc="The GNU Compiler Collection"
url="http://gcc.gnu.org"
depends=('binutils>=2.30.0-10' 'glibc>=2.27-5' 'libmpc>=1.1.0-8' 'zlib>=1.2.11-8')
makedepends=('kernel-headers>=4.16.11' 'lib32-zlib>=1.2.11-8')
provides=('c-compiler')
groups=('devel' 'devel-core')
archs=('x86_64')
options+=('scriptlet' 'noccache' 'static' 'nostrip')
if Fuse $USE_BRANCH; then
	_pkgver=20180517
	## well something
	up2date="Flasttar ftp://gcc.gnu.org/pub/gcc/snapshots/LATEST-${pkgver/%.*/}/ | sed 's/7_/${pkgver}_/g' | sed 's/_${_pkgver}//g'"
	source=(ftp://gcc.gnu.org/pub/gcc/snapshots/${pkgver/%.*}-${_pkgver}/gcc-${pkgver/%.*}-${_pkgver}.tar.xz)
	sha1sums=('0455eca25828df63d5649420603694e131f117d1')
	_F_cd_path="gcc-${pkgver/%.*}-${_pkgver}"
else

	up2date="lynx -dump http://ftp.gnu.org/pub/gnu/gcc/|grep gcc-.*/$|sed -n 's|.*gcc-\(.*\)/|\1|;$ p'"
	source=(http://ftp.gnu.org/pub/gnu/gcc/gcc-$pkgver/gcc-$pkgver.tar.xz)
	sha1sums=('9689b9cae7b2886fdaa08449a26701f095c04e48')
fi

## nothing should use that however ..
replaces=('lib32-gcc')
provides=('lib32-gcc')

if Fuse $USE_SHARED; then
	subpkgs=('libgcc' 'libssp' 'libgomp' 'libatomic')
	subdescs=('GCC shared support library' \
	'SSP libraries from GCC' 'GNU OpenMP runtime library' 'Atomic libraries from GCC')
	subrodepends=('glibc' 'glibc' 'glibc' 'glibc')
	subgroups=('base chroot-core' 'lib' 'lib' 'lib')
	subprovides=('lib32-libgcc' 'lib32-libssp' 'lib32-libgomp' 'lib32-libatomic')
	subreplaces=('lib32-libgcc' 'lib32-libssp' 'lib32-libgomp' 'lib32-libatomic')
fi
if Fuse $USE_CXX; then
	subpkgs=("${subpkgs[@]}" 'libstdc++' 'gcc-g++')
	subdescs=("${subdescs[@]}" 'GNU Standard C++ Library' 'C++ suport for GCC')
	subrodepends=("${subrodepends[@]}" 'libgcc' 'libstdc++ gcc')
	subgroups=("${subgroups[@]}" 'base chroot-core' 'devel devel-core')
	subprovides=("${subprovides[@]}" 'lib32-libstdc++' 'lib32-gcc-g++')
	subreplaces=("${subreplaces[@]}" 'lib32-libstdc++' 'lib32-gcc-g++')
fi
if Fuse $USE_OBJC; then
	subpkgs=("${subpkgs[@]}" 'libobjc' 'gcc-objc' 'gcc-objc++')
	subdescs=("${subdescs[@]}" 'Objective-C runtime' 'Objective-C support for GCC' 'Objective-C++ support for GCC')
	subrodepends=("${subrodepends[@]}" 'libgcc' 'libobjc gcc' 'gcc-objc gcc-g++')
	subgroups=("${subgroups[@]}" 'lib-extra' 'devel-extra' 'devel-extra')
	subprovides=("${subprovides[@]}" 'lib32-libobjc' 'lib32-gcc-objc' 'lib32-gcc-objc++')
	subreplaces=("${subreplaces[@]}" 'lib32-libobjc objc objc-bootstrap' 'lib32-gcc-objc' 'lib32-gcc-objc++')
fi

if Fuse $USE_FORTRAN; then
	subpkgs=("${subpkgs[@]}" 'libquadmath' 'libgfortran' 'gcc-gfortran')
	subdescs=("${subdescs[@]}" 'Quadruple Precision Math library from GCC' 'Fortran 95 runtime' 'Fortran 95 support for GCC')
	subrodepends=("${subrodepends[@]}" 'glibc' 'libgcc libquadmath' 'libgfortran gcc')
	subgroups=("${subgroups[@]}" 'lib' 'lib' 'devel-extra')
	subprovides=("${subprovides[@]}" 'lib32-libquadmath' 'lib32-libgfortran' 'lib32-gcc-gfortran')
	subreplaces=("${subreplaces[@]}" 'lib32-libquadmath' 'lib32-libgfortran' 'lib32-gcc-gfortran')
fi
i=0
while [ $i -lt ${#subpkgs[@]} ]
do
	subarchs=("${subarchs[@]}" "x86_64")
	suboptions=("${suboptions[@]}" "nostrip")
	i=$(($i+1))
done


build()
{
	Fcd
	Fsed 'lib64' 'lib' gcc/config/i386/t-linux64

	# no fixincludes, thanks
	Fsed '\./fixinc\.sh' '-c true' gcc/Makefile.in

	Fpatchall

	mkdir -p ../$pkgname-build || Fdie
	cd ../$pkgname-build || Fdie

	langlist="c"
	if Fuse $USE_CXX; then
		langlist="$langlist,c++"

		Fconfopts+=" --enable-__cxa_atexit \
			--enable-libstdcxx-allocator=new \
			--enable-libstdcxx-dual-abi \
			--disable-libstdcxx-pch \
			--enable-linux-futex \
			--with-default-libstdcxx-abi=new"
	fi

	Fuse $USE_OBJC && langlist="$langlist,objc,obj-c++"

	if Fuse $USE_FORTRAN; then
		langlist="$langlist,fortran"
		Fconfopts+=" --enable-libquadmath --enable-libquadmath-support"
	else
		Fconfopts+=" --disable-libquadmath --disable-libquadmath-support"
	fi

	_F_conf_configure=../$_F_cd_path/configure
	CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS" XCFLAGS="$CFLAGS" TCFLAGS="$CFLAGS" AR_FLAGS="crD" ARFLAGS="crD"
	Fconf \
		--enable-languages=$langlist \
		--enable-bootstrap \
		--enable-multilib \
		--enable-lto \
		--enable-clocale=gnu \
		--disable-libgo \
		--enable-shared \
		--disable-libunwind-exceptions \
		--verbose \
		--enable-threads=posix \
		--with-system-zlib \
		--libdir=/usr/lib \
		--libexecdir=/usr/lib \
		--disable-werror \
		--with-bugurl="http://bugs.frugalware.org/" \
		--with-pkgversion="Frugalware Linux" \
		--enable-plugin \
		--enable-checking=release \
		--enable-default-pie \
		--enable-default-ssp \
		--enable-linker-build-id \
		--with-linker-hash-style=gnu \
		--enable-gnu-indirect-function \
		--enable-gnu-unique-object \
		--host=$CHOST \
		--build=$CHOST \
		--target=$CHOST

	if Fuse $USE_SHARED; then
		Fexec make  STAGE_CC_WRAPPER="$FCC" BOOT_CFLAGS="$CFLAGS" || Fdie
	else
		Fexec make all-gcc || Fdie
	fi

	if Fuse $USE_SHARED; then
		Fmakeinstall
	else
		Fexec make install-gcc DESTDIR=$Fdestdir || Fdie
	fi

	if [ -d $Fdestdir/usr/lib64 ]; then
               mv -f $Fdestdir/usr/lib64/* $Fdestdir/usr/lib/ || Fdie
               rm -rf $Fdestdir/usr/lib64 || Fdie
       fi


	# fix some junk in la files
	for lafile in `find $Fdestdir -name "*.la"`
        do
                sed -i 's|-L.*/gcc-build/.*/./gcc||g' $lafile
        done

	# symlinks for backward compatibility
	Fln gcc /usr/bin/cc
	Fln x86_64-frugalware-linux-gcc /usr/bin/x86_64-frugalware-linux-cc
	Fmkdir /lib
	Fln /usr/bin/cpp /lib/cpp

	gcchost="$CHOST"

	# libffi is internal don't expose it
	Frm usr/lib/libffi*
	Frm usr/lib/gcc/$gcchost/$gccver/include/ffi*
	Frm $Fmandir/man3/ffi\*


	if Fuse $USE_FORTRAN; then
		## 32bit
		Fsplit libquadmath usr/lib32/libquadmath.*
		Fsplit libgfortran usr/lib32/libgfortran.*

		Fln gfortran /usr/bin/f95
		# libquadmath
		Fsplit libquadmath usr/lib/libquadmath.*
		Fsplit libquadmath usr/share/info/libquadmath.info
		# libgfortran
		#Fsplit libgfortran usr/lib/gcc/$gcchost/$gccver/libgfortranbegin.*
		Fsplit libgfortran usr/lib/libgfortran.*
		# gcc-gfortran
		Fsplit gcc-gfortran usr/bin/{gfortran,$gcchost-gfortran,f95}
		Fsplit gcc-gfortran usr/share/man/man1/gfortran.1*
		Fsplit gcc-gfortran usr/share/info/gfortran*
		Fsplit gcc-gfortran usr/lib/gcc/$gcchost/$gccver/f951
	fi
	if Fuse $USE_OBJC; then

		## 32bit
		Fsplit libobjc usr/lib32/libobjc*
		# libobjc
		Fsplit libobjc usr/lib/gcc/$gcchost/$gccver/include/objc/
		Fsplit libobjc usr/lib/libobjc*
		# gcc-objc
		Fsplit gcc-objc usr/lib/gcc/$gcchost/$gccver/cc1obj
		# gcc-objc++
		Fsplit gcc-objc++ usr/lib/gcc/$gcchost/$gccver/cc1objplus
	fi
	if Fuse $USE_CXX; then

		## 32bit
		Fmv usr/lib32/libstdc++.*-gdb.py usr/share/gcc-$gccver/python/libstdcxx
		Fsplit libstdc++ usr/lib32/libstdc++.*
		Fsplit libstdc++ usr/lib32/libstdc++fs.*
		Fsplit gcc-g++ usr/lib32/libsupc++.*

		Fln g++ /usr/bin/c++
		# libstdc++
		Fsplit libstdc++ usr/include/c++/
		Fmv usr/lib/libstdc++.*-gdb.py usr/share/gcc-$gccver/python/libstdcxx
		Fsplit libstdc++ usr/lib/libstdc++.*
		## this is a experimental lib in 5.3++ .. only static
		Fsplit libstdc++ usr/lib/libstdc++fs.*
		Fsplit libstdc++ usr/share/locale/{de,fr}/LC_MESSAGES/libstdc++.mo
		#gcc-g++
		Fsplit gcc-g++ usr/share/gcc-$gccver/
		Fsplit gcc-g++ usr/bin/{,$gcchost-}{c++,g++}
		Fsplit gcc-g++ usr/lib/libsupc++.*
		Fsplit gcc-g++ usr/lib/gcc/$gcchost/$gccver/cc1plus
		Fsplit gcc-g++ usr/share/man/man1/g++.1
	fi
	if Fuse $USE_SHARED; then

		## 32bit
		Fsplit libgcc usr/lib32/libgcc_*
		Fsplit libssp usr/lib32/libssp*
		Fsplit libgomp usr/lib32/libgomp.*
		Fsplit libatomic usr/lib32/libatomic.*

		# libgcc
		Fsplit libgcc usr/lib/libgcc_*
		# libssp
		Fsplit libssp usr/lib/libssp*
		Fsplit libssp usr/lib/gcc/$gcchost/$gccver/include/ssp/
		# libgomp
		Fsplit libgomp usr/share/info/libgomp.info
		Fsplit libgomp usr/lib/gcc/$gcchost/$gccver/include/omp.h
		Fsplit libgomp usr/lib/libgomp.*
		# libatomic
		Fsplit libatomic usr/lib/libatomic.*
	fi


	## maybe llvm32 will need these too , not-so-sure :)
	for i in /usr/lib/gcc/$gcchost/$gccver/32/{crtbegin.o,crtend.o,libgcc.a}; do
		Fln $i /usr/lib32/$(basename $i)
	done

	cat stage1-gcc/specs > $Fdestdir/usr/lib/gcc/$gcchost/$gccver/32/specs || Fdie
	cat stage1-gcc/specs > $Fdestdir/usr/lib/gcc/$gcchost/$gccver/specs || Fdie

	# llvm needs these.
	for i in /usr/lib/gcc/$gcchost/$gccver/{crtbegin.o,crtend.o,libgcc.a}; do
		Fln $i /usr/lib/$(basename $i)
	done
}

# optimization OK
