# Compiling Time: 0.41 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=intel-graphics-compiler
pkgver=1.0.9636
_vg_intrinsics_ver=8ee879314584e6630688b0a3b290d065dcabb383
pkgrel=2
pkgdesc="Intel Graphics Compiler for OpenCL"
archs=("x86_64")
depends=('intel-opencl-clang>=13.0.0')
makedepends=('llvm>=13.0.0' 'llvm-static' 'clang' 'git' 'openmp' \
	'mlir' 'polly' 'libunwind' 'lld')
groups=('devel')
_F_github_author="intel"
_F_github_tag=y
_F_github_ver="igc-$pkgver"
_F_cmake_confopts="	-DCMAKE_BUILD_TYPE=Release \
		        -DCMAKE_INSTALL_PREFIX=/usr \
		        -DCMAKE_INSTALL_LIBDIR=lib \
		        -DIGC_OPTION__ARCHITECTURE_TARGET='Linux64' \
			-DIGC_OPTION__LLVM_PREFERRED_VERSION='13.0.0' \
		        -DINSTALL_GENX_IR=ON \
			-DVC_INTRINSICS_SRC="${Fsrcdir}/vc-intrinsics-${_vg_intrinsics_ver}" \
			-DIGC_OPTION__CLANG_MODE=Prebuilds \
			-DIGC_OPTION__LLD_MODE=Prebuilds \
			-DIGC_OPTION__LLVM_MODE=Prebuilds \
			-DIGC_OPTION__LINK_KHRONOS_SPIRV_TRANSLATOR=ON \
			-DIGC_OPTION__USE_KHRONOS_SPIRV_TRANSLATOR_IN_VC=ON \
			-DIGC_OPTION__SPIRV_TRANSLATOR_MODE=Prebuilds"
Finclude cmake github
up2date="$up2date | sed 's/igc-//g'"
source+=("https://github.com/intel/vc-intrinsics/archive/${_vg_intrinsics_ver}.zip" \
	libunwind.patch \
	include-fix.patch )
sha1sums=('dde62a9399aa4253d63ce9e74bfd2700776de350' \
          '5c3a84b8fe44c7169b8fb92e03189416073075f3' \
          'af3daf74a873e73757c33967c31d51f2e8ebdccc' \
          '663f65522fd49d3b5252956b0c129dfe4809200c')
_F_cd_path="intel-graphics-compiler-igc-$pkgver"
options=('nolto')

build() {
	Fexec git clone https://github.com/KhronosGroup/SPIRV-Tools.git || Fdie
	Fexec git clone https://github.com/KhronosGroup/SPIRV-Headers.git || Fdie
	CMake_build
}

# optimization OK
