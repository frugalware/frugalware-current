# Compiling Time: 4.74 SBU
# Maintainer: Marius Cirsta <mcirsta@frugalware.org>

pkgname=llvm
pkgver=13.0.0
pkgrel=2
gcc_ver=11.2
url="http://www.llvm.org"
pkgdesc="Low Level Virtual Machine (Compiler , Tools and Libs)"
depends=("libstdc++>=${gcc_ver}")
makedepends=('groff' 'libffi' 'python3-sphinx' 'ocaml-ctypes>=0.18' \
	'ocaml-findlib>=1.8.1' 'ncurses>=6.0-16' 'lib32-libffi' 'lib32-libxml2' \
	'python3-recommonmark' "libstdc++>=${gcc_ver}" 'binutils>=2.32' \
	'glibc>=2.34' "gcc>=${gcc_ver}" "python3-charset-normalizer")
rodepends=("$pkgname-libs")
groups=('devel')
archs=("x86_64")

_F_github_author=llvm
_F_github_name=llvm-project
_F_github_tag=yes
_F_github_grepv="rc1\|rc2\|rc3\|rc4\|init"
Finclude github
up2date="$up2date | sed 's/llvmorg-//'"
source=(https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/$pkgname-$pkgver.src.tar.xz)
_F_archive_ver="${pkgver}.src"
signatures=("${source[0]}.sig")

_F_cross32_delete=('usr/docs' 'usr/share' \
	'usr/lib/ocaml' 'usr/libexec/')
Finclude cross32 python

subpkgs+=("$pkgname-ocaml")
subdescs+=("OCaml bindings for LLVM")
subdepends+=("ocaml>=4.10.0")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('devel-extra')
subarchs+=("x86_64")

subpkgs+=("$pkgname-libs")
subdescs+=("LLVM shared libs")
subdepends+=("ncurses>=6.0-16 libedit>=20190324_3.1 libffi>=3.4")
subrodepends+=("")
subgroups+=('lib')
subarchs+=("x86_64")

subpkgs+=("lib32-${pkgname}-libs")
subdescs+=("LLVM shared libs (32-bit)")
subdepends+=("lib32-ncurses>=6.0-12 lib32-libedit>=20160903_3.1i lib32-libffi>=3.4")
subrodepends+=("")
subgroups+=('lib32-extra')
subarchs+=("x86_64")

subpkgs+=("lib32-${pkgname}")
subdescs+=("Low Level Virtual Machine (Compiler, Tools and Libs) (32-bit)")
subdepends+=("libstdc++>=${gcc_ver}")
subrodepends+=("")
subgroups+=('lib32-extra')
subarchs+=("x86_64")

subpkgs+=("${pkgname}-static")
subdescs+=("Low Level Virtual Machine (Compiler, Tools and Libs) (static)")
subdepends+=("")
subrodepends+=("")
subgroups+=('devel-extra')
subarchs+=("x86_64")

subpkgs+=("lib32-${pkgname}-static")
subdescs+=("Low Level Virtual Machine (Compiler, Tools and Libs) (32-bit static)")
subdepends+=("")
subrodepends+=("")
subgroups+=('lib32-extra')
subarchs+=("x86_64")

subpkgs+=("$pkgname-ocaml-static")
subdescs+=("OCaml bindings for LLVM (static)")
subdepends+=("")
subrodepends+=("")
subgroups+=('devel-extra')
subarchs+=("x86_64")


# Common CMake options
_F_cmake_type="Release"
_common_cmake_confopts="	-DCMAKE_INSTALL_PREFIX=/usr \
				-DLLVM_BUILD_LLVM_DYLIB=ON \
				-DLLVM_LINK_LLVM_DYLIB=ON \
				-DLLVM_ENABLE_RTTI=ON \
				-DLLVM_INSTALL_UTILS=ON \
				-DLLVM_ENABLE_FFI=ON \
				-DLLVM_BUILD_DOCS=ON \
				-DLLVM_ENABLE_SPHINX=OFF \
				-DLLVM_ENABLE_DOXYGEN=OFF \
				-DLLVM_HOST_TRIPLE=${CARCH}-frugalware-linux \
				-DLLVM_DEFAULT_TARGET_TRIPLE=${CARCH}-frugalware-linux \
				-DLLVM_BINUTILS_INCDIR=/usr/include"
Finclude cmake
options+=('static')
_Fbuild_no_patch=yes


build() {

	Fexec cd ${Fsrcdir}/llvm-${_F_archive_ver}


	Fcross32_prepare
	Fcross32_copy_source

	## 32-bit CMake options
	_F_cmake_confopts+="	${_common_cmake_confopts}
				-DLLVM_LIBDIR_SUFFIX=32 \
				-DCMAKE_CXX_FLAGS:STRING=-m32 \
				-DFFI_INCLUDE_DIR=$(pkg-config --cflags-only-I libffi | cut -c3-) \
				-DLLVM_TARGET_ARCH:STRING=i686"

	CMake_make

	Fexec make -C ../docs -f Makefile.sphinx man || Fdie
	Fexec make -C ../docs -f Makefile.sphinx html || Fdie

	Fexec make ocaml_doc
	CMake_install

	Fcross32_copy_back_source
	Fcross32_reset_and_fix
	Fcross32_delete_empty

	Fmkdir usr/i686-frugalware-linux/
	Fmv usr/include usr/i686-frugalware-linux/
	Fmv usr/bin usr/i686-frugalware-linux/


	Frm usr/include
	Fmkdir usr/bin/
	Fmv usr/i686-frugalware-linux/bin/llvm-config usr/bin/llvm-config32

	Fsplit lib32-$pkgname-libs usr/lib32/\*.so\*

	Fsplit lib32-$pkgname-static usr/lib32/*.a
	Fsplit lib32-$pkgname /\*

	## 64-bit CMake options
	_F_cmake_confopts="    ${_common_cmake_confopts} \
				-DFFI_INCLUDE_DIR=$(pkg-config --cflags-only-I libffi | cut -c3-)"

	Fcd

	CMake_make

	Fexec make -C ../docs -f Makefile.sphinx man || Fdie
	Fexec make -C ../docs -f Makefile.sphinx html || Fdie

	Fexec make ocaml_doc
	CMake_install

	## Lit
	Fexec cd ../utils/lit || Fdie
	Fexec  python3 setup.py install --root="$Fdestdir" -O1 || Fdie
	Fexec cd ../../$_F_cmake_build_dir || Fdie	

	## Python bindings
	Fmkdir ${_F_python_libdir}
	Fexec python -m compileall $Fdestdir/${_F_python_libdir}
	Fexec python -O -m compileall $Fdestdir/${_F_python_libdir}
	Fexec python -m compileall $Fdestdir/usr/share
	Fexec python -O -m compileall $Fdestdir/usr/share

        ## Pytho3n bindings
        Fmkdir ${_F_python3_libdir}
        Fexec python3 -m compileall $Fdestdir/${_F_python3_libdir}
        Fexec python3 -O -m compileall $Fdestdir/${_F_python3_libdir}
        Fexec python3 -m compileall $Fdestdir/usr/share
        Fexec python3 -O -m compileall $Fdestdir/usr/share

	# Install man pages
	Fmkdir usr/share/man/man1
	Fcp ${_F_cd_path}/docs/_build/man/*.1 usr/share/man/man1/


	# Install html docs
	Fmkdir usr/share/doc/$pkgname-$pkgver/html/
	Fcp ${_F_cd_path}/docs/_build/html/* usr/share/doc/$pkgname-$pkgver/html/
	Frm usr/share/doc/$pkgname-$pkgver/html/_sources

	# Install html docs of llvm-ocaml
	Fmkdir usr/share/doc/$pkgname-$pkgver/ocamldoc
	Fcp ${_F_cd_path}/${_F_cmake_build_dir}/docs/ocamldoc/html/* usr/share/doc/$pkgname-$pkgver/ocamldoc
	Frm usr/docs

	Fsplit $pkgname-ocaml-static usr/lib/ocaml/llvm/*.a
	Fsplit $pkgname-ocaml usr/lib/ocaml/
	Fsplit $pkgname-ocaml usr/lib/cmake/llvm/{Find,Add}OCaml.cmake

	Fsplit $pkgname-static usr/lib/*.a
	Fsplit $pkgname-libs usr/lib/*.so*
}

# optimization OK
