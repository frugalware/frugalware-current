Description: fix denial of service via XML expansion
Origin: backport, http://svn.ruby-lang.org/cgi-bin/viewvc.cgi?view=revision&revision=48161

Index: ruby1.9.1-1.9.3.484/lib/rexml/entity.rb
===================================================================
--- ruby1.9.1-1.9.3.484.orig/lib/rexml/entity.rb	2014-11-19 15:21:08.260737462 -0500
+++ ruby1.9.1-1.9.3.484/lib/rexml/entity.rb	2014-11-19 15:21:08.256737433 -0500
@@ -138,8 +138,14 @@
         matches = @value.scan(PEREFERENCE_RE)
         rv = @value.clone
         if @parent
+          sum = 0
           matches.each do |entity_reference|
             entity_value = @parent.entity( entity_reference[0] )
+            if sum + entity_value.bytesize > REXML.entity_expansion_text_limit
+              raise "entity expansion has grown too large"
+            else
+              sum += entity_value.bytesize
+            end
             rv.gsub!( /%#{entity_reference.join};/um, entity_value )
           end
         end
Index: ruby1.9.1-1.9.3.484/test/rexml/test_document.rb
===================================================================
--- ruby1.9.1-1.9.3.484.orig/test/rexml/test_document.rb	2014-11-19 15:21:08.260737462 -0500
+++ ruby1.9.1-1.9.3.484/test/rexml/test_document.rb	2014-11-19 15:21:44.180993222 -0500
@@ -47,6 +47,20 @@
 </member>
 EOF
 
+    XML_WITH_NESTED_PARAMETER_ENTITY = <<EOF
+<!DOCTYPE root [
+  <!ENTITY % a "BOOM.BOOM.BOOM.BOOM.BOOM.BOOM.BOOM.BOOM.BOOM.">
+  <!ENTITY % b "%a;%a;%a;%a;%a;%a;%a;%a;%a;%a;%a;%a;%a;%a;%a;">
+  <!ENTITY % c "%b;%b;%b;%b;%b;%b;%b;%b;%b;%b;%b;%b;%b;%b;%b;">
+  <!ENTITY % d "%c;%c;%c;%c;%c;%c;%c;%c;%c;%c;%c;%c;%c;%c;%c;">
+  <!ENTITY % e "%d;%d;%d;%d;%d;%d;%d;%d;%d;%d;%d;%d;%d;%d;%d;">
+  <!ENTITY % f "%e;%e;%e;%e;%e;%e;%e;%e;%e;%e;%e;%e;%e;%e;%e;">
+  <!ENTITY % g "%f;%f;%f;%f;%f;%f;%f;%f;%f;%f;%f;%f;%f;%f;%f;">
+  <!ENTITY test "test %g;">
+]>
+<cd></cd>
+EOF
+
   XML_WITH_4_ENTITY_EXPANSION = <<EOF
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE member [
@@ -83,6 +97,19 @@
     end
   ensure
     REXML::Document.entity_expansion_limit = 10000
+  end
+
+  def test_entity_expansion_limit_for_parameter_entity
+    assert_raise(REXML::ParseException) do
+      REXML::Document.new(XML_WITH_NESTED_PARAMETER_ENTITY)
+    end
+    REXML::Document.entity_expansion_limit = 100
+    assert_equal(100, REXML::Document.entity_expansion_limit)
+    assert_raise(REXML::ParseException) do
+      REXML::Document.new(XML_WITH_NESTED_PARAMETER_ENTITY)
+    end
+  ensure
+    REXML::Document.entity_expansion_limit = 10000
   end
 
   def test_tag_in_cdata_with_not_ascii_only_but_ascii8bit_encoding_source
Index: ruby1.9.1-1.9.3.484/test/rexml/test_entity.rb
===================================================================
--- ruby1.9.1-1.9.3.484.orig/test/rexml/test_entity.rb	2014-11-19 15:21:08.260737462 -0500
+++ ruby1.9.1-1.9.3.484/test/rexml/test_entity.rb	2014-11-19 15:21:08.256737433 -0500
@@ -122,6 +122,22 @@
     end
   end
 
+    def test_entity_string_limit_for_parameter_entity
+      template = '<!DOCTYPE bomb [ <!ENTITY % a "^" > <!ENTITY bomb "$" > ]><root/>'
+      len      = 5120 # 5k per entity
+      template.sub!(/\^/, "B" * len)
+
+      # 10k is OK
+      entities = '%a;' * 2 # 5k entity * 2 = 10k
+      REXML::Document.new(template.sub(/\$/, entities))
+
+      # above 10k explodes
+      entities = '%a;' * 3 # 5k entity * 2 = 15k
+      assert_raises(REXML::ParseException) do
+        REXML::Document.new(template.sub(/\$/, entities))
+      end
+    end
+
   def test_raw
     source = '<!DOCTYPE foo [
 <!ENTITY ent "replace">
