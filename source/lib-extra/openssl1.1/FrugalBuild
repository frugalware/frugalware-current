# Compiling Time: 0.84 SBU
# Contributor: Miklos Vajna <vmiklos@frugalware.org>
# Maintainer: crazy <crazy@frugalware.org>

pkgname=openssl1.1
pkgver=1.1.1
pkgextraver=u
pkgrel=4
pkgdesc="The Open Source toolkit for Secure Sockets Layer and Transport Layer Security"
url="http://www.openssl.org/source/"
groups=('lib-extra')
archs=('x86_64')
depends=('glibc>=2.35')
makedepends=('util-linux>=2.31.1-2' 'lib32-util-linux' 'gcc>=12.2')
backup=('etc/ssl/openssl.cnf')
_F_archive_grepv="3.0\|alpha\|beta\|3.1"
_F_archive_name="openssl"
up2date="Flasttar https://ftp.openssl.org/source/ "
source=($url${_F_archive_name}-$pkgver$pkgextraver.tar.gz http://caunter.ca/ssl.certs.shar)
_F_cross32_simple_auto="yes"
Finclude cross32
options+=('static')
sha1sums=('227f922048e132ca2d4181aabd34079cd82dd3be' \
          '18282d8ccf17b03631957823a93c9c001f576526')

build()
{

	Fcd
	# kill demoCA
	Fsed './demoCA' '/etc/ssl' apps/CA.pl.in
	Fsed './demoCA' '/etc/ssl' apps/openssl.cnf

	# Hack to build with openssl 3.x present
	LDFLAGS="$LDFLAGS -L$Fsrcdir/$_F_cd_path"

	# 32-Bit build
	Fcross32_prepare
	Fcross32_copy_source

	Fexec ./Configure	\
			--prefix=/usr \
			--openssldir=/etc/ssl \
			--libdir=lib32/openssl-1.1 \
			shared \
			linux-elf \
			no-unit-test \
			"-Wa,--noexecstack ${CPPFLAGS} ${CFLAGS} ${LDFLAGS}"

	Fexec make || Fdie
	Fexec make DESTDIR=$Fdestdir MANDIR=/usr/share/man MANSUFFIX=openssl install_sw || Fdie

	## fix up
	Fmkdir usr/$CHOST/{include,bin}
	Fmv usr/include/* usr/$CHOST/include/
	Fmv usr/bin/* usr/$CHOST/bin/
	Frm etc
	Frm usr/{bin,include,share}

	local i
	for i in libcrypto libssl openssl
	do
		Fsed "includedir=.*" "includedir=/usr/$CHOST/include" $Fdestdir/usr/lib32/openssl-1.1/pkgconfig/${i}.pc
	done

        Fmv usr/i686-frugalware-linux/include/openssl usr/i686-frugalware-linux/include/openssl-1.1/
        Fmv usr/lib32/openssl-1.1/libcrypto.so.1.1 usr/lib32/
        Fmv usr/lib32/openssl-1.1/libssl.so.1.1 usr/lib32/
        Fln ../libssl.so.1.1 usr/lib32/openssl-1.1/libssl.so
        Fln ../libcrypto.so.1.1 usr/lib32/openssl-1.1/libcrypto.so
        Fmv usr/i686-frugalware-linux/bin/openssl usr/i686-frugalware-linux/bin/openssl-1.1

        # Update includedir in .pc files
        Fexec sed -e 's|/include$|/include/openssl-1.1|' -i "$Fdestdir"/usr/lib32/openssl-1.1/pkgconfig/*.pc || Fdie
        Frm usr/i686-frugalware-linux/bin/c_rehash


	Fsplit "${subpkgs[0]}" /\*

	Fcross32_copy_back_source
	Fcross32_reset_and_fix

	## 64bit

	Fexec ./Configure       \
                        --prefix=/usr \
                        --openssldir=/etc/ssl \
                        --libdir=lib/openssl-1.1 \
                        shared \
                        linux-x86_64 \
                        "-Wa,--noexecstack ${CPPFLAGS} ${CFLAGS} ${LDFLAGS}"

        Fexec make || Fdie
        Fexec make DESTDIR=$Fdestdir MANDIR=/usr/share/man MANSUFFIX=openssl install_sw || Fdie


	Fmv usr/include/openssl usr/include/openssl-1.1/
	Fmv usr/lib/openssl-1.1/libcrypto.so.1.1 usr/lib/
	Fmv usr/lib/openssl-1.1/libssl.so.1.1 usr/lib/
	Fln ../libssl.so.1.1 usr/lib/openssl-1.1/libssl.so
	Fln ../libcrypto.so.1.1 usr/lib/openssl-1.1/libcrypto.so
	Fmv usr/bin/openssl usr/bin/openssl-1.1

	# Update includedir in .pc files
	Fexec sed -e 's|/include$|/include/openssl-1.1|' -i "$Fdestdir"/usr/lib/openssl-1.1/pkgconfig/*.pc || Fdie
	Frm /etc
	Frm /usr/bin/c_rehash
}


# optimization OK
