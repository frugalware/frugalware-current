# Compiling Time: 0.16 SBU
# Maintainer: DeX77 <dex77@frugalware.org>
# Contributorr: Karoly CZOVEK <slinky@rei.keni.hu>

pkgname=cyrus-sasl
pkgver=2.1.27
pkgrel=3
pkgdesc="SASL Authentication mechanism"
url="https://cyrusimap.org/"
depends=('openssl>=1.1.1' 'gdbm>=1.15' 'e2fsprogs>=1.42.13-4' 'libkrb5>=1.17-2')
makedepends=('postgresql>=11.2-2' 'krb5>=1.17-2' 'mariadb>=10.3.14' 'sqlite3>=3.14.2-3')
groups=('network')
archs=("x86_64")
source=(https://www.cyrusimap.org/releases/$pkgname-$pkgver.tar.gz \
		saslauthd.service \
		saslauthd \
		README.Frugalware )
_F_archive_grepv="rc"
up2date="Flasttar https://www.cyrusimap.org/releases/"
sha1sums=('fbfe6f298b0d2efcdab6a40bf47e16d003ae5dc6' \
          'dfcef142a649fcb2ca23b0c8532f6cd298e3ac3c' \
          '5fa8a4fd427eafd732eb9f539e7a7eeab44f234f' \
          'c0399d630d345237c7811b9fe6f5666c0ef818cf')




subpkgs=("$pkgname-sql" "$pkgname-gssapiv2" "saslauthd")
subdescs=("$pkgname mysql, postgresql and sqlite plugin." "$pkgname gssapiv2 plugin." \
	 "sasl authentication server")
subdepends=('mariadb-libs>=10.3.14 libpq>=11.2-2 e2fsprogs>=1.42.13-4' 'libkrb5>=1.17-2' 'libkrb5>=1.17-2 pam>=1.1.8-4')
subrodepends=("$pkgname>=$pkgver" "$pkgname>=$pkgver" "$pkgname>=$pkgver")
subgroups=('network' 'network' 'network')
subarchs=('x86_64' 'x86_64' 'x86_64')
subbackup=('' '' 'etc/sysconfig/saslauthd')
subinstall=('' '' 'saslauthd.install')



Fconfopts+="	\
		--enable-login \
		--enable-sql \
		--enable-plain \
		--disable-anon \
		--with-saslauthd=/run/courier \
		--with-pam \
		--with-dblib=gdbm \
		--with-gdbm=/usr \
		--with-pgsql=/usr/include"

_F_conf_notry="disable-static"

build()
{
	## strange strange!
	CFLAGS+=" -fno-strict-aliasing"
	export MAKEFLAGS="-j1"

	Fcd
	Fpatchall
	Fautoreconf
	Fconf
	make || Fdie
	Fmakeinstall

	Frm /usr/share/man/cat8

	## SQL's
	Fsplit $pkgname-sql usr/lib/sasl2/libsql.*

	## heimdal
	Fsplit $pkgname-gssapiv2 usr/lib/sasl2/libgssapiv2.*
	Fsplit saslauthd usr/sbin/*saslauthd
	Fsplit saslauthd usr/share/man/man8/saslauthd.*
	Finstall 0644 saslauthd etc/sysconfig/saslauthd
	Ffile /lib/systemd/system/saslauthd.service
	Fsplit saslauthd etc/sysconfig
	Fsplit saslauthd lib/systemd/system
	Frm /etc
	Fdoc README.Frugalware
}

# optimization ok
