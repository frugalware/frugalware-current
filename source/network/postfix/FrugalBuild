# Compiling Time: 0.70 SBU
# Maintainer: Karoly CZOVEK  <slinky@rei.keni.hu>
# Contributor: VMiklos <vmiklos@frugalware.org>
# Contributor: Krisztian VASAS <iron@frugalware.org>

pkgname=postfix
pkgver=2.4.1
pkgrel=1
vdaver=2.4.0
pkgdesc="A fast, easy to administer, and secure MTA"
url="http://www.postfix.org/"
depends=('db>=4.5.20' 'pcre' 'cyrus-sasl' 'libmysqlclient' 'libldap' 'libpq>=8.2-1')
makedepends=('openldap' 'mysql' 'postgresql')
provides=('mta')
conflicts=('sendmail')
groups=('network')
archs=('i686' 'x86_64')
backup=(etc/postfix/{aliases,aliases.db} \
	etc/postfix/{main.cf,master.cf,virtual,canonical,generic,transport})
install="$pkgname.install"

#up2date="lynx -dump $mirror/official/\?M=D|grep postfix-[0-9\.]*tar.gz$|sed -e 's|.*l/postfix-\(.*\)\.tar\.gz$|\1|'|sort -r |sed -e 'q'"
mirror="ftp://ftp.kfki.hu/pub/packages/mail/postfix"
up2date="lynx -dump $mirror/index.html|grep -m1 '.tar.gz'|sed 's/.*-\(.*\).tar.gz/\1/'"
source=($mirror/official/$pkgname-$pkgver.tar.gz \
	rc.$pkgname \
	http://vda.sourceforge.net/VDA/postfix-$vdaver-vda.patch.gz)

sha1sums=('cfd041cd7f16e9ee701c6e5a2f33e417e57751db'\
          'aef63e40eb4321f2cf7985983964e93e9c2a4cd0'\
          '0e1de0bb9de24ea9766d9930a945e3b94fc2a250')

APPLY_PATCH_VDA=${APPLY_PATCH_VDA:-1}
USE_FEATURE_SASL=${USE_FEATURE_SASL:-1}
USE_FEATURE_TLS=${USE_FEATURE_TLS:-1}
USE_BACKEND_MYSQL=${USE_BACKEND_MYSQL:-1}
USE_BACKEND_PGSQL=${USE_BACKEND_PGSQL:-1}
USE_BACKEND_LDAP=${USE_BACKEND_LDAP:-0}

build()
{
	if [ $USE_BACKEND_MYSQL -eq 1 ]; then
		msg "Building with mysql support"
		CCARGS="${CCARGS} -DHAS_MYSQL -I /usr/include/mysql "
		AUXLIBS="${AUXLIBS} -L/usr/lib/mysql -lmysqlclient "
	fi

	if [ $USE_BACKEND_MYSQL -eq 1 ]; then
		msg "Building with postgresql support"
		CCARGS="${CCARGS} -DHAS_PGSQL -I /usr/include/phsql "
		AUXLIBS="${AUXLIBS} -L/usr/lib/pgsql -lpq "
	fi

	if [ $USE_FEATURE_SASL -eq 1 ];	then
		msg "Building with sasl support"
		CCARGS="${CCARGS} -DUSE_SASL_AUTH -DUSE_CYRUS_SASL -I /usr/include/sasl"
		AUXLIBS="${AUXLIBS} -L/usr/lib -lm -lz -lsasl2"
	fi

	if [ $USE_FEATURE_TLS -eq 1 ]; then
		msg "Building with TLS support"
		CCARGS="${CCARGS} -DUSE_TLS"
	fi

	if [ $USE_BACKEND_LDAP -eq 1 ]; then
		msg "Building with LDAP support"
		CCARGS="${CCARGS} -DHAS_LDAP"
		AUXLIBS="${AUXLIBS} -lldap "		
	fi

	if [ $APPLY_PATCH_VDA -eq 1 ]; then
		Fpatch postfix-$vdaver-vda.patch
	fi
	
	Fcd
	make CCARGS="${CCARGS}" AUXLIBS="${AUXLIBS}" OPT="${CFLAGS}" makefiles
	make || return 1
	sh postfix-install -non-interactive \
		install_root="$Fdestdir" \
		daemon_directory="/usr/lib/$pkgname" \
		sample_directory="/etc/$pkgname/sample" \
		manpage_directory="/usr/man"
	# aliases
	Fsed '\(^#alias_maps = netinfo:/aliases$\)' '\1\nalias_maps = hash:/etc/postfix/aliases' $Fdestdir/etc/postfix/main.cf
	Fsed '\(^#alias_database = hash:/etc/aliases, hash:/opt/majordomo/aliases$\)' '\1\nalias_database = hash:/etc/postfix/aliases' $Fdestdir/etc/postfix/main.cf
	Frcd
	# For compatibility reasons - some app searches the sendmail
	# binary in /usr/lib
	Fln /usr/sbin/sendmail /usr/lib/sendmail
}

# vim: ft=sh
# optimalization OK
# optimization OK
