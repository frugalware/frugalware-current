#!/bin/sh

# (c) 2005-2006 Vajna Miklos <vmiklos@frugalware.org>
# wificonfig for Frugalware
# distributed under GPL License

TEXTDOMAIN=wificonfig
TEXTDOMAINDIR=/usr/share/locale/
conffile=/etc/sysconfig/wireless

### strings
setwifi=$"Wireless configuration"
setup=$"Setup"
finterface=$"Found interface:"
wifibacktitle="$setwifi - Frugalware `cat /etc/frugalware-release |sed 's/[^ ]* \(.*\) (.*/\1/'` $setup"

### functions
searchdev()
{
	dialog --backtitle "$wifibacktitle" --title $"Initializating" \
		--aspect 20 --infobox \
		$"Searching for interface with wireless extensions" 0 0
	sleep 1
	for dev in `sed '1 d; 2 d;s/\s*\(.*\):.*/\1/' /proc/net/dev`
	do
		if ! LC_ALL=C /usr/sbin/iwconfig $dev 2>&1 \
			|grep -q "no wireless extensions"; then
			dialog --backtitle "$wifibacktitle" \
				--title $"Success" --aspect 20 \
				--infobox "$finterface $dev" 0 0
			sleep 1
			found=1
			break
		fi
	done
}

nodev()
{
	dialog --backtitle "$wifibacktitle" --title $"Error" \
	--aspect 20 --msgbox $"No card with wireless extensions found." 0 0
	exit 0
}

searchap()
{
	cmd="/usr/sbin/iwlist $dev scan"
	if ! $cmd |grep -q "No scan results"; then
		pessid=`$cmd |grep ESSID|sed 's/.*"\(.*\)".*/\1/'`
	fi
}

ask_sg()
{
	afile=`mktemp /tmp/tmp.XXXXXX`
	dialog --backtitle "$wifibacktitle" --title "$1" \
		--inputbox "$2" 0 0 \
		"$3" 2>$afile || return 1
	eval $4=`cat $afile`
	rm $afile
}

write_conf()
{
	cat << EOF > $conffile
#
# /etc/sysconfig/wireless
# Wireless LAN adapter configuration
#

# Note : you don't need to fill all parameters, leave them blank, in most
# cases the driver will initialise itself with sane defaults values or
# automatically figure out the value... And no drivers do support all
# possible settings...

INFO=""
# ESSID (extended network name) : My Network, any
ESSID="$ESSID"
# NWID/Domain (cell identifier) : 89AB, 100, off
NWID="$NWID"
# Operation mode : Ad-Hoc, Managed, Master, Repeater, Secondary, auto
MODE="$MODE"
# Frequency or channel : 1, 2, 3 (channel) ; 2.422G, 2.46G (frequency)
FREQ="$FREQ"
CHANNEL="$CHANNEL"
# Sensitivity (cell size + roaming speed) : 1, 2, 3 ; -70 (dBm)
SENS="$SENS"
# Bit rate : auto, 1M, 11M
RATE="$RATE"
# Encryption key : 4567-89AB-CD, s:password
KEY="$KEY"
# RTS threshold : off, 500
RTS="$RTS"
# Fragmentation threshold : off, 1000
FRAG="$FRAG"
# Other iwconfig parameters : power off, ap 01:23:45:67:89:AB
IWCONFIG="$IWCONFIG"
# iwspy parameters : + 01:23:45:67:89:AB
IWSPY="$IWSPY"
# iwpriv parameters : set_port 2, set_histo 50 60
IWPRIV="$IWPRIV"
EOF
}

### main

searchdev # wireless device now is in $dev
[ "$found" ] || nodev
searchap
ask_sg $"Extended network name" $"What is your extended netwok name (ESSID)?\n\n \
Note: you don't need to fill all parameters, leave them blank, in most\n \
cases the driver will initialise itself with sane defaults values or\n \
automatically figure out the value... And no drivers do support all\n \
possible settings...\n\n \
Again, in most cases setting only the ESSID will be enough." "$pessid" ESSID
ask_sg $"NWID/Domain" $"What is your cell identifier (89AB, 100, off)?" \
	"" NWID
ask_sg $"Operation mode" $"What is your operation mode (Ad-Hoc, Managed, Master, Repeater, Secondary, auto)?" \
	"" MODE
ask_sg $"Frequency" $"What is your frequency (2.422G, 2.46G)?" \
	"" FREQ
ask_sg $"Channel" $"What is your channel (1, 2, 3)?" \
	"" CHANNEL
ask_sg $"Sensitivity" $"What is your cell size + roaming speed (1, 2, 3 ; -70 (dBm))?" \
	"" SENS
ask_sg $"Bit rate" $"What is your bit rate (auto, 1M, 11M)?" \
	"" RATE
ask_sg $"Encryption key" $"What is your encryption key (4567-89AB-CD, s:password)?" \
	"" KEY
ask_sg $"RTS threshold" $"What is your RTS threshold (off, 500)?" \
	"" RTS
ask_sg $"Fragmentation threshold" $"What is your fragmentation threshold (off, 1000)?" \
	"" FRAG
ask_sg $"Other parameters" $"Other iwconfig parameters (power off, ap 01:23:45:67:89:AB)?" \
	"" IWCONFIG
ask_sg $"iwspy parameters" $"Any iwspy parameters (+ 01:23:45:67:89:AB)?" \
	"" IWSPY
ask_sg $"iwpriv parameters" $"Any iwpriv parameters (set_port 2, set_histo 50 60)?" \
	"" IWPRIV
write_conf
dialog --backtitle "$wifibacktitle" --title $"Success" --aspect 20 \
--msgbox $"The wireless LAN adapter configuration completed successfully." 0 0
