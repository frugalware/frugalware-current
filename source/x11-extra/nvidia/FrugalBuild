# Compiling Time: 0.01 SBU
# Maintainer: Michel Hermier <hermier@frugalware.org>

pkgname=nvidia
pkgver=370.28
pkgrel=1
archs=('i686' 'x86_64')
_F_kernelmod_scriptlet=nvidia.install
Finclude kernel-module
groups=('x11-extra')
pkgdesc="3D accelerated display driver for Nvidia cards"
url="http://www.nvidia.com/object/unix.html"
up2date="Flastverdir http://download.nvidia.com/XFree86/Linux-x86/"
rodepends=("${rodepends[@]}" 'libvdpau>=1.1.1-2' 'nvidia-settings>=361.16' 'nvidia-xconfig>=361.16' 'pkgconfig' 'xorg-server>=1.18.0')
conflicts=("${conflicts[@]}" 'libgl' 'libgl-headers-mesa' 'libglx' 'libgles')
provides=("${provides[@]}" 'libgl' 'libgl-headers-mesa' 'libglx' 'libgles')
options=("${options[@]}" 'nostrip')

_F_nvidia_name=""
case "$CARCH" in
i686)
	_F_nvidia_name="NVIDIA-Linux-x86-${pkgver}"
	source=("http://us.download.nvidia.com/XFree86/Linux-x86/${pkgver}/${_F_nvidia_name}.run")
	sha1sums=('daaaab50b0b8e73f8f6990313685771096e0926a');;
x86_64)
	_F_nvidia_name="NVIDIA-Linux-${CARCH}-${pkgver}-no-compat32"
	source=("http://us.download.nvidia.com/XFree86/Linux-${CARCH}/${pkgver}/${_F_nvidia_name}.run" )
	sha1sums=('29b710d7aee6aa7624f87789a71fe17498184337');;
esac

source=("${source[@]}" \
	modprobe-nvidia.conf \
	xorg-nvidia.conf )

sha1sums=("${sha1sums[@]}" \
          	'a2bf63eb7dffdfc9268534654d3864e865af6834' \
		'15455cb16a6638ee348dc01620c7f64234178ac8')

build () {
	cd $Fsrcdir
	rm -rf ${_F_nvidia_name} || Fdie
	sh $_F_nvidia_name.run --extract-only || Fdie

	Fcd .

	cd $Fsrcdir/${_F_nvidia_name}
	Fpatchall

	# Build the kernel module
	Fexec cd $Fsrcdir/${_F_nvidia_name}/kernel || Fdie
	Fexec make SYSSRC=$_F_kernelmod_dir/build module || Fdie
	Ffilerel nvidia.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia.ko
	Ffilerel nvidia-modeset.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia-modeset.ko
	if [[ "$CARCH" = "x86_64" ]]; then
		Ffilerel nvidia-uvm.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia-uvm.ko
	fi
	Fbuild_kernelmod_scriptlet

	cd $Fsrcdir/${_F_nvidia_name} || Fdie

	# FIXME: Cuda and OpenCL headers are missing on the package on purpose

	# X driver
	Fmkdir /usr/lib/xorg/modules/drivers/
	Fexerel /usr/lib/xorg/modules/drivers/nvidia_drv.so

	# GLX extension module for X
	Fmkdir /usr/lib/xorg/modules/extensions/
	Fexerel /usr/lib/xorg/modules/extensions/libglx.so.$pkgver
	Fln libglx.so.$pkgver /usr/lib/xorg/modules/extensions/libglx.so
	Fexerel /usr/lib/libGLX_nvidia.so.$pkgver
	Fln libGLX_nvidia.so.$pkgver /usr/lib/libGLX_indirect.so.0

	# OpenGL library
	Fmkdir /usr/include/GL/
	Ffilerel gl.h /usr/include/GL/
	Fmkdir /usr/lib/
	Ffilerel /usr/lib/libGL.la
	Fexerel /usr/lib/libGL.so.$pkgver
	Fln libGL.so.$pkgver /usr/lib/libGL.so.1
	Fln libGL.so.1 /usr/lib/libGL.so

	# OpenGL core library
	Fexerel /usr/lib/libnvidia-glcore.so.$pkgver

	#EGL
	Fexerel /usr/lib/libEGL_nvidia.so.$pkgver
	Fexerel /usr/lib/libnvidia-eglcore.so.$pkgver

	#OpenGL ES
	Fexerel /usr/lib/libGLESv1_CM_nvidia.so.$pkgver
	Fexerel /usr/lib/libGLESv2_nvidia.so.$pkgver

	#GLSI
	Fexerel /usr/lib/libnvidia-glsi.so.$pkgver

	# CUDA
	Fexerel /usr/lib/libcuda.so.$pkgver
	Fexerel /usr/lib/libnvcuvid.so.$pkgver
	Fln libnvcuvid.so.$pkgver /usr/lib/libnvcuvid.so.1
	Fexerel /usr/lib/libnvidia-ml.so.$pkgver
	Fexerel /usr/lib/libnvidia-fatbinaryloader.so.$pkgver

	# nvidia-tls library
	Fexerel tls/libnvidia-tls.so.$pkgver /usr/lib/libnvidia-tls.so.$pkgver

	# OpenCL
	Fmkdir /etc/OpenCL/vendors/
	Ffilerel /etc/OpenCL/vendors/nvidia.icd
	Fexerel /usr/lib/libOpenCL.so.1.0.0
	Fln libOpenCL.so.1.0.0 /usr/lib/libOpenCL.so
	Fln libOpenCL.so.1.0.0 /usr/lib/libOpenCL.so.1
	Fexerel /usr/lib/libnvidia-cfg.so.$pkgver
	Fexerel /usr/lib/libnvidia-compiler.so.$pkgver
	Fexerel /usr/lib/libnvidia-opencl.so.$pkgver

	# Encode (no idea..)
	Fexerel /usr/lib/libnvidia-encode.so.$pkgver

	# Fbc (Frame buffer console?)
	Fexerel /usr/lib/libnvidia-fbc.so.$pkgver

	# GTK
	Fexerel /usr/lib/libnvidia-gtk2.so.$pkgver
	Fexerel /usr/lib/libnvidia-gtk3.so.$pkgver

	# IFR
	Fexerel /usr/lib/libnvidia-ifr.so.$pkgver

	# WFP
	Fexerel /usr/lib/libnvidia-wfb.so.$pkgver

	# nvidia-bug-report
	Fmkdir /usr/bin/
	Fexerel /usr/bin/nvidia-bug-report.sh
	# nvidia-smi
	Fexerel /usr/bin/nvidia-smi
	Fmkdir /usr/share/man/man1/
	Ffilerel /usr/share/man/man1/nvidia-smi.1.gz

	Fdocrel LICENSE README.txt html

	Ffile xorg-nvidia.conf /etc/X11/xorg.conf.d/15-nvidia.conf
	Ffile modprobe-nvidia.conf /etc/modprobe.d/nvidia.conf

	Fkernelver_compress_modules
}

# optimization OK
