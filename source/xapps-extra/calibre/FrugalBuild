# Compiling Time: 1.33 SBU
# Maintainer: Melko <melko@frugalware.org>

pkgname=calibre
pkgver=2.69.0
pkgrel=1
pkgdesc="Ebook management application"
url="http://calibre.kovidgoyal.net/"
depends=('python>=2.7' 'imagemagick>=6.8.9' 'xz>=5.0.3' 'libtool' 'libuuid>=2.28.2-2' 'poppler-glib>=0.47.0' \
	'chmlib>=0.40-5' 'icu4c' 'pyqt5>=5.7-2' 'python-dateutil' 'python-mechanize' 'lxml>=3.6.4' 'netifaces' \
	'podofo' 'imaging' 'python-sqlite3' 'cssutils' 'libmtp' 'python-cssselect' 'python2-apsw' \
	'python-six' 'qt5-webkit>=5.7.0-2' 'xdg-utils')
makedepends=('pycountry>=1.20-2' 'xdg-utils' 'qt5-x11extras>=5.7.0-2')
groups=('xapps-extra')
archs=('i686' 'x86_64')
Finclude python
options=('nostrip')
source=(https://github.com/kovidgoyal/calibre/releases/download/v${pkgver}/calibre-${pkgver}.tar.xz \
        $pkgname-ebook-viewer.desktop \
	$pkgname-gui.desktop \
	$pkgname-lrfviewer.desktop \
	$pkgname-viewer.png \
	$pkgname-lrf.png \
	$pkgname-gui.png \
	$pkgname.xml)
up2date="Flasttar https://github.com/kovidgoyal/calibre/releases .tar.xz"
sha1sums=('2f4aff1661f8f1476e6f368130423cf80c4d8919' \
          '1323d95691289b41e25fd191dc1d18f1c58e02d2' \
          'e7eb837ad8733ecb813b5f897484324cd7160426' \
          '2a675529ef6f034eb20bc48620802b60796d689d' \
          '816cabb72ffb9a94e28910a1a48507a3064f0b7e' \
          '55c454cf6aac258ff7663ead89883e3a721c8078' \
          '9e5b649495e42e1778a9a433eac630173a0069e2' \
          '03b4412f2acf256fd4478f2b94f024617c488e02')
build() {
	Fcd
	[ "$CARCH" == "x86_64" ] && CFLAGS="$CFLAGS -fPIC"
	Fpatchall
	Fmake

	CXXFLAGS+=" -Wno-deprecated -Wno-deprecated-declarations"

	## Wellllll
	export QMAKE_CXXFLAGS="$CXXFLAGS"
	export QMAKE_LFLAGS="$LDFLAGS"

#	python setup.py resources || Fdie
#	python setup.py translations || Fdie
	Fmkdir $_F_python_libdir
	#Fsed "(prefix=.*)" "(prefix='${Fdestdir}/usr')" setup/install.py
	## F*foo does not work here
	python setup.py install --staging-libdir=${Fdestdir}/usr/lib --staging-sharedir=${Fdestdir}/usr/share \
		--staging-root=${Fdestdir}/usr --prefix=/usr || Fdie

	# change env from python2 to _F_python_ver
	for i in $(ls $Fdestdir/usr/bin/ | grep -v mount-helper)
	do
		Fsed "/usr/bin/env python2" "/usr/bin/env python" $Fdestdir/usr/bin/$i
	done

	# install some missing stuff, hopefully this will be fixed soon
	Ffile /usr/share/applications/$pkgname-gui.desktop
	Ffile /usr/share/applications/$pkgname-ebook-viewer.desktop
	Ffile /usr/share/applications/$pkgname-lrfviewer.desktop
	Ffile /usr/share/pixmaps/$pkgname-gui.png
	Ffile /usr/share/pixmaps/$pkgname-viewer.png
	Ffile /usr/share/pixmaps/$pkgname-lrf.png
	Ffile /usr/share/mime/packages/$pkgname.xml
}

# optimization OK
