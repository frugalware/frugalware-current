# Compiling Time: 26.46 SBU
# Maintainer: Marius Cirsta <mcirsta@frugalware.org>

pkgname=chromium-browser
pkgver=64.0.3282.167
pkgrel=1
pkgdesc='Development version of Chromium browser'
url='http://www.chromium.org/'
depends=('nss>=3.21-3' 'libxscrnsaver>=1.2.2-2' 'libpulse>=7.1-4' 'snappy>=1.1.6' 'libcups' \
	'speech-dispatcher>=0.7.1-4' 'libxtst>=1.2.2-2' 'pango' 'atk' 'libxkbcommon' 'libxml2' \
	'libatomic' 'pciutils>=3.5' 'gtk+3' 'libxslt' 'libwebp>=0.6.0-3' 'libdrm' 'harfbuzz' 'libjpeg-turbo')
#using the built in ones for now
#depends+=('libevent>=2.0.22-3')
makedepends=('ninja' 'clang' 'yasm' 'libexif' 'gperf' 'libpthread-stubs' \
		'x11-protos' 'krb5' 'cups' 'gtk+2' 'python-ply' \
		'python-markupsafe' 'beautifulsoup4' 'html5lib-python' \
		'webencodings' 'protobuf-python' 'nodejs' 'mesa-dri-drivers')
license=('BSD')
groups=('xapps-extra')
archs=('x86_64')
_F_gnome_iconcache="y"
Finclude gnome-scriptlet
_F_archive_name="chromium"
up2date="lynx -dump 'http://chromium.woolyss.com/#stable-chromium-version' | \
	egrep -o '([0123456789.]*)/DEPS' | \
	egrep -o '([0123456789.]*)'"
source=(https://commondatastorage.googleapis.com/chromium-browser-official/chromium-${pkgver}.tar.xz \
        $pkgname.desktop \
        $pkgname.sh \
	chromium-last-commit-position-r1.patch \
	chromium-widevine.patch \
	chromium-angle-r0.patch \
	chromium-memcpy-r0.patch)
sha1sums=('5b6ef0c2a07185a169c2253355c0a8e77bc6b99d' \
          '264b8e7c4e3273263d504e041e5e4d152677922c' \
          '4c41d59b4d85a9f0443d6ca1dec456e50059dab5' \
          'd03e6465cd5a84580f9dad5d45f24ccd42bb71e6' \
          'c5719d06e0b39dfd3ca74f9f42684f4ee7584ade' \
          '36cf957bae0c15a029bb457ca9730c3cd2650d4c' \
          '15f9888f9656a61d76ee2dfe4b8a58506c80af2e')

chromium_path="chromium"

provides=('chromium-dev')
replaces=('chromium-dev')
conflicts=('chromium-dev')

CXXFLAGS+=" -Wno-deprecated -Wno-deprecated-declarations"
CFLAGS+=" -Wno-deprecated -Wno-deprecated-declarations"

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for Frugalware use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact dex77@frugalware.org for
# more information.
_google_api_key='AIzaSyDBY0Wxey1VCsW8fP6j7oJy_-ojnpYMh2o'
_google_default_client_id='63071405569.apps.googleusercontent.com'
_google_default_client_secret='2bNvMsN-57D44Q5ireW62LcZ'


build() {
	Fcd
	Fpatchall

	local keeplibs=(
		base/third_party/dmg_fp
		base/third_party/dynamic_annotations
		base/third_party/icu
		base/third_party/nspr
		base/third_party/superfasthash
		base/third_party/symbolize
		base/third_party/valgrind
		base/third_party/xdg_mime
		base/third_party/xdg_user_dirs
		chrome/third_party/mozilla_security_manager
		courgette/third_party
		net/third_party/mozilla_security_manager
		net/third_party/nss
		third_party/WebKit
		third_party/analytics
		third_party/angle
		third_party/angle/src/common/third_party/base
		third_party/angle/src/common/third_party/smhasher
		third_party/angle/src/third_party/compiler
		third_party/angle/src/third_party/libXNVCtrl
		third_party/angle/src/third_party/trace_event
		third_party/blink
		third_party/boringssl
		third_party/boringssl/src/third_party/fiat
		third_party/breakpad
		third_party/breakpad/breakpad/src/third_party/curl
		third_party/brotli
		third_party/cacheinvalidation
		third_party/catapult
		third_party/catapult/common/py_vulcanize/third_party/rcssmin
		third_party/catapult/common/py_vulcanize/third_party/rjsmin
		third_party/catapult/third_party/polymer
		third_party/catapult/tracing/third_party/d3
		third_party/catapult/tracing/third_party/gl-matrix
		third_party/catapult/tracing/third_party/jszip
		third_party/catapult/tracing/third_party/mannwhitneyu
		third_party/catapult/tracing/third_party/oboe
		third_party/catapult/tracing/third_party/pako
		third_party/ced
		third_party/cld_3
		third_party/crc32c
		third_party/cros_system_api
		third_party/devscripts
		third_party/dom_distiller_js
		third_party/fips181
		third_party/flatbuffers
		third_party/flot
		third_party/freetype
		third_party/glslang-angle
		third_party/google_input_tools
		third_party/google_input_tools/third_party/closure_library
		third_party/google_input_tools/third_party/closure_library/third_party/closure
		third_party/googletest
		third_party/hunspell
		third_party/iccjpeg
		third_party/inspector_protocol
		third_party/jinja2
		third_party/jstemplate
		third_party/khronos
		third_party/leveldatabase
		third_party/libXNVCtrl
		third_party/libaddressinput
		third_party/libjingle
		third_party/libphonenumber
		third_party/libsecret
		third_party/libsrtp
		third_party/libudev
		third_party/libwebm
		third_party/libxml/chromium
		third_party/libyuv
		third_party/lss
		third_party/lzma_sdk
		third_party/markupsafe
		third_party/mesa
		third_party/metrics_proto
		third_party/modp_b64
		third_party/mt19937ar
		third_party/node
		third_party/node/node_modules/polymer-bundler/lib/third_party/UglifyJS2
		third_party/openmax_dl
		third_party/ots
		third_party/pdfium
		third_party/pdfium/third_party/agg23
		third_party/pdfium/third_party/base
		third_party/pdfium/third_party/build
		third_party/pdfium/third_party/bigint
		third_party/pdfium/third_party/freetype
		third_party/pdfium/third_party/lcms
		third_party/pdfium/third_party/libopenjpeg20
		third_party/pdfium/third_party/libpng16
		third_party/pdfium/third_party/libtiff
		third_party/ply
		third_party/polymer
		third_party/protobuf
		third_party/protobuf/third_party/six
		third_party/qcms
		third_party/sfntly
		third_party/skia
		third_party/skia/third_party/gif
		third_party/skia/third_party/vulkan
		third_party/smhasher
		third_party/spirv-headers
		third_party/spirv-tools-angle
		third_party/sqlite
		third_party/swiftshader
		third_party/swiftshader/third_party/llvm-subzero
		third_party/swiftshader/third_party/subzero
		third_party/usrsctp
		third_party/vulkan
		third_party/vulkan-validation-layers
		third_party/web-animations-js
		third_party/webdriver
		third_party/webrtc
		third_party/widevine
		third_party/woff2
		third_party/zlib/google
		url/third_party/mozilla
		v8/src/third_party/valgrind
		v8/third_party/inspector_protocol
		base/third_party/libevent
		third_party/adobe
		third_party/speech-dispatcher
		third_party/usb_ids
		third_party/xdg-utils
		third_party/yasm/run_yasm.py
		third_party/tcmalloc
		third_party/ffmpeg
		third_party/opus
		third_party/re2
		third_party/openh264
		third_party/libvpx
		third_party/libvpx/source/libvpx/third_party/x86inc
		third_party/icu)
	# Remove most bundled libraries. Some are still needed.

	Fexec build/linux/unbundle/remove_bundled_libraries.py "${keeplibs[@]}" --do-remove || Fdie


	gn_system_libraries="
		flac
		libdrm
		libpng
		libwebp
		libxslt
		snappy
		yasm
		libxml
		zlib"

	Fexec build/linux/unbundle/replace_gn_files.py --system-libraries ${gn_system_libraries} || Fdie

	Fexec touch chrome/test/data/webui/i18n_process_css_test.html || Fdie

	Fexec third_party/libaddressinput/chromium/tools/update-strings.py || Fdie

	myconf_gn+=" is_debug=false"
	#   myconf_gn+=" is_debug=true"
	myconf_gn+=" enable_iterator_debugging=false"
	myconf_gn+=" enable_nacl=false"
	myconf_gn+=" remove_webcore_debug_symbols=true"

	myconf_gn+=" enable_hangout_services_extension=false"
	myconf_gn+=" enable_widevine=true"
	myconf_gn+=" use_allocator=\"tcmalloc\""
	myconf_gn+=" use_kerberos=true"
	myconf_gn+=" use_pulseaudio=true"
	myconf_gn+=" fieldtrial_testing_like_official_build=true"
	myconf_gn+=" is_clang=false"
	myconf_gn+=" clang_use_chrome_plugins=false"
	myconf_gn+=" linux_use_bundled_binutils=false"
	myconf_gn+=" use_gold=false use_sysroot=false"
	myconf_gn+=" proprietary_codecs=true "
	myconf_gn+=" use_gconf=false "
	myconf_gn+=" use_gio=false "
	myconf_gn+=" use_gnome_keyring=false"
	#   myconf_gn+=" use_ozone=true "
	myconf_gn+=" use_aura=true "
	myconf_gn+=" use_glib=true "
	myconf_gn+=" use_gtk3=true "
	myconf_gn+=" use_xkbcommon=true"
	#remoting needs gtk2 so we disable it, test if it still needs gtk2 and if not enable
	myconf_gn+=" enable_remoting=true "
	myconf_gn+=" use_system_libjpeg=true "
	myconf_gn+=" use_custom_libcxx=false "
	myconf_gn+=" use_system_harfbuzz=true"
	myconf_gn+=" enable_swiftshader=false "

	myconf_gn+=" ffmpeg_branding=\"Chrome\""

	myconf_gn+=" google_api_key=\"${_google_api_key}\""
	myconf_gn+=" google_default_client_id=\"${_google_default_client_id}\""
	myconf_gn+=" google_default_client_secret=\"${_google_default_client_secret}\""

	myconf_gn+=" treat_warnings_as_errors=false"
	myconf_gn+=" fatal_linker_warnings=false"
	myconf_gn+=" target_cpu=\"x64\""

	Fexec tools/gn/bootstrap/bootstrap.py -v --gn-gen-args "${myconf_gn}" || Fdie

	Fexec out/Release/gn gen --args="${myconf_gn}" out/Release || Fdie
	Fexec mkdir -p third_party/node/linux/node-linux-x64/bin || Fdie
	Fexec rm -rf third_party/node/linux/node-linux-x64/bin/node
	Fexec ln -s /usr/bin/node third_party/node/linux/node-linux-x64/bin/

	Fexec ninja -C out/Release chrome chrome_sandbox chromedriver widevinecdmadapter || Fdie

	Fmkdir usr/lib/${chromium_path}
        Fexerel out/Release/chrome usr/lib/${chromium_path}/chromium
        Finstallrel 4755 out/Release/chrome_sandbox usr/lib/${chromium_path}/chrome-sandbox
	Ffileschown usr/lib/${chromium_path}/chrome-sandbox root root

	Fcprel out/Release/\*.pak usr/lib/${chromium_path}/
	Fcprel out/Release/locales usr/lib/${chromium_path}/
	Fcprel out/Release/resources usr/lib/${chromium_path}/

	Fcprel out/Release/icudtl.dat usr/lib/${chromium_path}/

        find $Fdestdir/usr/lib/${chromium_path}/ -name '*.d' -type f -delete

        Finstall 644 $pkgname.desktop usr/share/applications/$pkgname.desktop

	local size size2
	for size in 22 24 48 64 128 256; do
		Finstallrel 644 "chrome/app/theme/chromium/product_logo_$size.png" \
		"usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
	done

	for size2 in 16 32; do
		Finstallrel 644 "chrome/app/theme/default_100_percent/chromium/product_logo_$size2.png" \
		"usr/share/icons/hicolor/${size2}x${size2}/apps/$pkgname.png"
	done

	Finstallrel 644 out/Release/natives_blob.bin usr/lib/${chromium_path}
	Finstallrel 644 out/Release/snapshot_blob.bin usr/lib/${chromium_path}
	Finstallrel 644 out/Release/chromedriver usr/lib/${chromium_path}
	Finstallrel 644 out/Release/libwidevinecdmadapter.so usr/lib/${chromium_path}

	Fdirschmod usr/lib/${chromium_path}/locales 755

        Fexe $pkgname.sh usr/bin/$pkgname

        Fdocrel LICENSE
	Fbuild_gnome_scriptlet
}

# optimization OK
