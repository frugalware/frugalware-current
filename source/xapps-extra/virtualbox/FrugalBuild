# Compiling Time: 3.03 SBU
# Maintainer: AlexExtreme <alex@alex-smith.me.uk>

pkgname=virtualbox
realname=VirtualBox
pkgver=1.3.8
pkgrel=4
pkgdesc="InnoTek VirtualBox is a family of powerful x86 virtualization products for enterprise as well as home use."
url="http://www.virtualbox.org"
Finclude kernel-module
depends=(${depends[@]} 'gcc' 'xerces-c' 'xalan-c' 'iasl' 'dev86' 'libxslt' 'libxcursor' 'qt' 'libidl' 'sdl' 'libstdc++5')
# For get-vbox-additions
rodepends=('wget')
groups=('xapps-extra')
archs=('i686' '!x86_64')
up2date="lynx -dump http://www.virtualbox.org/wiki/Downloads | grep 'OSE tarball' | sed 's/.*VirtualBox //' | sed 's/ OSE.*//'"
source=(http://www.virtualbox.org/download/$pkgver/$realname-OSE-$pkgver.tar.bz2 \
	vboxsvc virtualbox rc.virtualbox vbox.png get-vbox-additions README.Frugalware)
sha1sums=('2769c1064fb21d6a37d7588fa0b9b6f73309ac43' \
	  'e32ebff11bb235b50f8826b70d85dbcf4a56aee4' \
	  '3c0c856b9ad5f186405e87cf6eac09f1060b62cd' \
	  'f27e692f67846fe3981a9620a364789fc49a9384' \
	  'cfdab4db1c1ae3f589e2debd551a46060cc66fd0' \
	  '8d4e92a9529c83e9d580c672981844341cf63105' \
	  '5549ef89ac8abaa3a070e82cc830df931a9cb97a')
_F_cd_path="vbox-ose-$pkgver"
install=$pkgname.install
options=('scriptlet' 'force')

_F_desktop_name="$realname"
_F_desktop_desc="InnoTek VirtualBox virtualization program"
_F_desktop_icon="vbox.png"
_F_desktop_exec="virtualbox"
_F_desktop_categories="System;"

build() {
	Fcd
	
	# frugalware-buildfix.patch: fix the paths to some stuff on configure
	Fpatchall
	
	# Configure and load our options
	./configure \
		--with-xalan="-lxalan-c -pthread" \
		--with-xerces="-lxerces-c -pthread" \
		--with-qt-dir="/usr/lib/qt" || Fdie
	source ./env.sh || Fdie
	
	# Build verbose so we can see what this *nice* kmk is doing ... -- crazy --
	kmk KBUILD_VERBOSE=2 all || Fdie
	
	# Kernel module 
	# Always create the dirs before 'make ...' because there is a check to test the dirs
	# Anyway this is a 'chroot|cross building' problem only -- crazy --  
	Fmkdir ${_F_kernelmod_dir}/kernel/misc
	cd out/linux.x86/release/bin/src || Fdie
	make KERN_DIR=${_F_kernelmod_dir}/build MODULE_DIR_TST=$Fdestdir/${_F_kernelmod_dir} \
		MODULE_DIR=${Fdestdir}/${_F_kernelmod_dir}/kernel/misc || Fdie
	make KERN_DIR=${_F_kernelmod_dir}/build MODULE_DIR_TST=$Fdestdir/${_F_kernelmod_dir} \
		MODULE_DIR=${Fdestdir}/${_F_kernelmod_dir}/kernel/misc INSTALL_MOD_PATH=$Fdestdir install || Fdie
	
	# Install it
	cd $Fsrcdir/$_F_cd_path/out/linux.x86/release/bin || Fdie
	Fmkdir /usr/lib/VirtualBox
	rm -rf sdk src tst* testcase additions/src || Fdie
	rm -f vboxdrv.ko SUPInstall SUPUninstall || Fdie
	cp -R * $Fdestdir/usr/lib/VirtualBox/
	for each in VBox{BFE,Manage,SDL,SVC,XPCOMIPCD} VirtualBox vditool xpidl additions/vboxadd-timesync ; do
		chmod 0755 $Fdestdir/usr/lib/VirtualBox/${each}
	done
	
	# Install the wrappers
	Fexerel $Fsrcdir/vboxsvc /usr/bin/vboxsvc
	Fexerel $Fsrcdir/virtualbox /usr/bin/virtualbox
	Fexerel $Fsrcdir/get-vbox-additions /usr/bin/get-vbox-additions
	
	# Desktop file
	Ffilerel $Fsrcdir/vbox.png /usr/share/pixmaps/vbox.png
	Fdesktop2
	
	# Finally, the init script
	Frcd2
}
