# Compiling Time: 13.15 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=vscode
pkgver=1.73.1
pkgrel=1
pkgdesc="The Open Source build of Visual Studio Code (vscode) editor"
groups=('xapps-extra')
makedepends=('yarn' 'gulp' 'x11-protos' 'nodejs16' 'git')
depends=('libxkbfile' 'ffmpeg' 'libsecret' 'ripgrep')
archs=('x86_64')
_F_github_tag=y
_F_github_author="microsoft"
_F_scm_type="git"
_F_scm_url="https://github.com/microsoft/vscode.git"
_F_scm_tag="$pkgver"
Finclude scm github
source=(product_json.patch)
sha1sums=('a1d10400551bbb33c704f7d0ebc4d331741232d9')

build(){
	export NODE_OPTIONS=--openssl-legacy-provider
	Funpack_scm

	Fcd
	Fexec sed -i 's|/usr/share/@@NAME@@/@@NAME@@|@@NAME@@|g
          s|@@NAME_SHORT@@|Code|g
          s|@@NAME_LONG@@|Code - OSS|g
          s|@@NAME@@|code-oss|g
          s|@@ICON@@|com.visualstudio.code.oss|g
          s|@@EXEC@@|/usr/bin/code-oss|g
          s|@@LICENSE@@|MIT|g
          s|@@URLPROTOCOL@@|vscode|g
          s|inode/directory;||' resources/linux/code{.appdata.xml,.desktop,-url-handler.desktop} || Fdie

	Fexec sed -i 's|MimeType=.*|MimeType=x-scheme-handler/code-oss;|' resources/linux/code-url-handler.desktop || Fdie

	Fpatchall

	Fexec yarn || Fdie
	Fexec gulp vscode-linux-x64-min --max_old_space_size=8192 || Fdie
	Fmkdir usr/share/
	Fcp VSCode-linux-x64 usr/share/$pkgname
	Fln /usr/share/$pkgname/bin/code-oss usr/bin/code-oss

	Finstallrel 644 resources/linux/code.appdata.xml /usr/share/metainfo/code-oss.appdata.xml
	Finstallrel 644 resources/linux/code.desktop /usr/share/applications/code-oss.desktop
	Finstallrel 644 resources/linux/code-url-handler.desktop /usr/share/applications/code-oss-url-handler.desktop
	Finstall 644 VSCode-linux-x64/resources/app/resources/linux/code.png /usr/share/pixmaps/code-oss.png

}


# optimization OK
