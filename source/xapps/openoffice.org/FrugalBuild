# Compiling time: 262.13 SBU
# Maintainer: Janos Kovacs <janny@frugalware.org>
# Contributor: Laszlo Dvornik <dvornik@gnome.hu>

pkgname=openoffice.org
USE_DEVEL=${USE_DEVEL:-"n"}
if ! Fuse $USE_DEVEL; then
	upstream=3.2.1
	branch=-3-2-1
	tree=ooo320
	milestone=19
	pkgver=$upstream
	pkgrel=4
	snapshot=4-23-ge68b7f9
else
	upstream=3.2.1
	branch=-3-2-1
	tree=ooo320
	milestone=19
	pkgver=$upstream${tree}_m$milestone
	pkgrel=1
	snapshot=3-16-gc38220b
fi
pkgdesc="OpenOffice.org, a full office productivity suite."
url="http://www.openoffice.org/"
_F_gnome_desktop="y"
Finclude gnome-scriptlet mono java kde
install=openoffice.org.install
depends=('libxml2' 'libart_lgpl' 'libsndfile' 'libgcj-awt>=4.4.0-2' 'nas' 'fontconfig' 'libpng>=1.4.1' 'imagemagick' \
	 'flex' 'neon>=0.26.1' 'bison' 'zip' 'unzip' 'expat' 'cups' 'desktop-file-utils' 'perl-archive-zip' \
	 'unixodbc' 'libxaw>=1.0.5' 'libxslt' 'startup-notification>=0.9-3' 'libwpd>=0.8.13' 'poppler')
# this is here as gstreamer is only a makedepend
rodepends=('flac' 'dejavu-ttf')
makedepends=('curl>=7.20.0-2' 'intltool' 'tcsh' 'pam-headers' 'apache-ant' \
	     'boost' 'icu' 'hunspell' 'imake' 'gccmakedep' 'xalan-j' \
	     'patch>=2.5.9' 'openclipart' 'xorg-server' 'gstreamer' 'gst-plugins-base' \
	     'procps' 'openldap' 'gperf' 'xulrunner' 'kdelibs-compiletime' 'libwps' \
	     'libwpg' 'mdbtools' 'mdds')
groups=('xapps')
archs=('i686' 'x86_64')
if ! Fuse $USE_DEVEL; then
	up2date="lynx -dump http://download.openoffice.org/source/|grep Source|sed 's/.* \(.*\) .*/\1/;q'"
else
	up2date="lynx -source -dump http://cgit.freedesktop.org/ooo-build/ooo-build/plain/configure.in?h=ooo-build$branch |grep ^DEFAULT_TAG|sed 's/DEFAULT_TAG=\(.*\)-\(.*\)/$upstream\1_\2/'"
fi
source=(http://ftp.frugalware.org/pub/other/sources/ooo-build/ooo-build$branch-$snapshot.tar.bz2 http://git.frugalware.org/tarballs/openoffice.org/$tree-m$milestone-{artwork,base,bootstrap,calc,components,extras,filters,help,impress,libs-gui,libs-core,libs-extern,postprocess,sdk,testing,ure,writer,libs-extern-sys,extensions,l10n}.tar.bz2)
signatures=($source.asc '' '' '' '' '' '' '' '' '' '' '' '' '' '' '' '' '' '' '' '')
NOEXTRACT=1
options=(${options[@]} 'scriptlet')

subpkgs=("$pkgname-kde" "$pkgname-gnome" "$pkgname-sdk" "$pkgname-mono" "$pkgname-mozilla")
subdescs=("$pkgname kde integration" "$pkgname gnome integration" \
	"The OpenOffice.org Software Development Kit" "$pkgname mono integration" \
	"$pkgname mozilla integration")
subdepends=("kdelibs>=$_F_kde_ver" \
	"gnome-vfs libbonobo evolution-data-server-ldap" \
	"java-gcj-compat ecj gcc-gcj" \
	"mono" \
	"")
subrodepends=("$pkgname=$pkgver" \
	"$pkgname=$pkgver" \
	"$pkgname=$pkgver" \
	"$pkgname=$pkgver" \
	"$pkgname=$pkgver")
subarchs=('i686 x86_64' 'i686 x86_64' 'i686 x86_64' 'i686 x86_64' 'i686 x86_64')
subgroups=('kde-extra' 'gnome-extra' 'devel-extra' 'devel-extra' 'xapps')
subinstall=("" "$_F_gnome_scriptlet" "" "" "")

ooodicts="af cs da de es et fr gl hu it lt ne nl pl pt ru sk sl sr sv sw th vi zu ca he ro"
ooosubpkgs=('de' 'es' 'fr' 'hu')
ooosubdescs=('German' 'Spanish' 'French' 'Hungarian')
if ! Fuse $USE_DEVEL; then
	ooosubpkgs=(${ooosubpkgs[@]} 'af' 'ar' 'be-BY' 'bg' 'bn' 'bn-BD' 'bn-IN' 'br' 'bs' 'ca' 'cy' 'cs' 'da' 'el' 'en-GB' 'en-ZA' 'eo' 'et' 'eu' 'fi' 'ga' 'gl' 'gu-IN' 'he' 'hi-IN' 'hr' 'it' 'ja' 'km' 'kn-IN' 'ko' 'lo' 'lt' 'lv' 'mk' 'ms' 'nb' 'ne' 'nl' 'nn' 'nr' 'ns' 'pa-IN' 'pl' 'pt' 'pt-BR' 'ru' 'rw' 'sh-YU' 'sk' 'sl' 'sr-CS' 'ss' 'st' 'sv' 'sw' 'sw-TZ' 'sx' 'ta-IN' 'th' 'tn' 'tr' 'ts' 've' 'vi' 'xh' 'zh-CN' 'zh-TW' 'zu' 'fa' 'ku' 'as-IN' 'ml-IN' 'mr-IN' 'or-IN' 'te-IN' 'tg' 'ti-ER' 'uk' 'ur-IN' 'dz' 'ka' 'kn' 'sh' 'sr' 'uz' 'by' 'gd' 'gu' 'mn' 'my' 'oc' 'brx' 'dgo' 'kk' 'kok' 'ks' 'mai' 'mni' 'ro' 'sa-IN' 'sat' 'sc' 'sd' 'bo' 'is' 'kid' 'ky' 'om' 'pap' 'ps' 'si' 'ug')
	ooosubdescs=(${ooosubdescs[@]} 'Afrikaans' 'Arabic' 'Belarusian' 'Bulgarian' 'Bengali' 'Bengali (Bangladesh)' 'Bengali (India)' 'Breton' 'Bosnian' 'Catalan' 'Welsh' 'Czech' 'Danish' 'Greek' 'English (GB)' 'English (South Africa)' 'Esperanto' 'Estonian' 'Basque' 'Finnish' 'Irish' 'Galician' 'Gujarati' 'Hebrew' 'Hindi' 'Croatian' 'Italian' 'Japanese' 'Khmer (Cambodia)' 'Kannada' 'Korean' 'Lao' 'Lithuanian' 'Latvian' 'Macedonian' 'Malay' 'Norwegian Bokmal' 'Nepali' 'Dutch' 'Norwegian Nynorsk' 'Ndebele, South' 'NorthernSotho/Sepedi' 'Punjabi' 'Polish' 'Portuguese' 'Brazil (Port.)' 'Russian' 'Kinyarwanda' 'Serbian Latin' 'Slovak' 'Slovenian' 'Serbian Cyrillic' 'Swati' 'Sotho' 'Swedish' 'Swahili' 'Swahili ' 'South Georgian' 'Tamil' 'Thai' 'Tswana' 'Turkish' 'Tsonga' 'Venda' 'Vietnamese' 'Xhosa' 'Chinese (simplified)' 'Chinese (traditional)' 'Zulu' 'Persian' 'Kurdish' 'Assamese' 'Malayalam' 'Marathi' 'Oriya' 'Telugu' 'Tajik' 'Tigrinya' 'Ukrainian' 'Urdu' 'Dzongkha' 'Georgian' 'Kannada' 'Serbo-Croatian' 'Serbian' 'Uzbek' 'Belarussian' 'Scottish Gaelic' 'Gujarati' 'Mongolian' 'Malay' 'Occitan' 'Bodo' 'Dogri' 'Kazakh' 'Konkani' 'Kashmiri' 'Maithili' 'Manipuri' 'Romanian' 'Sanskrit' 'Santali' 'Sardinian' 'Sindhi' 'Tibetan' 'Icelandic' 'Kid' 'Ky' 'Afan Oromo' 'Pap' 'Pashto' 'Sinhala' 'Uyghur')
fi

if [ ${#ooosubpkgs[@]} -ne ${#ooosubdescs[@]} ]; then
	error '${#ooosubpkgs[@]} != ${#ooosubdescs[@]}'
	Fdie
fi

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
	subpkgs=("${subpkgs[@]}" "openoffice.org-i18n-`echo ${ooosubpkgs[$i]}|tr [A-Z] [a-z]`")
	subdescs=("${subdescs[@]}" "${ooosubdescs[$i]} Localization for OpenOffice.org.")
	i=$(($i+1))
done

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
	if echo "$ooodicts"|grep -q ${ooosubpkgs[$i]}; then
		subinstall=("${subinstall[@]}" "openoffice.org-i18n-${ooosubpkgs[$i]}.install")
	else
		subinstall=("${subinstall[@]}" '')
	fi
	i=$(($i+1))
done

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
        subdepends=("${subdepends[@]}" "")
        subrodepends=("${subrodepends[@]}" "openoffice.org>=$pkgver")
        subgroups=("${subgroups[@]}" "locale-extra")
        subarchs=("${subarchs[@]}" "i686 x86_64")
        i=$(($i+1))
done

dictpath="/usr/lib/openoffice.org/share/extension/install"
gen_dict_scriptlet()
{
	lang=$1
	out=$2
	cat >${Fsrcdir%/src}/$out <<EOF
post_install()
{
	unopkg add --shared $dictpath/dict-$lang.oxt 2>/dev/null
}

pre_upgrade()
{
	pre_remove
}

post_upgrade()
{
	post_install
}

pre_remove()
{
	unopkg remove --shared \$(unopkg list --shared|grep "^Identifier: org.openoffice.$lang"|sed 's/Identifier: //')
}

op=\$1
shift
\$op \$*
EOF
}

build()
{
	Fmonoexport
	Fextract ooo-build$branch-$snapshot.tar.bz2
	Fcd ooo-build$branch-$snapshot
	#cp -fv $Fsrcdir/mono24-hack patches/hotfixes/mono24-hack.diff || Fdie

	# Predownloaded tarballs
	for i in $Fsrcdir/$tree-m$milestone-*
	do
		ln -sf $i src/
	done

	# Generate the dict scriptlets
	gen_dict_scriptlet en openoffice.org.install
	for i in $ooodicts
	do
		gen_dict_scriptlet $i openoffice.org-i18n-$i.install
	done

	Fpatchall

	# SMP build
	if [ ! -z "$MAKEFLAGS" ]; then
		# Comment this out if you think the build failed because of being SMP.
		Fconfopts="$Fconfopts --with-num-cpus=${MAKEFLAGS/-j}"
		unset MAKEFLAGS
	fi

	# Other options.
	Fconfopts="$Fconfopts \
		--with-distro=Frugalware \
		--with-tag=$tree-m$milestone \
		--with-gcc-speedup=ccache \
		--with-openclipart=/usr/share/openclipart \
		--with-binsuffix=no \
		--with-installed-ooo-dirname=openoffice.org\
		--disable-odk \
		--without-git \
		--with-system-cairo \
		--with-system-libwpd \
		--with-system-libwps \
		--with-system-libwpg \
		--with-system-mdbtools \
		--with-system-mdds"

	# Set our version.
	Fsed "AC_PACKAGE_VERSION" "$pkgver-$pkgrel" configure.in
	autoconf || return 1

	# Optimize build.
	export ARCH_FLAGS="$CFLAGS"

	if ! Fuse $USE_DEVEL; then
		Fconf --with-lang=ALL
	else
		Fconf --with-lang="en-US de es fr hu"
	fi

	./download || return 1

	make || return 1

	Fmakeinstall

	# Permission fixes
	find $Fdestdir/usr/lib/openoffice.org/program -name "*.so" ! -perm 755 -exec chmod 755 {} \;

	# Fix invalid hardwired mktemp path in unopkg
	Fsed /bin/mktemp mktemp $Fdestdir/usr/lib/openoffice.org/program/unopkg

	# Enable and split the mozilla plugin
	Fmkdir /usr/lib/mozilla/plugins
	Fln /usr/lib/openoffice.org/program/libnpsoplugin.so /usr/lib/mozilla/plugins/
	Fsplit openoffice.org-mozilla usr/lib/openoffice.org/basis-link/program/nsplugin \
		usr/lib/mozilla/plugins/libnpsoplugin.so \
		usr/lib/openoffice.org/program/libnpsoplugin.so

	# Split out the i18n stuff
	for i in "${ooosubpkgs[@]}"
	do
		# en-GB -> en-gb
		spkg=`echo $i|tr [A-Z] [a-z]`
		# en-GB -> en_GB
		upkg=`echo $i|sed 's/-/_/g'`
		for j in $(grep -v '^%dir' build/lang_${upkg}_list.txt)
		do
			if [ -e $Fdestdir/$j ]; then
				Fsplit openoffice.org-i18n-$spkg $j
			fi
		done
		rm build/lang_${upkg}_list.txt
		if [ "$i" = "de" ]; then
			Fsplit openoffice.org-i18n-$spkg $dictpath/dict-de-AT.oxt
			Fsplit openoffice.org-i18n-$spkg $dictpath/dict-de-CH.oxt
			Fsplit openoffice.org-i18n-$spkg $dictpath/dict-de-DE.oxt
		elif [ "$i" = "nb" ]; then
			Fsplit openoffice.org-i18n-$spkg $dictpath/dict-no.oxt
		elif [ "$i" = "ku" ]; then
			Fsplit openoffice.org-i18n-$spkg $dictpath/dict-ku-TR.oxt
		elif echo "$ooodicts"|grep -q $i && [ -e $Fdestdir/$dictpath/dict-$i.oxt ]; then
			Fsplit openoffice.org-i18n-$spkg $dictpath/dict-$i.oxt
		fi
	done

	## Split KDE stuff
	Fsplit $pkgname-kde $(grep -v '^%dir' build/kde4_list.txt)
	rm build/kde4_list.txt
	# We don't want a kde3 subpackage (but in case it's not empty
	# something is broken, so check for it)
	[ -e build/kde_list.txt -a ! -s build/kde_list.txt ] && rm build/kde_list.txt

	## Split GNOME stuff
	Fsplit $pkgname-gnome $(grep -v '^%dir' build/gnome_list.txt)
	rm build/gnome_list.txt
	Fbuild_gnome_scriptlet

	# Split SDK
	Fsplit $pkgname-sdk $(grep -v '^%dir' build/sdk_list.txt)
	rm build/sdk_list.txt
	Fsplit $pkgname-sdk $(grep -v '^%dir' build/sdk_doc_list.txt)
	rm build/sdk_doc_list.txt

	# Split Mono
	Fsplit $pkgname-mono $(grep -v '^%dir' build/mono_list.txt)
	rm build/mono_list.txt

	# Check for missing language packs.
	misslangs="`find $Fdestdir -type f |grep registry/res/.*/org|sed 's|.*registry/res/\(.*\)/org.*|\1|'|grep -v en-US |sort -u`"
	if [ -n "$misslangs" ]; then
		Fmessage "Unsplitted languages: $misslangs"
		return 1
	fi

	if ! Fuse $USE_DEVEL; then
		# Check for missing dict packs.
		missdicts="`find $Fdestdir -type f |grep dict-.*oxt |sed 's/.*dict-\(.*\).oxt/\1/'|grep -v en|sort -u`"
		if [ -n "$missdicts" ]; then
			Fmessage "Unsplitted dicts: $missdicts"
			return 1
		fi
	fi

	# Check for missing subpkgs.
	# It's OK not to split these
	rm build/{common,lang_en_US,nld}_list.txt
	misspkgs="`find build -maxdepth 1 -name '*_list.txt'`"
	if [ -n "$misspkgs" ]; then
		Fmessage "Unsplitted subpkgs: $misspkgs"
		return 1
	fi
	Fmonocleanup
}

# optimization OK
