# Compiling time: 84.17 SBU
# Maintainer: DeX77 <dex77@frugalware.org>
# Contributor: Krisztian VASAS <iron@frugalware.org>

pkgname=thunderbird
pkgver=102.5.1
pkgrel=1
pkgdesc="Mozilla Thunderbird mail and newsgroup client"
url="http://www.mozilla.org/products/thunderbird/"
depends=('libnotify' 'hunspell>=1.7' 'libpulse>=6.0' 'libevent>=2.1.11' 'dav1d>=1.0' \
	'pango' 'nspr' 'nss>=3.81' 'gtk+3' 'gtk+2' 'dbus-glib' 'libxt' 'libvpx' 'aom' \
	'icu4c>=72.1' 'libffi>=3.4' 'sqlite3>=3.31' 'botan>=2.19.2' 'libwebp' 'bzip2')
makedepends=('yasm' 'x11-protos' 'rust' 'cargo' 'cbindgen' 'clang' 'llvm' 'nodejs' 'nasm' 'python3-sqlite3')
groups=('xapps')
archs=("x86_64")
options=('nolto')
_F_archive_grepv="b7\|b8\|b6\|b5\|b4\|b3\|b2\|b1"
up2date="Flastverdir http://download-origin.cdn.mozilla.net/pub/thunderbird/releases/"
source=(http://download.cdn.mozilla.net/pub/mozilla.org/thunderbird/releases/$pkgver/source/$pkgname-$pkgver.source.tar.xz \
	rustc_version-0.4.0.patch \
	0004-bmo-847568-Support-system-harfbuzz.patch \
	0005-bmo-847568-Support-system-graphite2.patch \
	0006-bmo-1559213-Support-system-av1.patch \
	0007-bmo-878089-Don-t-fail-when-TERM-is-not-set.patch \
	0008-bmo-1516803-Fix-building-sandbox.patch \
	0019-bmo-1516803-force-one-LTO-partition-for-sandbox-when.patch \
	0026-bmo-1670333-OpenH264-Fix-decoding-if-it-starts-on-no.patch \
	0027-bmo-1663844-OpenH264-Allow-using-OpenH264-GMP-decode.patch \
	0029-bmo-1559213-fix-system-av1-libs.patch \
	0030-bmo-1196777-Set-GDK_FOCUS_CHANGE_MASK.patch \
	0031-bmo-1769631-python-3.11-compatibility.patch \
	0032-bmo-1769631-python-3.11-compatibility.patch \
	0033-bmo-1773259-cbindgen-root_clip_chain-fix.patch \
	0035-bmo-1754469-memory_mozalloc_throw.patch \
	$pkgname.desktop \
	vendor.js \
	mozconfig )

sha1sums=('3051d40409711bd90a012accf21c03d1ebf16b74' \
          '4759582d52729ba852d205ef92f095e955cdff2b' \
          '06040753c83ffcace0496e46fa1d00dc98bd0d0c' \
          '6cb5afea188a1ea07fd28e4760092531f024f906' \
          '91ea4cf50a641cac8cf6dc7719f502fad7794075' \
          '5ad4d61594dd936c374a249794b96d4f0bf9ecf1' \
          '51415061e9bfbb00986e0f97471e2d84933503b0' \
          'ba0edac4b60130bef5b7707fcc8dc13f35de8edc' \
          'dea2d98825df9203e64e0b73b9310a30b43fc028' \
          'e9c3523af267b9ead690fa8f1ad0b8417d791c76' \
          '7c11e84eaebd632b7eaba488015123cb033258a9' \
          'e018e17f4d018f8cc7f474b61c6da47f0acaaf05' \
          'f23a7151050b943d804b9a7a0f079795ab93f0c6' \
          'dcda0fd768d1dc4993b7c49e20a5365957a365e2' \
          '884afe77c3589f33adf591bdf087cf1d98649a88' \
          'ad4890aa67563349ef4a84f47c90f5c30e06db25' \
          '57084f04dde3c08e090bb116d132d02f80a99eb9' \
          '462a0eced8a4043fc2cd32e8ed744ec28874d5f0' \
          'e96a380e1b3cff55eb6b9730b0245f8ec7289373')

replaces=('lightning')
conflicts=('lightning')

build()
{
        export MOZILLA_OFFICIAL=1
        export BUILD_OFFICIAL=1
        export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=none
	export CC=gcc
	export CXX=g++

	Fcd

	ulimit -n 8192

	Fpatchall

	cp "$Fsrcdir/mozconfig" .mozconfig || Fdie

	Fexec ./mach configure || Fdie
	Fexec ./mach build || Fdie
	Fexec ./mach buildsymbols || Fdie
	DESTDIR="$Fdestdir" Fexec ./mach install || Fdie

	# Install icons for the menu file.
	for i in 16 22 24 32 48 256; do
		Finstallrel 644 comm/mail/branding/thunderbird/default${i}.png \
			usr/share/icons/hicolor/${i}x${i}/apps/$pkgname.png
	done

	# Remove dicts
	Frm usr/lib/thunderbird/dictionaries

	# Install menu file.
	Ffile /usr/share/applications/$pkgname.desktop

	# Install vendorjs
	Ffile usr/lib/$pkgname/defaults/preferences/vendor.js

	Fmkdir etc/ld.so.conf.d/
	echo /usr/lib/thunderbird >> "$Fdestdir/etc/ld.so.conf.d/thunderbird.conf" || Fdie

}

# optimization OK
