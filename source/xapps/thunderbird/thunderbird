#!/bin/sh
#
# Startup script for the fedora.us Thunderbird RPM
# (based on the Mozilla RPM launch script)
#

MOZILLA_FIVE_HOME=/usr/lib/thunderbird
MRE_HOME=/usr/lib/thunderbird
export MOZILLA_FIVE_HOME MRE_HOME

MOZ_PROGRAM=$MRE_HOME/thunderbird
#MOZ_CLIENT_PROGRAM="$MRE_HOME/mozilla-xremote-client -a thunderbird"
MOZ_CLIENT_PROGRAM="$MRE_HOME/thunderbird -remote" 

function check_running() {
    $MOZ_CLIENT_PROGRAM 'ping()' 2>/dev/null >/dev/null
    RETURN_VAL=$?
    if [ "$RETURN_VAL" -eq "2" ]; then
      echo 0
      return 0
    else
      echo 1
      return 1
    fi
}

function rm_shit() {
    find $HOME/.thunderbird -name XUL.mfasl 2>/dev/null | xargs rm -f
}

# currently unused
MOZARGS=""

ALREADY_RUNNING=`check_running`

# If no command-line arguments given...
if [ -z "$1" ]; then
    if [ "${ALREADY_RUNNING}" -eq "1" ]; then
        exec $MOZ_CLIENT_PROGRAM "xfeDoCommand(openInbox)" >/dev/null 2>&1
    else
        rm_shit
        exec $MOZ_PROGRAM $MOZARGS >/dev/null 2>&1
    fi
fi

for arg in $@ ; do
    case "$1" in
    -remote)
        shift
        exec $MOZ_PROGRAM -remote "$@"
        ;;

    -mail)
        shift
        if [ "${ALREADY_RUNNING}" -eq "1" ]; then
            # remove 'mailto:' prefix
            ARGS="`echo $@ | sed 's/^mailto://'`"
            exec $MOZ_CLIENT_PROGRAM "mailto($ARGS)"
        else
            rm_shit
            exec $MOZ_PROGRAM $MOZARGS -mail "$@"
        fi
        ;;

    -compose)
        shift
        if [ "${ALREADY_RUNNING}" -eq "1" ]; then
            # remove 'mailto:' prefix
            ARGS="`echo $@ | sed 's/^mailto://'`"
            exec $MOZ_CLIENT_PROGRAM "mailto($ARGS)"
        else
            rm_shit
            exec $MOZ_PROGRAM $MOZARGS -compose "$@"
        fi
        ;;

    *)
        # for now, pass it on and hope for the best
        exec $MOZ_PROGRAM $MOZARGS "$@"
        ;;
    esac
    shift
done
