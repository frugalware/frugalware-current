# Compiling Time: 0.03 SBU
# Maintainer: crazy <crazy@frugalware.org>

pkgname=vtk
pkgver=9.2.6
_majorver="${pkgver%.*}"
_tkver=8.6
pkgrel=8
pkgdesc="Software system for 3D computer graphics, modeling, image processing, volume rendering, scientific visualization, and information visualization."
url="http://www.vtk.org"
groups=('xlib-extra')
archs=('x86_64')
license=('GPL-2')
depends=('openvr' 'pdal>=2.5.0' 'liblas' 'adios2' 'openturns>=1.21' 'openslide' 'libboost' 'postgresql' 'openvdb>=10.0.1' 'openxr')
makedepends=('x11-protos' 'boost' 'ffmpeg')
_F_github_author="Kitware"
_F_github_tag_v=y
_F_github_grepv="rc[0-9]"
_F_cmake_rpath=OFF
Finclude openjava cmake github python
options+=('static')
source=("http://www.vtk.org/files/release/${_majorver}/VTK-${pkgver}.tar.gz" \
        "http://www.vtk.org/files/release/${_majorver}/VTKData-${pkgver}.tar.gz" \
        "http://www.vtk.org/files/release/${_majorver}/VTKLargeData-${pkgver}.tar.gz" \
	vtk-9.2.5-Add-include-cstdint-to-compile-with-gcc-13.patch \
	vtk-9.2.5-More-include-cstdint-to-compile-with-gcc13.patch \
	libproj-gcc13.patch \
	fmt-10.patch \
	adios2.patch \
	openturns-1.21.patch )
sha1sums=('a84eb06980204566bb6afc3eba3a515c189dde82' \
          'c22df40286a1da438b7a21e89bed9d88dc528fdb' \
          'd9bd34addaff0cec65b59f21b11dd2439d37490a' \
          'f3b9e65d1667a4838d8955f1f590ce6082b98eea' \
          '434e175f1e3220c2f92e4b83ce4b3c210e3a0fa0' \
          'f4b3a0ba6355165e7eff83cb9804d734c6d7e689' \
          '7ff10d98996186fe573b800d358eaa1af1fb17ef' \
          '7578fe8f32de692db175b0938524d71e6d428c18' \
          '66b9466d00e8d33f329d2decaedda91d084ad9d1')

_F_cd_path="VTK-$pkgver"

subpkgs=("$pkgname-java")
subdescs=("Java interface and bindings for $pkgname")
subdepends=("openjre")
subrodepends=("$pkgname>=$pkgver")
subgroups=('xlib-extra')
subarchs=('x86_64')

subpkgs+=("$pkgname-java-qt5")
subdescs+=("Java Qt5 interface and bindings for $pkgname")
subdepends+=("openjre-x")
subrodepends+=("$pkgname>=$pkgver $pkgname-qt5>=$pkgver $pkgname-java>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-java-mpi")
subdescs+=("Java Openmpi interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-java>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-java-ffmpeg")
subdescs+=("Java Ffmpeg interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-ffmpeg>=$pkgver $pkgname-java>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-java-mysql")
subdescs+=("Java MySql interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-java>=$pkgver $pkgname-mysql>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-mysql")
subdescs+=("MySql interface and bindings for $pkgname")
subdepends+=("mariadb-libs>=10.3.14")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-python3")
subdescs+=("Python interface and bindings for $pkgname")
subdepends+=("python3-six libxt")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-python3-qt5")
subdescs+=("Python2 Qt5 interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-python3>=$pkgver $pkgname-qt5>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-python3-tcl")
subdescs+=("Python2 Tcl/Tk interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-python3>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-python3-ffmpeg")
subdescs+=("Python2 Ffmpeg interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-python3>=$pkgver $pkgname-ffmpeg>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-python3-java")
subdescs+=("Java Python2 interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver $pkgname-java>=$pkgver $pkgname-python3>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-qt5")
subdescs+=("Qt5 interface and bindings for $pkgname")
subdepends+=("qt5-base>=5.15.10 qt5-x11extras>=5.15.10 qt5-quickcontrols>=5.15.10")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-static")
subdescs+=('Static libs for $pkgname')
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('lib-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-devel")
subdescs+=("Headers and cmake files for $pkgname")
subdepends+=("")
subrodepends+=("")
subgroups+=('devel-extra')
subarchs+=('x86_64')

subpkgs+=("$pkgname-ffmpeg")
subdescs+=("Openmpi interface and bindings for $pkgname")
subdepends+=("")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('x86_64')

build() {
	CMake_build \
		-DVTK_USE_LARGE_DATA:BOOL=ON \
		-DVTK_BUILD_ALL_MODULES:BOOL=ON \
		-DVTK_QT_VERSION:STRING=5 \
		-DVTK_INSTALL_TCL_DIR=/usr/lib/tcl${_tkver}/vtk/ \
		-DVTK_CUSTOM_LIBRARY_SUFFIX='' \
		-DVTK_PYTHON_VERSION=3 \
		-DVTK_USE_FFMPEG_ENCODER:BOOL=ON \
		-DVTK_WRAP_PYTHON:BOOL=ON \
		-DVTK_WRAP_TCL:BOOL=ON \
		-DVTK_WRAP_JAVA:BOOL=ON \
		-DVTK_JAVA_SOURCE_VERSION=20 \
		-DVTK_JAVA_TARGET_VERSION=20 \
		-DMPI4PY_INSTALL_PACKAGE_DIR=$_F_python3_libdir \
		-DVTK_INSTALL_QT_DIR=lib/qt5/plugins/designer \
		-DOpenGL_GL_PREFERENCE=GLVND \
		-DOpenVR_INCLUDE_DIR=/usr/include/openvr \
		-DVTK_ENABLE_OSPRAY=OFF

	Fmkdir usr/share/java


	### PLEASE NOTE: the splitting order matters.. -- crazy --

	#####  STATIC #####

	Fsplit $pkgname-static usr/lib/*.a

	##### JAVA #####

	## -java-qt5
	Fsplit $pkgname-java-qt5 usr/lib/java/vtk-Linux-x86_64/libvtkRenderingQtJava.so

	## -java-mysql
	Fsplit $pkgname-java-mysql usr/lib/java/vtk-Linux-x86_64/libvtkIOMySQLJava.so

	## -python3-java
	## we need split it here
	Fsplit $pkgname-python3-java usr/lib/java/vtk-Linux-x86_64/libvtkRenderingMatplotlibJava.so

	## -java-mpi
	Fsplit $pkgname-java-mpi usr/lib/java/vtk-Linux-x86_64/libvtk*Parallel*Java.*

	## -java-ffmpeg
	Fsplit $pkgname-java-ffmpeg usr/lib/java/vtk-Linux-x86_64/libvtkIOFFMPEGJava.so

	## -java
	Fsplit $pkgname-java usr/lib/libvtkJava.so*
	Fsplit $pkgname-java usr/lib/java
	Fsplit $pkgname-java usr/bin/vtkParseJava
	Fsplit $pkgname-java usr/bin/vtkWrapJava

	##### PYTHON ######

	## -python3-qt5
	Fsplit $pkgname-python3-qt5 $_F_python3_libdir/vtkmodules//vtkRenderingQt*
	Fsplit $pkgname-python3-qt5 $_F_python3_libdir/vtkmodules/qt

	## -python3-tcl/tk
	Fsplit $pkgname-python3-tcl $_F_python3_libdir/vtkmodules/tk

	## -python3-ffmpeg
	Fsplit $pkgname-python3-ffmpeg $_F_python3_libdir/vtkmodules/vtkIOFFMPEG.*

	## -python3
	Fsplit $pkgname-python3 $_F_python3_libdir
	Fsplit $pkgname-python3 usr/lib/*Python*
	Fsplit $pkgname-python3 usr/bin/*python*
	Fsplit $pkgname-python3 usr/bin/*Python*
	Fsplit $pkgname-python3 usr/lib/libvtkRenderingMatplotlib.so* ## hmmm ?

	##### Qt5 #####

	## -qt5
	Fsplit $pkgname-qt5 usr/lib/*Qt*

	##### FFMPEG #####

	## -ffmpeg
	Fsplit $pkgname-ffmpeg usr/lib/libvtkIOFFMPEG*

	##### MYSQL #####

	## need be split at the end so all other -xxx-mysql can be easy split
	## -mysql
	Fsplit $pkgname-mysql usr/lib/*IOMySQL*


	## clean up
	Frm usr/lib/python3.11 ## empty

	## -dev files , way to big 40MB
	Fsplit $pkgname-devel usr/include
	Fsplit $pkgname-devel usr/lib/cmake

}
# optimization OK
