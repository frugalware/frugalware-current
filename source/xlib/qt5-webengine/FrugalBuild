# Compiling Time: 64.56 SBU
# Maintainer: crazy <crazy@frugalware.org>

pkgname=qt5-webengine
pkgver=5.15.13
_basever=5.15.9
_catapult_commit=5eedfe23148a234211ba477f76fc2ea2e8529189
pkgrel=3
depends=("qt5-declarative>=$_basever" "qt5-webchannel>=$_basever" "qt5-location>=$_basever" 'libxcomposite>=0.4.4-3' \
	'libxrandr>=1.5.0-5' 'nss>=3.26' 'libxtst>=1.2.2-3' 'libxscrnsaver>=1.2.2-3' 'zlib>=1.2.12' 'libwebp>=0.5.1-2' \
	'libxml2>=2.9.4-3' 'libevent>=2.1.11' 'jsoncpp>=1.7.5' 'opus>=1.1.3-2' 'libvpx>=1.13.0' 'snappy>=1.1.6' \
	'icu4c>=73.1' 'libxml2' 'lcms2' 're2>=2022.12.01' 'ffmpeg>=6.0' 'libsrtp>=1.5.4-4' 'libjpeg-turbo' 'opus' 'alsa-lib' 'libxslt' 'protobuf')
makedepends=('git' 'ninja' 'x11-protos' 'poppler' 'poppler-qt5' 'poppler-glib' "qt5-tools>=5.15" 'bison' 'nodejs' 'python3')
_F_github_grep=5.15
_F_github_author=qt
_F_github_name=qtwebengine
_F_github_tag_v=y
_F_scm_tag="v${pkgver}-lts"
_F_scm_type=git
_F_scm_url=https://github.com/$_F_github_author/${_F_github_name}.git
_F_scm_git_cloneopts="--recurse-submodules"
Finclude scm qt5 github
source=(https://github.com/catapult-project/catapult/archive/${_catapult_commit}.zip \
	qt5-webengine-ffmpeg5.patch \
	qt5-webengine-python3.patch \
	chromium-python3.patch \
	gcc-12.patch )
sha1sums=('97345adbf5e3304cda7bf30cbc9d75e3e40edda1' \
          'e0f14a8477d8464ff12e35144ef39da17a19b7a4' \
          '67dad32bf78bd2dc6d34c8687f80ecabd7801971' \
          '8dbe5a11dfcad55c5132667b85fadb7f11716092' \
          '86d68dc4daec0d89bd17070fcc6801dd2376e445')

build()
{
	Funpack_scm
	Fexec git submodule set-branch --branch 87-based src/3rdparty || Fdie
	Fexec git submodule update || Fdie

	Fcd
	Fpatchall

	# Update catapult for python3 compatibility
	Fexec rm -r src/3rdparty/chromium/third_party/catapult || Fdie
	Fexec mv $Fsrcdir/catapult-$_catapult_commit src/3rdparty/chromium/third_party/catapult || Fdie

	Fexec qmake-qt5 \
			QMAKE_EXTRA_ARGS+=" -system-ffmpeg -webengine-icu -webengine-proprietary-codecs" \
			QMAKE_EXTRA_ARGS+=" -webengine-alsa -webengine-pulseaudio -webengine-printing-and-pdf -verbose" || Fdie
	Fexec make -j $(getconf _NPROCESSORS_ONLN) || Fdie
	Fexec make INSTALL_ROOT=$Fdestdir install || Fdie

	Ffix_la_files
	Frm usr/share/qt5/resources/icudtl.dat
	Fexec sed -e "s|$pkgver\ |$_basever |" -i "$Fdestdir"/usr/lib/cmake/*/*Config.cmake || Fdie
}

# optimization OK
