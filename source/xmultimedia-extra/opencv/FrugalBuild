# Compiling Time: 5.98 SBU
# Maintainer: crazy <crazy@frugalware.org>

pkgname=opencv
pkgver=4.10.0
pkgrel=5
pkgdesc="Intel(R) Open Source Computer Vision Library"
url="http://opencv.org/"
depends=('jasper' 'gst1-plugins-base' 'openexr>=3.3.0' 'ffmpeg>=7.0' 'hdf5' \
         'xine-lib>=1.2.8-3' 'libdc1394>=2.2.7' 'v4l-utils'  'zlib>=1.2.12' \
         'libglvnd' 'mesa-libglx' 'zlib>=1.2.12' 'libjpeg-turbo' 'libwebp>=0.6.0' 'libpng'
         'libtiff' 'jasper>=2.0.10' 'gdal' 'libgphoto2' 'eigen' 'libcl' 'tesseract-ocr' \
         'libsm' 'libxt' 'qt6-5compat' 'intel-tbb' 'protobuf>=3.2.0'  'vtk')
makedepends+=('doxygen' 'eigen' 'x11-protos' 'ocl-icd' 'python3-setuptools' \
	'apache-ant' 'openjdk' 'vtk-devel' 'vtk-ffmpeg' 'vtk-java' \
	'vtk-java-ffmpeg' 'vtk-java-mpi' 'vtk-java-mysql' 'vtk-java-qt5' \
	'vtk-mysql' 'vtk-python3' 'vtk-python3-ffmpeg' 'vtk-python3-java' 'gcc-13' \
	'vtk-python3-qt5' 'vtk-python3-tcl' 'vtk-qt5' 'boost' 'libdeflate-static')
_F_github_tag=y
_F_github_grepv="openvi"
_F_cmake_confopts+="	-DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_INSTALL_PREFIX=/usr \
			-DCMAKE_SKIP_RPATH=ON \
			-DWITH_OPENMP=ON \
			-DWITH_OPENCL=ON \
			-DWITH_OPENGL=ON \
			-DWITH_VULKAN=ON \
			-DBUILD_TESTS=OFF \
			-DCPU_BASELINE_DISABLE=SSE3 \
			-DCPU_BASELINE_REQUIRE=SSE2 \
			-DOPENCV_GENERATE_PKGCONFIG=ON \
			-DOpenGL_GL_PREFERENCE=GLVND \
			-DWITH_TBB=ON \
			-DWITH_QT=ON \
			-DOPENCV_EXTRA_MODULES_PATH=${Fsrcdir}/opencv_contrib-$pkgver/modules"

Finclude github cmake
options=('static' 'noccache' 'nolto')
groups=('xmultimedia-extra')
archs=('x86_64')
#TODO: stupid same filename
source+=(https://github.com/opencv/opencv_contrib/archive/$pkgver.zip)

sha1sums=('6bd566dc4297023914137677aa96fdebee89f5bd' \
          'f85b651de475f29981f275a992938be29a0ea8d3')

subpkgs=("$pkgname-cuda")
subdescs=("$pkgdesc CUDA")
subdepends=("cuda-tools ${depends}")
subrodepends=("$pkgname>=$pkgver")
subgroups=('xapps-extra')
subarchs=('x86_64')
subprovides=("$pkgname")
subconflicts=("$pkgname")

subpkgs+=("$pkgname-samples")
subdescs+=("$pkgdesc Examples")
subdepends+=('')
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xapps-extra')
subarchs+=('x86_64')
subprovides+=('')
subconflicts+=('')

subpkgs+=("$pkgname-python3")
subdescs+=("Opencv python3 bindings")
subdepends+=('python3>=3.12 openblas openblas64 libgfortran python3-numpy')
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xapps-extra')
subarchs+=('x86_64')
subprovides+=('')
subconflicts+=('')

build() {
	export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
	export CUDA_PATH=/opt/cuda
	export PATH="$PATH:/opt/cuda/bin:/opt/cuda/nsight_compute:/opt/cuda/nsight_systems/bin"

	Fcd
	_F_cmake_build_dir=frugalware_cuda
	CMake_build	-DBUILD_WITH_DEBUG_INFO=OFF \
			-DCUDA_NPP_LIBRARY_ROOT_DIR=/opt/cuda \
			-DWITH_CUDA=ON \
			-DWITH_CUDNN=ON \
			-DCMAKE_C_COMPILER=gcc-13 \
			-DCMAKE_CXX_COMPILER=g++-13 \
			-DCUDA_ARCH_BIN='52-real;53-real;60-real;61-real;62-real;70-real;72-real;75-real;80-real;86-real;87-real;89-real;90-real;90-virtual' \
			-DCUDA_ARCH_PTX='90-virtual'

	Frm usr/share/opencv4/samples
	Frm usr/lib/python3.*/
	Fsplit $pkgname-cuda \*

	_F_cmake_build_dir=frugalware_build
	_Fbuild_no_patch=yes
	Fexec cd $Fsrcdir
	CMake_build 	-DBUILD_EXAMPLES=ON \
			-DINSTALL_C_EXAMPLES=ON \
			-DINSTALL_PYTHON_EXAMPLES=ON

	Fln opencv4.pc /usr/lib/pkgconfig/opencv.pc
	## 32MB++
	Fsplit $pkgname-samples usr/share/opencv4/samples

	Fsplit $pkgname-python3 usr/lib/python3.*/

}
# optimization OK
