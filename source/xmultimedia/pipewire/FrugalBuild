# Compiling Time: 0.20 SBU
# Maintainer: crazy <crazy@frugalware.org>

pkgname=pipewire
pkgver=0.3.70
pkgrel=1
pkgdesc="A project that aims to greatly improve handling of audio and video under Linux"
depends=('sbc' 'jack2' 'vulkan-icd-loader' 'libcamera' \
	'webrtc-audio-processing' 'lilv' 'libfreeaptx' 'ldacbt' 'libcanberra' 'fdk-aac')
makedepends+=('systemd-devel' 'systemd' 'vulkan-headers' 'doxygen' 'xmlto' \
	'bluez' 'xmltoman' 'docutils' 'python3-lxml' 'python3-sphinx' 'git' )
groups=('xmultimedia')
archs=("x86_64")
_F_github_author="PipeWire"
_F_github_tag="y"
_F_cross32_meson_confopts_64="	-Ddocs=auto \
				-Dsession-managers=[] \
				-Dman=enabled"
_F_cross32_meson_confopts_32="	-Djack=disabled \
				-Dbluez5=disabled \
				-Decho-cancel-webrtc=disabled \
				-Dlv2=disabled \
				-Davahi=disabled \
				-Dopus=disabled \
				-Dlibcamera=disabled \
				-Dsession-managers=[] \
				-Dgstreamer=disabled"
_F_cross32_simple=yes
_F_cross32_subdepends=('lib32-libcap' 'lib32-libgcrypt' 'lib32-zstd' 'lib32-libsystemd' 'lib32-glib2' 'lib32-libpulse' 'lib32-libdrm')
_F_cross32_use_meson=yes
_F_cross32_delete=('usr/i686-frugalware-linux/bin' 'usr/i686-frugalware-linux/include' 'lib/' 'usr/share' 'usr/lib')
Finclude github cross32
url="https://pipewire.org/"
sha1sums=('bdf90657a58e9f1606992e4c57ec5bd12c2edd89')
install=("$pkgname.install")

subpkgs+=("$pkgname-alsa")
subdescs+=("Pipewire alsa config")
subarchs+=('x86_64')
subdepends+=('')
subgroups+=("xmultimedia-extra")
subrodepends+=('' 'wireplumber')
subconflicts+=('' 'alsa-plugin-pulseaudio')
subprovides+=('' 'alsa-plugin-pulseaudio')
suboptions+=('')
subinstall+=('' '')

subpkgs+=("$pkgname-pulse")
subdescs+=("Pipewire alsa config")
subarchs+=('x86_64')
subdepends+=('avahi libpulse')
subgroups+=("xmultimedia-extra")
subrodepends+=('wireplumber')
subconflicts+=('pulseaudio')
subprovides+=('pulseaudio')
suboptions+=('')
subinstall+=("$pkgname-pulse.install")

build() {
	Fbuild_cross32
	Fmkdir usr/share/pipewire/media-session.d/
	Fexec touch "$Fdestdir/usr/share/pipewire/media-session.d/with-alsa" || Fdie

	Fsplit "$pkgname-alsa" usr/share/alsa/alsa.conf.d/99-pipewire-default.conf
	Fsplit "$pkgname-alsa" usr/share/pipewire/media-session.d/with-alsa

	Fmkdir etc/pipewire/pipewire-pulse.conf.d
	Fexec touch "$Fdestdir/usr/share/pipewire/media-session.d/with-pulseaudio" || Fdie

	Fsplit "$pkgname-pulse" etc/pipewire/pipewire-pulse.conf.d/
	Fsplit "$pkgname-pulse" usr/bin/pipewire-pulse
	Fsplit "$pkgname-pulse" usr/lib/pipewire-0.3/libpipewire-module-protocol-pulse.so
	Fsplit "$pkgname-pulse" usr/lib/pipewire-0.3/libpipewire-module-pulse-tunnel.so
	Fsplit "$pkgname-pulse" usr/lib/systemd/user/pipewire-pulse.service
	Fsplit "$pkgname-pulse" usr/lib/systemd/user/pipewire-pulse.socket
	Fsplit "$pkgname-pulse" usr/share/man/man1/pipewire-pulse.1
	Fsplit "$pkgname-pulse" usr/share/pipewire/media-session.d/with-pulseaudio
	Fsplit "$pkgname-pulse" usr/share/pipewire/pipewire-pulse.conf

}

# optimization OK
