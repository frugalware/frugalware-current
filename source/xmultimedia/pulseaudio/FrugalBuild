# Compiling Time: 0.96 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

options+=('asneeded')

pkgname=pulseaudio
pkgver=7.0
pkgrel=1
pkgdesc="PulseAudio is a sound server with an advanced plugin system"
url="http://www.freedesktop.org/wiki/Software/PulseAudio/"
depends=('speex' 'liboil' 'audiofile' 'libsndfile' 'libtool' 'libatomic_ops>=7.4.0' 'flac' 'glib2' 'tdb'\
	'alsa-lib' 'libtool' 'libasyncns' 'libcap>=2.19-2' 'json-c>=0.12' 'orc' 'sbc' 'fftw' 'tcp_wrappers'\
	'speexdsp' 'bash-completion')
makedepends=('avahi' 'bluez>=5.0' 'jack>=0.118.0' 'intltool' 'gconf' \
		'libsm' 'libx11' 'libice' 'libxtst' 'xproto' 'kbproto' 'xcb-util>=0.3.8' 'gtk+3')
rodepends=('libpulse')
groups=('xmultimedia')
replaces=('pulseaudio-hal' 'padevchooser')
conflicts=('pulseaudio-hal')
provides=('puseaudio-hal')
archs=('i686' 'x86_64')
up2date="Flasttar $url"
source=(http://freedesktop.org/software/$pkgname/releases/$pkgname-$pkgver.tar.xz \
	README.Frugalware \
	default.pa)
sha1sums=('b4a3d331bdd94eb97a299f7328950dec31cf2b6a' \
          '2a29c451c32e7335831067d3cc0d7bb4f5e7460e' \
          '6e673306a0fdf60f6c59f8c09f3d8049769c0632')

subpkgs=("libpulse" "pulseaudio-esd" "pulseaudio-bluetooth" "pulseaudio-x11" \
	"pulseaudio-avahi" "pulseaudio-jack" "pulseaudio-gconf")
subdescs=('pulseaduio client library' 'PulseAudio ESD compatibility layer' 'PulseAudio bluetooth' 'x11 module for PulseAudio sound server' \
	'avahi module for PulseAudio sound server' 'jack module for PulseAudio sound server' \
	'gconf module for PulseAudio sound server')
subrodepends=("" "pulseaudio=$pkgver" \
	"pulseaudio=$pkgver bluez" "pulseaudio=$pkgver libx11 libxtst" "pulseaudio=$pkgver avahi" \
	"pulseaudio=$pkgver jack" "pulseaudio=$pkgver gconf")
subdepends=('systemd>=188 dbus xcb-util gdbm>=1.10 libasyncns libcap libxtst libsm libsndfile json-c' '' '' '' '' '' '')
subgroups=('xmultimedia' 'xmultimedia-extra' 'xmultimedia-extra' \
	'xmultimedia' 'xmultimedia-extra' 'xmultimedia-extra' 'gnome-extra')
subarchs=('i686 x86_64' 'i686 x86_64' 'i686 x86_64' 'i686 x86_64' 'i686 x86_64' 'i686 x86_64' 'i686 x86_64')
subbackup=('etc/pulse/client.conf' '' '' '' '' '' '')

makedepends=("${makedepends[@]}" 'lirc')
subpkgs=("${subpkgs[@]}" 'pulseaudio-lirc')
subdescs=("${subdescs[@]}" 'lirc module for PulseAudio sound server')
subrodepends=("${subrodepends[@]}" "$pkgname=$pkgver lirc")
subgroups=("${subgroups[@]}" 'multimedia-extra')
subarchs=("${subarchs[@]}" 'i686 x86_64')
subbackup=("${subbackup[@]}" "")
subdepends=("${subdepends[@]}" "")

Fconfopts+="	--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/libexec \
		--localstatedir=/var \
		--with-udev-rules-dir=/lib/udev/rules.d \
		--disable-bluez4 \
		--disable-solaris \
		--enable-largefile \
		--disable-static \
		--enable-x11 \
		--with-systemduserunitdir=/lib/systemd/system "

_F_systemd_units=(pulseaudio=)
Finclude systemd

install=$pkgname.install
backup=(etc/pulse/daemon.conf \
	etc/pulse/default.pa etc/pulse/system.pa)

build() {
        Fcd
        Fpatchall
	Fmake
	Fmakeinstall -j1

	Ffile var/lib/gdm/.pulse/default.pa
	Fchmod 754 var/lib/gdm
	Fdirschown var/lib/gdm gdm gdm

	Fln pulseaudio/libpulsecommon-7.0.la /usr/lib/libpulsecommon-7.0.la
	Fln pulseaudio/libpulsecommon-7.0.so /usr/lib/libpulsecommon-7.0.so

	Fsplit $pkgname-lirc usr/lib/pulse-$pkgver/modules/module-lirc.so

	Fsplit $pkgname-esd usr/bin/esdcompat
	Fsplit $pkgname-esd usr/lib/pulse-$pkgver/modules/libprotocol-esound.so
	Fsplit $pkgname-esd usr/lib/pulse-$pkgver/modules/module-esound-compat-spawnfd.so
	Fsplit $pkgname-esd usr/lib/pulse-$pkgver/modules/module-esound-compat-spawnpid.so
	Fsplit $pkgname-esd usr/lib/pulse-$pkgver/modules/module-esound-protocol-tcp.so
	Fsplit $pkgname-esd usr/lib/pulse-$pkgver/modules/module-esound-protocol-unix.so
	Fsplit $pkgname-esd usr/lib/pulse-$pkgver/modules/module-esound-sink.so

	Fsplit $pkgname-bluetooth usr/lib/pulse-$pkgver/modules/module-bluetooth-discover.so*
	Fsplit $pkgname-bluetooth usr/lib/pulse-$pkgver/modules/module-bluetooth-policy.so*	
	Fsplit $pkgname-bluetooth usr/lib/pulse-$pkgver/modules/module-bluez5-discover.so
	Fsplit $pkgname-bluetooth usr/lib/pulse-$pkgver/modules/module-bluez5-device.so
	Fsplit $pkgname-bluetooth usr/lib/pulse-$pkgver/modules/libbluez5-util.so

	Fsplit $pkgname-x11 usr/lib/pulse-$pkgver/modules/module-x11-xsmp.so
	Fsplit $pkgname-x11 usr/lib/pulse-$pkgver/modules/module-x11-publish.so
	Fsplit $pkgname-x11 usr/lib/pulse-$pkgver/modules/module-x11-cork-request.so
	Fsplit $pkgname-x11 usr/lib/pulse-$pkgver/modules/module-x11-bell.so
	Fsplit $pkgname-x11 usr/bin/pax11publish
	Fsplit $pkgname-x11 usr/bin/start-pulseaudio-x11
	Fsplit $pkgname-x11 etc/xdg

	Fsplit $pkgname-avahi usr/lib/pulse-$pkgver/modules/libavahi-wrap.so
	Fsplit $pkgname-avahi usr/lib/pulse-$pkgver/modules/module-zeroconf-discover.so
	Fsplit $pkgname-avahi usr/lib/pulse-$pkgver/modules/module-zeroconf-publish.so
	Fsplit $pkgname-avahi usr/lib/pulse-$pkgver/modules/libraop.so
	Fsplit $pkgname-avahi usr/lib/pulse-$pkgver/modules/module-raop-discover.so
	Fsplit $pkgname-avahi usr/lib/pulse-$pkgver/modules/module-raop-sink.so

	Fsplit $pkgname-jack usr/lib/pulse-$pkgver/modules/module-jack-sink.so
	Fsplit $pkgname-jack usr/lib/pulse-$pkgver/modules/module-jack-source.so
	Fsplit $pkgname-jack usr/lib/pulse-$pkgver/modules/module-jackdbus-detect.so

	Fsplit $pkgname-gconf usr/lib/pulse-$pkgver/modules/module-gconf.so
	Fsplit $pkgname-gconf usr/libexec/pulse/gconf-helper

	Fsplit libpulse usr/{lib,share/man/man5}
	Fsplit libpulse etc/pulse/client.conf
	Fsplit libpulse usr/include/pulse
}

# optimization OK
