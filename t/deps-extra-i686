#!/usr/bin/env python

import alpm, os, tempfile, shutil, sys

if len(sys.argv) > 1 and sys.argv[1] == "--help":
	print "installed-by-default packages which depend on extra packages"
	sys.exit(0)

root = tempfile.mkdtemp()
alpm.initialize(root)
if os.getcwd().split('/')[-2] == "frugalware-current":
	treename = "frugalware-current"
else:
	treename = "frugalware"
db = alpm.db_register(treename)
alpm.db_setserver(db, "file://" + os.getcwd() + "/../frugalware-i686")
alpm.db_update(1, db)

i = alpm.db_getpkgcache(db)
while i:
	pkg = alpm.void_to_PM_PKG(alpm.list_getdata(i))
	pkgname = alpm.void_to_char(alpm.pkg_getinfo(pkg, alpm.PKG_NAME))
	group = alpm.void_to_char(alpm.list_getdata(alpm.void_to_PM_LIST(alpm.pkg_getinfo(pkg, alpm.PKG_GROUPS))))
	if group[-6:] == "-extra":
		i = alpm.list_next(i)
		continue
	j = alpm.void_to_PM_LIST(alpm.pkg_getinfo(pkg, alpm.PKG_DEPENDS))
	while j:
		found = False
		dep = alpm.void_to_char(alpm.list_getdata(j)).split(">")[0].split(">")[0].split("=")[0]
		k = alpm.db_getpkgcache(db)
		while not found and k:
			p = alpm.void_to_PM_PKG(alpm.list_getdata(k))
			pname = alpm.void_to_char(alpm.pkg_getinfo(p, alpm.PKG_NAME))
			if pname == dep:
				buggy = False
				l = alpm.void_to_PM_LIST(alpm.pkg_getinfo(p, alpm.PKG_GROUPS))
				while not found and l:
					g = alpm.void_to_char(alpm.list_getdata(l))
					if  g[-6:] == "-extra":
						buggy = True
					l = alpm.list_next(l)
				if not buggy and not (len(sys.argv) > 1 and pname == sys.argv[1]):
					found = True
			else:
				l = alpm.void_to_PM_LIST(alpm.pkg_getinfo(p, alpm.PKG_PROVIDES))
				while not found and l:
					pr = alpm.void_to_PM_PKG(alpm.list_getdata(l))
					if alpm.void_to_char(alpm.pkg_getinfo(pr, alpm.PKG_NAME)) == dep:
						found = True
					l = alpm.list_next(l)
			k = alpm.list_next(k)
		if not found:
			try:
				socket = open("../source/%s/%s/FrugalBuild" % (group, pkgname))
				while True:
					line = socket.readline()
					if not line:
						break
					if line[:14] != "# Maintainer: ":
						continue
					# FIXME: we here hardcore the encoding of the FBs
					maintainer = line[14:].strip().decode('latin1')
					break
				socket.close()
			except IOError:
				maintainer = "Unknown"
			print "%s should be moved to extra (%s is in extra; %s)" % (pkgname, alpm.void_to_char(alpm.list_getdata(j)), maintainer)
		j = alpm.list_next(j)
	i = alpm.list_next(i)
alpm.release()
shutil.rmtree(root)
