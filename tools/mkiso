#!/bin/bash

version=`date +%Y%m%d`
base=('base' 'apps' 'lib' 'multimedia' 'network' 'devel')
x11=('x11' 'xlib' 'xapps' 'xfce4' 'gnome' 'kde')
cd3=('gnome-extra' 'kde-extra' 'locale-extra')
cd4=('apps-extra' 'devel-extra' 'games-extra' 'lib-extra' 'network-extra' 'rox-extra' 'x11-extra' 'xapps-extra' 'xfce4-extra' 'xlib-extra')
archs=('i686' 'x86_64')
tree=-current # -current or nothing for -stable
isotree=-current # -current or the version number like -0.3
[ -z "$arch" ] && arch=`arch`
dbpath=`mktemp -d`
target=../frugalware$isotree-iso/
cd `dirname $0`/..

if [ -e _darcs/lock ]; then
	echo "the repo is locked!"
	rmdir $dbpath
	exit 0
else
	touch _darcs/lock
fi

echo -n "preparing pkgdb... "
mkdir $dbpath/local $dbpath/frugalware$tree $dbpath/extra$tree
tar xzf frugalware-$arch/frugalware$tree.fdb -C $dbpath/frugalware$tree
tar xzf extra/frugalware-$arch/extra$tree.fdb -C $dbpath/extra$tree
echo "done."

# TODO: the host pacman.conf needs editing currently, to solve this we should generate an own pacman.conf
echo -n "generating exclusion list for cds... "
baselst=`for i in $(pacman -b $dbpath -Sg ${base[@]} |grep -v '^\w'); do ls frugalware-$arch/$i*|grep "/$i-[^-]*-[^-]*-$arch.fpm$"|sed 's|\(.*\)| -x ./\1|'; done`
x11lst=`for i in $(pacman -b $dbpath -Sg ${x11[@]} |grep -v '^\w'); do ls frugalware-$arch/$i*|grep "/$i-[^-]*-[^-]*-$arch.fpm$"|sed 's|\(.*\)| -x ./\1|'; done`
cd3lst=`for i in $(pacman -b $dbpath -Sg ${cd3[@]} |grep -v '^\w'); do ls extra/frugalware-$arch/$i*|grep "/$i-[^-]*-[^-]*-$arch.fpm$"|sed 's|\(.*\)| -x ./\1|'; done`
cd4lst=`for i in $(pacman -b $dbpath -Sg ${cd4[@]} |grep -v '^\w'); do ls extra/frugalware-$arch/$i*|grep "/$i-[^-]*-[^-]*-$arch.fpm$"|sed 's|\(.*\)| -x ./\1|'; done`
echo "done."

# exlustion other arch's pkgs
for i in ${archs[@]}
do
	[ "$i" != "$arch" ] && binex="$binex -x ./frugalware-$i -x ./extra/frugalware-$i -x ./boot/initrd-$i.img.gz -x ./boot/vmlinuz-*-$i"
done

# use this to exlude the given arch's packages, so keep only kernel & initrd
for i in ${archs[@]}
do
	if [ "$i" != "$arch" ]; then
		binexall="$binexall -x ./frugalware-$i -x ./extra/frugalware-$i -x ./boot/initrd-$i.img.gz -x ./boot/vmlinuz-*-$i"
	else
		binexall="$binexall -x ./frugalware-$i -x ./extra/frugalware-$i"
	fi
done

sed -i "s/i686/$arch/g" boot/grub/menu.lst

for i in $*
do
case $i in
net)
# CD0: netinstall
mkisofs -o frugalware-$version-$arch-net.iso \
	-R -J -V "Frugalware Install" \
	-A "Frugalware Install Network Install" \
	-x ./_darcs \
	-x ./source \
	$binexall \
	-x ./extra \
	-hide-rr-moved \
	-b boot/grub/stage2_eltorito \
	-v -d -N -no-emul-boot -boot-load-size 4 -boot-info-table . || exit 1
mv frugalware-$version-$arch-net.iso $target
;;

cd1)
# CD1: base system
mkisofs -o frugalware-$version-$arch-cd1.iso \
	-R -J -V "Frugalware Install" \
	-A "Frugalware Install CD 1" \
	-x ./_darcs \
	-x ./source \
	$binex \
	-x ./extra \
	$x11lst \
	-hide-rr-moved \
	-b boot/grub/stage2_eltorito \
	-v -d -N -no-emul-boot -boot-load-size 4 -boot-info-table . || exit 1
mv frugalware-$version-$arch-cd1.iso $target
;;

cd2)
# CD2: x11 system
mkisofs -o frugalware-$version-$arch-cd2.iso \
	-R -J -V "Frugalware Install" \
	-A "Frugalware Install CD 2" \
	-x ./_darcs \
	-x ./boot/initrd-$arch.img.gz \
	-x ./source \
	$binex \
	-x ./extra \
	$baselst \
	-hide-rr-moved \
	-b boot/grub/stage2_eltorito \
	-v -d -N -no-emul-boot -boot-load-size 4 -boot-info-table . || exit 1
mv frugalware-$version-$arch-cd2.iso $target
;;

cd3)
# CD3: extra repo - 1
mkisofs -o frugalware-$version-$arch-cd3.iso \
	-R -J -V "Frugalware Install" \
	-A "Frugalware Install CD 3" \
	-x ./_darcs \
	-x ./boot/initrd-$arch.img.gz \
	-x ./frugalware-$arch \
	-x ./source \
	-x ./extra/source \
	$binex \
	$cd4lst \
	-hide-rr-moved \
	-b boot/grub/stage2_eltorito \
	-v -d -N -no-emul-boot -boot-load-size 4 -boot-info-table . || exit 1
mv frugalware-$version-$arch-cd3.iso $target
;;

cd4)
# CD4: extra repo - 2
mkisofs -o frugalware-$version-$arch-cd4.iso \
	-R -J -V "Frugalware Install" \
	-A "Frugalware Install CD 4" \
	-x ./_darcs \
	-x ./boot/initrd-$arch.img.gz \
	-x ./frugalware-$arch \
	-x ./source \
	-x ./extra/source \
	$binex \
	$cd3lst \
	-hide-rr-moved \
	-b boot/grub/stage2_eltorito \
	-v -d -N -no-emul-boot -boot-load-size 4 -boot-info-table . || exit 1
mv frugalware-$version-$arch-cd4.iso $target
;;

dvd)
# DVD: full tree
mkisofs -o frugalware-$version-$arch-dvd.iso \
	-R -J -V "Frugalware Install" \
	-A "Frugalware Install DVD" \
	-x ./_darcs \
	-x ./source \
	-x ./extra/source \
	$binex \
	-hide-rr-moved \
	-b boot/grub/stage2_eltorito \
	-v -d -N -no-emul-boot -boot-load-size 4 -boot-info-table . || exit 1
mv frugalware-$version-$arch-dvd.iso $target
;;
esac
done

sed -i "s/$arch/i686/g" boot/grub/menu.lst
rm -rf $dbpath
rm _darcs/lock
